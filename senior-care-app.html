<!DOCTYPE html>
<!--
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    SENIOR CARE COMPANION - STANDALONE VERSION FOR IPHONE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    VERSION: 2026-01-25-0052 UTC - ROLLBACK to Simple Voice Navigation
    BUILD DATE: January 25, 2026 at 12:52 AM UTC
    CHANGES: Restored simple working voice navigation (removed complex features)
    
    ‚úÖ THIS IS A SINGLE-FILE VERSION!
    ‚úÖ No other files needed (no manifest.json, no service-worker.js)
    ‚úÖ Perfect for iPhone installation from Files app
    
    HOW TO INSTALL ON IPHONE:
    1. Save this file to your iPhone (Downloads folder is fine)
    2. Open it with Safari (tap the file, it should open in Safari)
    3. Tap the Share button (‚¨ÜÔ∏è) at the bottom of Safari
    4. Tap "Add to Home Screen"
    5. Tap "Add"
    6. Done! The app icon appears on your home screen!
    
    IMPORTANT: Must use Safari browser (not Chrome)
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Senior Care">
    <title>Senior Care Companion</title>
    
    <!-- STANDALONE VERSION - No external files needed! -->
    <!-- This single file can be installed directly to your iPhone home screen -->
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23667eea'/><text x='50' y='65' font-size='60' text-anchor='middle' fill='white'>üè•</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-height: calc(100vh - 20px);
        }

        /* Login Screen */
        .login-screen, .register-screen {
            text-align: center;
            padding: 20px 0;
        }

        .login-screen h1, .register-screen h1 {
            font-size: 28px;
            color: #667eea;
            margin-bottom: 30px;
        }

        .logo-emoji {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 16px 30px;
            font-size: 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            width: calc(100% - 16px);
            max-width: 400px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        /* Header */
        .app-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .app-header h1 {
            font-size: 24px;
            color: #667eea;
        }

        .user-info {
            font-size: 16px;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Navigation */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 14px 10px;
            font-size: 15px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .nav-tab:active {
            transform: scale(0.98);
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            font-weight: 700;
        }

        /* Cards */
        .card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .card.medication {
            border-left: 6px solid #f56565;
        }

        .card.appointment {
            border-left: 6px solid #4299e1;
        }

        .card.task {
            border-left: 6px solid #48bb78;
        }

        .card.reminder {
            border-left: 6px solid #ecc94b;
            background: #fffbeb;
        }

        .card.bill {
            border-left: 6px solid #ed8936;
        }

        .card-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .card-content {
            font-size: 17px;
            color: #555;
            line-height: 1.6;
        }

        .card-time {
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
        }

        /* Buttons */
        .action-btn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 4px 0 0;
            font-weight: 600;
            touch-action: manipulation;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .btn-warning {
            background: #ecc94b;
            color: #333;
        }

        .btn-delete {
            background: #f56565;
            color: white;
        }

        /* Emergency Button */
        .emergency-btn {
            width: 100%;
            padding: 24px;
            font-size: 26px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
            touch-action: manipulation;
        }

        .emergency-btn:active {
            animation: none;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
        }

        /* Contact Cards */
        .contact-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f7fafc;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .contact-relation {
            font-size: 16px;
            color: #666;
        }

        .contact-phone {
            font-size: 18px;
            color: #4299e1;
            margin-top: 5px;
        }

        .contact-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .call-btn {
            flex: 1;
            min-width: 120px;
            padding: 14px 20px;
            font-size: 18px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            touch-action: manipulation;
        }

        .call-btn:active {
            transform: scale(0.98);
        }

        /* Checkbox */
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .checkbox-item:active {
            background: #e2e8f0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 28px;
            height: 28px;
            margin-right: 15px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 17px;
            cursor: pointer;
            flex: 1;
        }

        .checkbox-item.completed {
            background: #c6f6d5;
            opacity: 0.7;
        }

        /* Forms */
        .form-section {
            background: #f7fafc;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .form-section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            font-weight: 700;
        }

        /* Home Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 16px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            touch-action: manipulation;
        }

        .dashboard-card:active {
            transform: scale(0.98);
        }

        .dashboard-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .dashboard-card p {
            font-size: 15px;
        }

        .emoji {
            font-size: 40px;
            margin-bottom: 8px;
        }

        /* Install Banner */
        .install-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            text-align: center;
        }

        .install-banner h3 {
            font-size: 20px;
            margin: 0;
        }

        .install-banner p {
            font-size: 15px;
            margin: 0;
            opacity: 0.9;
        }

        .install-btn {
            background: white;
            color: #667eea;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
        }

        .install-btn:active {
            transform: scale(0.98);
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Emergency Confirmation Modal */
        .emergency-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .emergency-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .emergency-modal-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }

        .emergency-modal h2 {
            font-size: 28px;
            color: #f56565;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .emergency-modal p {
            font-size: 20px;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .emergency-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .emergency-confirm-btn {
            padding: 18px 30px;
            font-size: 22px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        .emergency-cancel-btn {
            padding: 16px 30px;
            font-size: 18px;
            background: #e2e8f0;
            color: #333;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Day checkboxes */
        .day-checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .day-checkbox-label {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: normal;
        }

        .day-checkbox-label input {
            margin-right: 5px;
        }

        /* Tablet and Desktop */
        @media (min-width: 768px) {
            .container {
                padding: 30px;
            }

            .nav-tabs {
                grid-template-columns: repeat(4, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .contact-card {
                flex-direction: row;
                align-items: center;
            }

            .contact-buttons {
                flex-direction: row;
            }

            .app-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .btn {
                width: auto;
            }
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Small phones */
        @media (max-width: 360px) {
            .section-title {
                font-size: 20px;
            }

            .card-header {
                font-size: 18px;
            }

            .emergency-btn {
                font-size: 22px;
                padding: 20px;
            }
        }

        /* Loading animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Reminder Styles */
        .reminder-card {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-left: 5px solid #e17055;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .reminder-card h3 {
            color: #d63031;
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reminder-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-item-text {
            flex: 1;
        }

        .reminder-item-time {
            font-weight: bold;
            color: #d63031;
            margin-right: 10px;
        }

        .reminder-snooze-btn {
            background: #74b9ff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .reminder-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        .reminder-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin: 0;
        }

        .reminder-time-select {
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #dfe6e9;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Password Visibility Toggle */
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 20px;
            user-select: none;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        .password-toggle.visible {
            opacity: 0.8;
        }

        /* Alert Modal for Reminders */
        .reminder-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .reminder-alert-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .reminder-alert-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }

        .reminder-alert h2 {
            color: #d63031;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .reminder-alert p {
            color: #2d3436;
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .reminder-alert-buttons {
            display: flex;
            gap: 10px;
        }

        .reminder-alert-buttons button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .reminder-ok-btn {
            background: #00b894;
            color: white;
        }

        .reminder-snooze-alert-btn {
            background: #74b9ff;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Custom Autocomplete Dropdown */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }
        
        .autocomplete-wrapper input {
            width: 100%;
            padding: 12px 15px;
            font-size: 18px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            color: #2d3748;
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .autocomplete-wrapper input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .autocomplete-wrapper input::placeholder {
            color: #a0aec0;
            font-size: 16px;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #4CAF50;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-dropdown.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover {
            background: #f0f9ff;
        }
        
        .autocomplete-item.selected {
            background: #e3f2fd;
        }
        
        .autocomplete-no-results {
            padding: 12px 15px;
            color: #999;
            font-size: 14px;
            text-align: center;
        }
        
        .autocomplete-highlight {
            background: #fff59d;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Emergency Confirmation Modal -->
        <div id="emergencyModal" class="emergency-modal hidden">
            <div class="emergency-modal-content">
                <div class="emergency-modal-icon">üö®</div>
                <h2>EMERGENCY CALL</h2>
                <p>Are you sure you want to call 911 Emergency Services?</p>
                <div class="emergency-modal-buttons">
                    <button class="emergency-confirm-btn" onclick="confirmEmergencyCall()">
                        YES - CALL 911 NOW
                    </button>
                    <button class="emergency-cancel-btn" onclick="cancelEmergencyCall()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Task Confirmation Modal -->
        <div id="deleteTaskModal" class="emergency-modal hidden">
            <div class="emergency-modal-content">
                <div class="emergency-modal-icon" style="font-size: 60px;">üóëÔ∏è</div>
                <h2 style="color: #ed8936;">Delete Task</h2>
                <p id="deleteTaskText">Are you sure you want to delete this task?</p>
                <div class="emergency-modal-buttons">
                    <button class="emergency-confirm-btn" onclick="confirmDeleteTask()" style="background: #ed8936;">
                        Yes, Delete It
                    </button>
                    <button class="emergency-cancel-btn" onclick="cancelDeleteTask()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Reminder Alert Modal -->
        <div id="reminderAlert" class="reminder-alert hidden">
            <div class="reminder-alert-content">
                <div class="reminder-alert-icon">üîî</div>
                <h2 id="reminderAlertTitle">Reminder!</h2>
                <p id="reminderAlertText"></p>
                <div class="reminder-alert-buttons">
                    <button class="reminder-ok-btn" onclick="dismissReminder()">
                        OK, Got It!
                    </button>
                    <button class="reminder-snooze-alert-btn" onclick="snoozeReminder()">
                        Snooze 10 Min
                    </button>
                </div>
            </div>
        </div>

        <!-- Install Banner -->
        <div id="installBanner" class="install-banner hidden">
            <div class="logo-emoji">üì±</div>
            <h3>Install Senior Care App</h3>
            <p>Add to your home screen for quick access!</p>
            <button class="install-btn" id="installButton">Install App</button>
            <button class="install-btn" onclick="hideInstallBanner()" style="background: transparent; color: white; border: 2px solid white;">Maybe Later</button>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="logo-emoji">üè•</div>
            <h1>Senior Care Companion</h1>
            <div class="input-group">
                <label for="loginUsername">Username</label>
                <input type="text" id="loginUsername" placeholder="Enter your username" autocomplete="username">
            </div>
            <div class="input-group">
                <label for="loginPassword">Password</label>
                <div style="position: relative;">
                    <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" style="padding-right: 45px;">
                    <span class="password-toggle" onclick="togglePasswordVisibility('loginPassword', this)">
                        üëÅÔ∏è
                    </span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="login()">Login</button>
            <button class="btn btn-secondary" onclick="showRegister()">New User? Register</button>
            <button class="btn" onclick="showForgotPassword()" style="background: transparent; color: #4CAF50; border: none; text-decoration: underline; margin-top: 10px; font-size: 14px;">Forgot Password?</button>
        </div>

        <!-- Forgot Password Screen -->
        <div id="forgotPasswordScreen" class="register-screen hidden">
            <div class="logo-emoji">üîë</div>
            <h1>Reset Password</h1>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Enter your username and email to reset your password</p>
            <div class="input-group">
                <label for="forgotUsername">Username</label>
                <input type="text" id="forgotUsername" placeholder="Enter your username">
            </div>
            <div class="input-group">
                <label for="forgotEmail">Email Address</label>
                <input type="email" id="forgotEmail" placeholder="Enter your email">
            </div>
            <button class="btn btn-primary" onclick="verifyForgotPassword()">Verify & Reset</button>
            <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
        </div>

        <!-- Reset Password Screen (after verification) -->
        <div id="resetPasswordScreen" class="register-screen hidden">
            <div class="logo-emoji">üîê</div>
            <h1>Set New Password</h1>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Create a new password for your account</p>
            <div class="input-group">
                <label for="resetNewPassword">New Password</label>
                <div style="position: relative;">
                    <input type="password" id="resetNewPassword" placeholder="Enter new password" style="padding-right: 45px;">
                    <span class="password-toggle" onclick="togglePasswordVisibility('resetNewPassword', this)">
                        üëÅÔ∏è
                    </span>
                </div>
            </div>
            <div class="input-group">
                <label for="resetConfirmPassword">Confirm New Password</label>
                <div style="position: relative;">
                    <input type="password" id="resetConfirmPassword" placeholder="Re-enter new password" style="padding-right: 45px;">
                    <span class="password-toggle" onclick="togglePasswordVisibility('resetConfirmPassword', this)">
                        üëÅÔ∏è
                    </span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="completePasswordReset()">Set New Password</button>
            <button class="btn btn-secondary" onclick="showLogin()">Cancel</button>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="register-screen hidden">
            <div class="logo-emoji">üë§</div>
            <h1>Create New Account</h1>
            <div class="input-group">
                <label for="regName">Full Name</label>
                <input type="text" id="regName" placeholder="Enter your full name" autocomplete="name">
            </div>
            <div class="input-group">
                <label for="regUsername">Username</label>
                <input type="text" id="regUsername" placeholder="Choose a username" autocomplete="username">
            </div>
            <div class="input-group">
                <label for="regPassword">Password</label>
                <div style="position: relative;">
                    <input type="password" id="regPassword" placeholder="Choose a password" autocomplete="new-password" style="padding-right: 45px;">
                    <span class="password-toggle" onclick="togglePasswordVisibility('regPassword', this)">
                        üëÅÔ∏è
                    </span>
                </div>
            </div>
            <div class="input-group">
                <label for="regAge">Age</label>
                <input type="number" id="regAge" placeholder="Enter your age">
            </div>
            <div class="input-group">
                <label for="regEmail">Email Address</label>
                <input type="email" id="regEmail" placeholder="your.email@example.com">
                <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0 0;">üìß Used to send backup files to your inbox</p>
            </div>
            <button class="btn btn-primary" onclick="register()">Create Account</button>
            <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <div class="app-header">
                <h1>üè• Senior Care</h1>
                <div class="user-info">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <span id="userName">Welcome!</span>
                        <button class="btn btn-secondary" onclick="showSection('profile')" style="padding: 8px 16px; font-size: 14px; margin: 0;">üë§ Profile</button>
                    </div>
                    <button class="btn btn-danger" onclick="logout()" style="padding: 10px 20px; font-size: 14px; margin: 0;">Logout</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('home')">üè† Home</button>
                <button class="nav-tab" onclick="showSection('medications')">üíä Meds</button>
                <button class="nav-tab" onclick="showSection('appointments')">üìÖ Appts</button>
                <button class="nav-tab" onclick="showSection('tasks')">‚úÖ Tasks</button>
                <button class="nav-tab" onclick="showSection('bills')">üí∞ Bills</button>
                <button class="nav-tab" onclick="showSection('activities')">üéâ Activities</button>
                <button class="nav-tab" onclick="showSection('contacts')">üìû Contacts</button>
                <button class="nav-tab" onclick="showSection('help')">‚ùì Help</button>
            </div>

            <!-- Home Section -->
            <div id="home" class="section active">
                <h2 class="section-title">Today's Overview</h2>
                
                <div id="homeReminders"></div>

                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="showSection('medications')">
                        <div class="emoji">üíä</div>
                        <h3>Medications</h3>
                        <p id="medCount" style="line-height: 1.6;">0 for today</p>
                    </div>
                    <div class="dashboard-card" onclick="showSection('appointments')">
                        <div class="emoji">üìÖ</div>
                        <h3>Appointments</h3>
                        <p id="apptCount" style="line-height: 1.6;">0 upcoming</p>
                    </div>
                    <div class="dashboard-card" onclick="showSection('tasks')">
                        <div class="emoji">‚úÖ</div>
                        <h3>Daily Tasks</h3>
                        <p id="taskCount" style="line-height: 1.6;">0 tasks</p>
                    </div>
                    <div class="dashboard-card" onclick="showSection('bills')">
                        <div class="emoji">üí∞</div>
                        <h3>Bills</h3>
                        <p id="billCount" style="line-height: 1.6;">0 bills due</p>
                    </div>
                    <div class="dashboard-card" onclick="showSection('activities')">
                        <div class="emoji">üéâ</div>
                        <h3>Activities</h3>
                        <p id="activityCount" style="line-height: 1.6;">0 upcoming</p>
                    </div>
                </div>

                <button class="emergency-btn" onclick="callEmergency()">
                    üö® CALL 911 EMERGENCY
                </button>
            </div>

            <!-- Medications Section -->
            <div id="medications" class="section">
                <h2 class="section-title">üíä Medications</h2>
                <div id="medicationList"></div>
                
                <div class="form-section">
                    <h3>Add New Medication</h3>
                    <div class="input-group">
                        <label>Medication Name</label>
                        <input type="text" id="medName" placeholder="e.g., Aspirin">
                    </div>
                    <div class="input-group">
                        <label>Dosage</label>
                        <input type="text" id="medDosage" placeholder="e.g., 100mg">
                    </div>
                    <div class="input-group">
                        <label>Time</label>
                        <input type="time" id="medTime">
                    </div>
                    <div class="input-group">
                        <label>How Often?</label>
                        <select id="medRecurrence" onchange="updateRecurrenceOptions()">
                            <option value="daily">Daily (Every day)</option>
                            <option value="specific-days">Specific Days of Week</option>
                            <option value="every-x-days">Every X Days</option>
                            <option value="weekly">Weekly (Once a week)</option>
                        </select>
                    </div>
                    <div id="specificDaysContainer" class="input-group hidden">
                        <label>Select Days:</label>
                        <div class="day-checkbox-container">
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="0"> Sunday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="1"> Monday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="2"> Tuesday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="3"> Wednesday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="4"> Thursday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="5"> Friday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="6"> Saturday
                            </label>
                        </div>
                    </div>
                    <div id="everyXDaysContainer" class="input-group hidden">
                        <label>Every how many days?</label>
                        <input type="number" id="medEveryXDays" min="2" max="30" value="2" placeholder="e.g., 2">
                    </div>
                    <div id="weeklyDayContainer" class="input-group hidden">
                        <label>Which day of the week?</label>
                        <select id="medWeeklyDay">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="reminder-checkbox">
                            <input type="checkbox" id="medReminderEnabled" onchange="toggleMedReminderOptions()">
                            üîî Enable Reminder
                        </label>
                    </div>
                    <div id="medReminderOptions" class="input-group hidden">
                        <label>Remind me (minutes before):</label>
                        <select id="medReminderMinutes" class="reminder-time-select">
                            <option value="5">5 minutes before</option>
                            <option value="10" selected>10 minutes before</option>
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                            <option value="60">1 hour before</option>
                        </select>
                    </div>
                    <button id="addMedBtn" class="btn btn-primary" onclick="addMedication()">Add Medication</button>
                    <button id="cancelEditMedBtn" class="btn hidden" onclick="cancelEditMedication()" style="background: #95a5a6; margin-top: 10px;">Cancel Editing</button>
                </div>
            </div>

            <!-- Appointments Section -->
            <div id="appointments" class="section">
                <h2 class="section-title">üìÖ Appointments</h2>
                <div id="appointmentList"></div>
                
                <div class="form-section">
                    <h3>Add New Appointment</h3>
                    <div class="input-group">
                        <label>Doctor/Clinic Name</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" 
                                   id="apptDoctor" 
                                   placeholder="Type doctor or clinic name" 
                                   autocomplete="off"
                                   onfocus="showAutocomplete('apptDoctor', 'doctorDropdown')"
                                   oninput="filterAutocomplete('apptDoctor', 'doctorDropdown')"
                                   onblur="setTimeout(() => hideAutocomplete('doctorDropdown'), 200)">
                            <div id="doctorDropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0 0;">üí° Start typing to see suggestions from your history</p>
                    </div>
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="apptDate">
                    </div>
                    <div class="input-group">
                        <label>Time</label>
                        <input type="time" id="apptTime">
                    </div>
                    <div class="input-group">
                        <label>Location</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" 
                                   id="apptLocation" 
                                   placeholder="Type location" 
                                   autocomplete="off"
                                   onfocus="showAutocomplete('apptLocation', 'locationDropdown')"
                                   oninput="filterAutocomplete('apptLocation', 'locationDropdown')"
                                   onblur="setTimeout(() => hideAutocomplete('locationDropdown'), 200)">
                            <div id="locationDropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0 0;">üí° Click to see all locations, or type to filter</p>
                    </div>
                    <div class="input-group">
                        <label class="reminder-checkbox">
                            <input type="checkbox" id="apptReminderEnabled" onchange="toggleApptReminderOptions()">
                            üîî Enable Reminder
                        </label>
                    </div>
                    <div id="apptReminderOptions" class="input-group hidden">
                        <label>Remind me:</label>
                        <select id="apptReminderMinutes" class="reminder-time-select">
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                            <option value="60" selected>1 hour before</option>
                            <option value="120">2 hours before</option>
                            <option value="1440">1 day before</option>
                        </select>
                    </div>
                    <button id="addApptBtn" class="btn btn-primary" onclick="addAppointment()">Add Appointment</button>
                    <button id="cancelEditApptBtn" class="btn hidden" onclick="cancelEditAppointment()" style="background: #95a5a6; margin-top: 10px;">Cancel Editing</button>
                </div>
            </div>

            <!-- Tasks Section -->
            <div id="tasks" class="section">
                <h2 class="section-title">‚úÖ Daily Tasks</h2>
                
                <div class="card task">
                    <div class="card-header">üçΩÔ∏è Meals</div>
                    <div id="mealsTasks"></div>
                </div>

                <div class="card task">
                    <div class="card-header">üíß Hydration</div>
                    <div id="hydrationTasks"></div>
                </div>

                <div class="card task">
                    <div class="card-header">üßº Hygiene</div>
                    <div id="hygieneTasks"></div>
                </div>

                <div class="card task">
                    <div class="card-header">üõ°Ô∏è Safety Checks</div>
                    <div id="safetyTasks"></div>
                </div>

                <div class="form-section">
                    <h3>Add Custom Task</h3>
                    <div class="input-group">
                        <label>Task Name</label>
                        <input type="text" id="customTaskName" placeholder="e.g., Take a walk">
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <select id="customTaskCategory">
                            <option value="meals">Meals</option>
                            <option value="hydration">Hydration</option>
                            <option value="hygiene">Hygiene</option>
                            <option value="safety">Safety Checks</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Time (optional)</label>
                        <input type="time" id="customTaskTime">
                    </div>
                    <div class="input-group">
                        <label>How Often?</label>
                        <select id="customTaskRecurrence" onchange="updateTaskRecurrenceOptions()">
                            <option value="daily">Daily (Every day)</option>
                            <option value="specific-days">Specific Days of Week</option>
                            <option value="weekly">Weekly (Once a week)</option>
                        </select>
                    </div>
                    <div id="taskSpecificDaysContainer" class="input-group hidden">
                        <label>Select Days:</label>
                        <div class="day-checkbox-container">
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="task-day-checkbox" value="0"> Sunday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="task-day-checkbox" value="1"> Monday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="task-day-checkbox" value="2"> Tuesday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="task-day-checkbox" value="3"> Wednesday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="task-day-checkbox" value="4"> Thursday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="task-day-checkbox" value="5"> Friday
                            </label>
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="task-day-checkbox" value="6"> Saturday
                            </label>
                        </div>
                    </div>
                    <div id="taskWeeklyDayContainer" class="input-group hidden">
                        <label>Which day of the week?</label>
                        <select id="customTaskWeeklyDay">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="reminder-checkbox">
                            <input type="checkbox" id="taskReminderEnabled" onchange="toggleTaskReminderOptions()">
                            üîî Enable Reminder
                        </label>
                    </div>
                    <div id="taskReminderOptions" class="input-group hidden">
                        <label>Remind me (minutes before):</label>
                        <select id="taskReminderMinutes" class="reminder-time-select">
                            <option value="5">5 minutes before</option>
                            <option value="10" selected>10 minutes before</option>
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                        </select>
                    </div>
                    <button id="addTaskBtn" class="btn btn-primary" onclick="addCustomTask()">Add Task</button>
                    <button id="cancelEditTaskBtn" class="btn hidden" onclick="cancelEditTask()" style="background: #95a5a6; margin-top: 10px;">Cancel Editing</button>
                </div>
            </div>

            <!-- Bills Section -->
            <div id="bills" class="section">
                <h2 class="section-title">üí∞ Bills</h2>
                <div id="billList"></div>
                
                <div class="form-section">
                    <h3>Add New Bill</h3>
                    <div class="input-group">
                        <label>Bill Name</label>
                        <input type="text" id="billName" placeholder="e.g., Electric Bill">
                    </div>
                    <div class="input-group">
                        <label>Amount</label>
                        <input type="number" id="billAmount" placeholder="e.g., 150">
                    </div>
                    <div class="input-group">
                        <label>Due Date</label>
                        <input type="date" id="billDueDate">
                    </div>
                    <div class="input-group">
                        <label>How Often?</label>
                        <select id="billRecurrence">
                            <option value="one-time">One-Time (No repeat)</option>
                            <option value="monthly">Monthly (Every month)</option>
                            <option value="quarterly">Quarterly (Every 3 months)</option>
                            <option value="yearly">Yearly (Once a year)</option>
                            <option value="weekly">Weekly (Every week)</option>
                            <option value="biweekly">Bi-Weekly (Every 2 weeks)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="reminder-checkbox">
                            <input type="checkbox" id="billReminderEnabled" onchange="toggleBillReminderOptions()">
                            üîî Enable Reminder
                        </label>
                    </div>
                    <div id="billReminderOptions" class="input-group hidden">
                        <label>Remind me:</label>
                        <select id="billReminderDays" class="reminder-time-select">
                            <option value="1">1 day before due date</option>
                            <option value="3" selected>3 days before due date</option>
                            <option value="7">7 days before due date</option>
                            <option value="14">14 days before due date</option>
                        </select>
                    </div>
                    <button id="addBillBtn" class="btn btn-primary" onclick="addBill()">Add Bill</button>
                    <button id="cancelEditBillBtn" class="btn hidden" onclick="cancelEditBill()" style="background: #95a5a6; margin-top: 10px;">Cancel Editing</button>
                </div>
            </div>

            <!-- Activities Section -->
            <div id="activities" class="section">
                <h2 class="section-title">üéâ Activities</h2>

                <div id="activityList"></div>
                
                <div class="form-section">
                    <h3>Add New Activity</h3>
                    <div class="input-group">
                        <label for="activityName">Activity Name</label>
                        <input type="text" id="activityName" placeholder="e.g., Yoga Class, Bingo Night">
                    </div>
                    <div class="input-group">
                        <label for="activityLocation">Location</label>
                        <input type="text" id="activityLocation" placeholder="e.g., Recreation Center, Senior Center">
                    </div>
                    <div class="input-group">
                        <label for="activityDescription">Description (Optional)</label>
                        <textarea id="activityDescription" placeholder="Any additional details about the activity" rows="3" style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #cbd5e0; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="activityRecurrence">How Often?</label>
                        <select id="activityRecurrence" onchange="updateActivityRecurrenceOptions()">
                            <option value="one-time">One-time event</option>
                            <option value="daily">Every day</option>
                            <option value="weekly">Weekly (same day each week)</option>
                            <option value="specific-days">Specific days of the week</option>
                            <option value="monthly">Monthly (same date)</option>
                        </select>
                    </div>

                    <div id="activityOneTimeContainer" style="display: none;">
                        <div class="input-group">
                            <label for="activityDate">Date</label>
                            <input type="date" id="activityDate">
                        </div>
                    </div>

                    <div id="activityWeeklyContainer" style="display: none;">
                        <div class="input-group">
                            <label for="activityWeeklyDay">Day of Week</label>
                            <select id="activityWeeklyDay">
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                    </div>

                    <div id="activitySpecificDaysContainer" style="display: none;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Select Days</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                            <label class="reminder-checkbox" style="min-width: 80px;">
                                <input type="checkbox" class="activity-day-checkbox" value="0">
                                <span>Sun</span>
                            </label>
                            <label class="reminder-checkbox" style="min-width: 80px;">
                                <input type="checkbox" class="activity-day-checkbox" value="1">
                                <span>Mon</span>
                            </label>
                            <label class="reminder-checkbox" style="min-width: 80px;">
                                <input type="checkbox" class="activity-day-checkbox" value="2">
                                <span>Tue</span>
                            </label>
                            <label class="reminder-checkbox" style="min-width: 80px;">
                                <input type="checkbox" class="activity-day-checkbox" value="3">
                                <span>Wed</span>
                            </label>
                            <label class="reminder-checkbox" style="min-width: 80px;">
                                <input type="checkbox" class="activity-day-checkbox" value="4">
                                <span>Thu</span>
                            </label>
                            <label class="reminder-checkbox" style="min-width: 80px;">
                                <input type="checkbox" class="activity-day-checkbox" value="5">
                                <span>Fri</span>
                            </label>
                            <label class="reminder-checkbox" style="min-width: 80px;">
                                <input type="checkbox" class="activity-day-checkbox" value="6">
                                <span>Sat</span>
                            </label>
                        </div>
                    </div>

                    <div id="activityMonthlyContainer" style="display: none;">
                        <div class="input-group">
                            <label for="activityMonthlyDate">Day of Month (1-31)</label>
                            <input type="number" id="activityMonthlyDate" min="1" max="31" value="1">
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="activityTime">Time</label>
                        <input type="time" id="activityTime">
                    </div>

                    <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; border: 2px solid #4299e1; margin-bottom: 15px;">
                        <label class="reminder-checkbox" style="margin-bottom: 10px;">
                            <input type="checkbox" id="activityReminderEnabled" onchange="toggleActivityReminderOptions()">
                            <span style="font-size: 16px; font-weight: 600;">üîî Enable Reminder</span>
                        </label>
                        <div id="activityReminderOptions" class="hidden" style="margin-top: 10px;">
                            <label for="activityReminderMinutes" style="display: block; margin-bottom: 5px; font-size: 14px;">Remind me:</label>
                            <select id="activityReminderMinutes" style="width: 100%; padding: 10px; font-size: 16px; border: 1px solid #cbd5e0; border-radius: 8px;">
                                <option value="15">15 minutes before</option>
                                <option value="30" selected>30 minutes before</option>
                                <option value="60">1 hour before</option>
                                <option value="120">2 hours before</option>
                                <option value="1440">1 day before</option>
                            </select>
                        </div>
                    </div>

                    <button id="addActivityBtn" class="btn btn-primary" onclick="addActivity()">Add Activity</button>
                    <button id="cancelEditActivityBtn" class="btn hidden" onclick="cancelEditActivity()" style="background: #95a5a6; margin-top: 10px;">Cancel Editing</button>
                </div>
            </div>

            <!-- Contacts Section -->
            <div id="contacts" class="section">
                <h2 class="section-title">üìû Contacts</h2>

                <div id="contactList"></div>
                
                <div class="form-section">
                    <h3>Add New Contact</h3>
                    <div class="input-group">
                        <label>Name</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" 
                                   id="contactName" 
                                   placeholder="Type contact name" 
                                   autocomplete="off"
                                   onfocus="showContactAutocomplete()"
                                   oninput="filterContactAutocomplete()"
                                   onblur="setTimeout(() => hideAutocomplete('contactDropdown'), 200)">
                            <div id="contactDropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0 0;">üí° Start typing to see existing contacts - phone number will auto-fill!</p>
                    </div>
                    <div class="input-group">
                        <label>Relationship</label>
                        <input type="text" id="contactRelation" placeholder="e.g., Daughter">
                    </div>
                    <div class="input-group">
                        <label>Phone Number</label>
                        <input type="tel" id="contactPhone" placeholder="e.g., (555) 123-4567">
                        <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0 0;">üì± Auto-fills when you select an existing contact</p>
                    </div>
                    <button class="btn btn-primary" onclick="addContact()">Add Contact</button>
                </div>
            </div>

            <!-- Help Section -->
            <div id="help" class="section">
                <h2 class="section-title">‚ùì Help Center</h2>
                
                <!-- Search Box -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <div class="card-content">
                        <h3 style="margin: 0 0 15px 0; color: white;">üîç Search for Help</h3>
                        <input type="text" id="helpSearch" placeholder="Try: 'add medication', 'reminder', 'password'..." 
                               onkeyup="searchHelp()" 
                               onkeydown="handleHelpSearchKeydown(event)"
                               style="width: 100%; padding: 15px; font-size: 18px; border: 3px solid white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                        <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">Type a keyword to find help instantly</p>
                    </div>
                </div>

                <!-- Search Results (hidden by default) -->
                <div id="searchResults" class="hidden" style="margin-bottom: 20px;"></div>

                <!-- Quick Access Buttons -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-info" onclick="showHelpTopic('getting-started')" style="padding: 15px; font-size: 16px;">
                        üöÄ Getting Started
                    </button>
                    <button class="btn btn-info" onclick="showHelpTopic('common-questions')" style="padding: 15px; font-size: 16px;">
                        ‚ùì Common Questions
                    </button>
                    <button class="btn btn-info" onclick="showHelpTopic('troubleshooting')" style="padding: 15px; font-size: 16px;">
                        üîß Troubleshooting
                    </button>
                </div>

                <!-- Help Topics Container -->
                <div id="helpTopicsContainer">
                    <!-- All Topics Overview (shown by default) -->
                    <div id="help-all-topics" class="help-topic-section">
                        <div class="card">
                            <div class="card-header" style="background: #4299e1; color: white;">
                                üìö Browse All Help Topics
                            </div>
                            <div class="card-content" style="line-height: 1.8;">
                                <div onclick="showHelpTopic('getting-started')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #4299e1;">
                                    <strong>üöÄ Getting Started</strong><br>
                                    <span style="font-size: 14px; color: #666;">First time using the app? Start here!</span>
                                </div>
                                <div onclick="showHelpTopic('medications')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #9f7aea;">
                                    <strong>üíä Medications</strong><br>
                                    <span style="font-size: 14px; color: #666;">Add, track, and manage medications</span>
                                </div>
                                <div onclick="showHelpTopic('appointments')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #ed8936;">
                                    <strong>üìÖ Appointments</strong><br>
                                    <span style="font-size: 14px; color: #666;">Schedule and track doctor visits</span>
                                </div>
                                <div onclick="showHelpTopic('tasks')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #48bb78;">
                                    <strong>‚úÖ Tasks</strong><br>
                                    <span style="font-size: 14px; color: #666;">Daily routines and to-do items</span>
                                </div>
                                <div onclick="showHelpTopic('bills')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #f6ad55;">
                                    <strong>üí∞ Bills</strong><br>
                                    <span style="font-size: 14px; color: #666;">Track bills and payments</span>
                                </div>
                                <div onclick="showHelpTopic('activities')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #ed64a6;">
                                    <strong>üéâ Activities</strong><br>
                                    <span style="font-size: 14px; color: #666;">Social events and classes</span>
                                </div>
                                <div onclick="showHelpTopic('contacts')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #667eea;">
                                    <strong>üìû Contacts</strong><br>
                                    <span style="font-size: 14px; color: #666;">Save important phone numbers</span>
                                </div>
                                <div onclick="showHelpTopic('voice')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #38b2ac;">
                                    <strong>üé§ Voice Assistant</strong><br>
                                    <span style="font-size: 14px; color: #666;">Use voice commands and dictation</span>
                                </div>
                                <div onclick="showHelpTopic('common-questions')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #718096;">
                                    <strong>‚ùì Common Questions</strong><br>
                                    <span style="font-size: 14px; color: #666;">Frequently asked questions</span>
                                </div>
                                <div onclick="showHelpTopic('troubleshooting')" style="padding: 12px; margin: 5px 0; background: #f7fafc; border-radius: 8px; cursor: pointer; border-left: 4px solid #e53e3e;">
                                    <strong>üîß Troubleshooting</strong><br>
                                    <span style="font-size: 14px; color: #666;">Fix common problems</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Getting Started Topic -->
                    <div id="help-getting-started" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #4299e1; color: white;">
                                üöÄ Getting Started
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>Welcome to Senior Care! üëã</h3>
                                <p>This app helps you manage medications, appointments, tasks, bills, activities, and contacts all in one place.</p>
                                
                                <h3>üì± Your First Steps:</h3>
                                <ol style="line-height: 2;">
                                    <li><strong>Home Screen:</strong> See today's overview - medications to take, upcoming appointments, tasks to complete</li>
                                    <li><strong>Navigation Tabs:</strong> Tap the tabs at the top to switch between sections (Meds, Appts, Tasks, etc.)</li>
                                    <li><strong>Add Your First Item:</strong> Go to any section and fill in the form at the bottom</li>
                                    <li><strong>Set Reminders:</strong> Check the "Enable Reminder" box to get notifications</li>
                                    <li><strong>Minimize Cards:</strong> Click the ‚ñ≤ button to collapse items you don't need to see</li>
                                </ol>

                                <h3>üéØ Quick Tips:</h3>
                                <ul style="line-height: 2;">
                                    <li>üîî <strong>Enable notifications</strong> in your Profile to never miss a reminder</li>
                                    <li>üé§ <strong>Turn on Voice Assistant</strong> in Profile to use voice commands</li>
                                    <li>üíæ <strong>Backup your data</strong> regularly using Export Data in Profile</li>
                                    <li>‚ùì <strong>Use this Help tab</strong> anytime you need assistance</li>
                                </ul>

                                <h3>üìñ Understanding the Icons:</h3>
                                <ul style="line-height: 2; list-style: none; padding-left: 0;">
                                    <li>üíä = Medications</li>
                                    <li>üìÖ = Appointments</li>
                                    <li>‚úÖ = Tasks</li>
                                    <li>üí∞ = Bills</li>
                                    <li>üéâ = Activities</li>
                                    <li>üìû = Contacts</li>
                                    <li>üîî = Reminder is ON</li>
                                    <li>‚ñº = Click to expand</li>
                                    <li>‚ñ≤ = Click to minimize</li>
                                    <li>‚úì = Completed</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Medications Topic -->
                    <div id="help-medications" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #9f7aea; color: white;">
                                üíä Medications Help
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>How to Add a Medication:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap the <strong>üíä Meds</strong> tab at the top</li>
                                    <li>Scroll down to "Add New Medication"</li>
                                    <li>Fill in:
                                        <ul>
                                            <li><strong>Medication Name:</strong> e.g., "Aspirin"</li>
                                            <li><strong>Dosage:</strong> e.g., "81mg" or "1 tablet"</li>
                                            <li><strong>Time:</strong> When you take it (e.g., 8:00 AM)</li>
                                            <li><strong>How Often:</strong> Daily, weekly, specific days, etc.</li>
                                        </ul>
                                    </li>
                                    <li>Check <strong>"Enable Reminder"</strong> to get notified</li>
                                    <li>Tap <strong>"Add Medication"</strong></li>
                                </ol>

                                <h3>How to Mark as Taken:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the medication in your list</li>
                                    <li>Click ‚ñº to expand if minimized</li>
                                    <li>Tap <strong>"Mark as Taken"</strong> button</li>
                                    <li>The button will turn green with a ‚úì</li>
                                </ol>

                                <h3>How to Edit a Medication:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the medication</li>
                                    <li>Click ‚ñº to expand if minimized</li>
                                    <li>Tap <strong>"Edit"</strong></li>
                                    <li>Make your changes in the form</li>
                                    <li>Tap <strong>"Update Medication"</strong></li>
                                </ol>

                                <h3>How to Delete a Medication:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the medication</li>
                                    <li>Click ‚ñº to expand if minimized</li>
                                    <li>Tap <strong>"Delete"</strong></li>
                                    <li>Confirm you want to delete it</li>
                                </ol>

                                <h3>üí° Tips:</h3>
                                <ul style="line-height: 2;">
                                    <li>Use the ‚ñ≤ button to minimize medications you don't need to see right now</li>
                                    <li>Set reminders 10-15 minutes before you need to take them</li>
                                    <li>If you take a medication twice daily, add it twice with different times</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Assistant Topic -->
                    <div id="help-voice" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #38b2ac; color: white;">
                                üé§ Voice Assistant Help
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>How to Enable Voice Assistant:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap <strong>üë§ Profile</strong> button (top right)</li>
                                    <li>Scroll to "Voice Assistant Settings"</li>
                                    <li>Tap the toggle to turn it <strong>ON</strong></li>
                                    <li>A floating üé§ button will appear at the bottom right</li>
                                </ol>

                                <h3>How to Use Voice Commands:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap the <strong>üé§ VOICE</strong> button</li>
                                    <li>Wait for it to turn red (listening)</li>
                                    <li>Speak your command clearly</li>
                                    <li>The app will respond and ask questions if needed</li>
                                    <li>Say "yes" to confirm actions</li>
                                </ol>

                                <h3>üó£Ô∏è Voice Commands You Can Use:</h3>
                                
                                <h4>üíä Add Medications:</h4>
                                <ul style="line-height: 2;">
                                    <li><strong>"Add medication Aspirin 81mg at 8 AM"</strong></li>
                                    <li>"Add medication" (app will ask for details)</li>
                                    <li>App will confirm before adding</li>
                                    <li>Say "yes" to confirm or "no" to cancel</li>
                                </ul>
                                <p style="margin: 10px 0; padding: 10px; background: #e6fffa; border-left: 4px solid #38b2ac; border-radius: 4px; font-size: 15px;">
                                    <strong>Example:</strong><br>
                                    You: "Add medication Aspirin 81 milligrams at 8 AM"<br>
                                    App: "I will add Aspirin 81mg at 8:00 AM daily. Is this correct?"<br>
                                    You: "Yes"<br>
                                    App: "Added Aspirin 81mg at 8:00 AM"
                                </p>

                                <h4>‚úì Mark as Taken:</h4>
                                <ul style="line-height: 2;">
                                    <li><strong>"Mark Aspirin as taken"</strong></li>
                                    <li>"Mark taken" (app will ask which one)</li>
                                    <li>App will confirm before marking</li>
                                </ul>
                                <p style="margin: 10px 0; padding: 10px; background: #e6fffa; border-left: 4px solid #38b2ac; border-radius: 4px; font-size: 15px;">
                                    <strong>Example:</strong><br>
                                    You: "Mark Aspirin as taken"<br>
                                    App: "Mark Aspirin as taken? Say yes to confirm."<br>
                                    You: "Yes"<br>
                                    App: "Marked Aspirin as taken"
                                </p>

                                <h4>üìû Call Contacts:</h4>
                                <ul style="line-height: 2;">
                                    <li><strong>"Call Cathy"</strong></li>
                                    <li>"Call my daughter"</li>
                                    <li>"Phone John"</li>
                                    <li>App will confirm before calling</li>
                                </ul>
                                <p style="margin: 10px 0; padding: 10px; background: #e6fffa; border-left: 4px solid #38b2ac; border-radius: 4px; font-size: 15px;">
                                    <strong>Example:</strong><br>
                                    You: "Call Cathy"<br>
                                    App: "Call Cathy at 555-123-4567? Say yes to confirm."<br>
                                    You: "Yes"<br>
                                    App: "Calling Cathy" (phone starts dialing)
                                </p>

                                <h4>üß≠ Navigation:</h4>
                                <ul style="line-height: 2;">
                                    <li>"Go to medications"</li>
                                    <li>"Show my appointments"</li>
                                    <li>"Open tasks"</li>
                                    <li>"Go to activities"</li>
                                    <li>"Show contacts"</li>
                                    <li>"Take me home"</li>
                                </ul>

                                <h4>‚ùì Getting Help:</h4>
                                <ul style="line-height: 2;">
                                    <li>"How do I add a medication?"</li>
                                    <li>"Help with reminders"</li>
                                    <li>"How do I add an appointment?"</li>
                                    <li>"Help with voice commands"</li>
                                </ul>

                                <h4>üìñ Reading Content:</h4>
                                <ul style="line-height: 2;">
                                    <li>"Read this to me"</li>
                                    <li>"Read the page"</li>
                                </ul>

                                <h3>üéØ How Voice Commands Work:</h3>
                                <p><strong>Smart Parsing:</strong> The app tries to understand everything you say in one command.</p>
                                <p><strong>Guided Conversation:</strong> If you're missing information, the app will ask questions.</p>
                                <p><strong>Always Confirm:</strong> Before taking any action, the app will ask "Is this correct?"</p>
                                
                                <h4>Example Conversation:</h4>
                                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <p style="margin: 5px 0;"><strong>You:</strong> "Add medication"</p>
                                    <p style="margin: 5px 0;"><strong>App:</strong> "What medication would you like to add?"</p>
                                    <p style="margin: 5px 0;"><strong>You:</strong> "Aspirin"</p>
                                    <p style="margin: 5px 0;"><strong>App:</strong> "Aspirin. What dosage?"</p>
                                    <p style="margin: 5px 0;"><strong>You:</strong> "81 milligrams"</p>
                                    <p style="margin: 5px 0;"><strong>App:</strong> "81mg. What time do you take it?"</p>
                                    <p style="margin: 5px 0;"><strong>You:</strong> "8 AM"</p>
                                    <p style="margin: 5px 0;"><strong>App:</strong> "I will add Aspirin 81mg at 8:00 AM daily. Is this correct?"</p>
                                    <p style="margin: 5px 0;"><strong>You:</strong> "Yes"</p>
                                    <p style="margin: 5px 0;"><strong>App:</strong> "Added Aspirin 81mg at 8:00 AM"</p>
                                </div>

                                <h3>üí° Tips for Best Results:</h3>
                                <ul style="line-height: 2;">
                                    <li><strong>Be specific:</strong> "Add medication Aspirin 81mg at 8 AM" is better than just "add medication"</li>
                                    <li><strong>Speak clearly:</strong> Reduce background noise</li>
                                    <li><strong>Wait for red:</strong> Button turns red when listening</li>
                                    <li><strong>Say yes or no:</strong> When asked for confirmation</li>
                                    <li><strong>Be patient:</strong> App may ask follow-up questions</li>
                                </ul>

                                <h3>‚ö†Ô∏è Important Notes:</h3>
                                <ul style="line-height: 2;">
                                    <li>Voice assistant always confirms before taking actions</li>
                                    <li>You can say "cancel" or "no" at any time</li>
                                    <li>Works best in quiet environments</li>
                                    <li>Some features may require multiple steps</li>
                                </ul>

                                <h3>üöÄ Coming Soon:</h3>
                                <ul style="line-height: 2;">
                                    <li>Add appointments by voice</li>
                                    <li>Add tasks by voice</li>
                                    <li>Delete items by voice</li>
                                    <li>List and query items by voice</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments Topic -->
                    <div id="help-appointments" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #ed8936; color: white;">
                                üìÖ Appointments Help
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>How to Add an Appointment:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap the <strong>üìÖ Appts</strong> tab at the top</li>
                                    <li>Scroll down to "Add New Appointment"</li>
                                    <li>Fill in:
                                        <ul>
                                            <li><strong>Doctor/Provider:</strong> e.g., "Dr. Smith"</li>
                                            <li><strong>Location:</strong> e.g., "Main Clinic"</li>
                                            <li><strong>Date:</strong> Select the appointment date</li>
                                            <li><strong>Time:</strong> When your appointment is</li>
                                        </ul>
                                    </li>
                                    <li>Check <strong>"Enable Reminder"</strong> to get notified</li>
                                    <li>Tap <strong>"Add Appointment"</strong></li>
                                </ol>

                                <h3>How to Mark as Completed:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the appointment in your list</li>
                                    <li>Click ‚ñº to expand if minimized</li>
                                    <li>Tap <strong>"Mark as Completed"</strong> button</li>
                                    <li>The button will turn green with a ‚úì</li>
                                </ol>

                                <h3>üí° Tips:</h3>
                                <ul style="line-height: 2;">
                                    <li>Set reminders 1 day before appointments</li>
                                    <li>Include location details (building, floor, suite number)</li>
                                    <li>Minimize past appointments to reduce clutter</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks Topic -->
                    <div id="help-tasks" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #48bb78; color: white;">
                                ‚úÖ Tasks Help
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>How to Add a Custom Task:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap the <strong>‚úÖ Tasks</strong> tab at the top</li>
                                    <li>Choose a category (Meals, Hydration, Hygiene, or Safety)</li>
                                    <li>Scroll to "Add Custom Task"</li>
                                    <li>Fill in:
                                        <ul>
                                            <li><strong>Task Name:</strong> e.g., "Take vitamins"</li>
                                            <li><strong>Time:</strong> When to do it</li>
                                            <li><strong>How Often:</strong> Daily, weekly, specific days, etc.</li>
                                        </ul>
                                    </li>
                                    <li>Check <strong>"Enable Reminder"</strong> for notifications</li>
                                    <li>Tap <strong>"Add Task"</strong></li>
                                </ol>

                                <h3>How to Complete a Task:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the task in its category</li>
                                    <li>Tap the checkbox ‚òê next to it</li>
                                    <li>It becomes checked ‚úì</li>
                                    <li>Tasks reset daily</li>
                                </ol>

                                <h3>Task Categories:</h3>
                                <ul style="line-height: 2;">
                                    <li><strong>Meals:</strong> Eating and nutrition tasks</li>
                                    <li><strong>Hydration:</strong> Drinking water reminders</li>
                                    <li><strong>Hygiene:</strong> Personal care routines</li>
                                    <li><strong>Safety:</strong> Important safety checks</li>
                                </ul>

                                <h3>üí° Tips:</h3>
                                <ul style="line-height: 2;">
                                    <li>Tasks marked "Not scheduled for today" won't show checkboxes</li>
                                    <li>Set specific times for tasks that must be done at certain times</li>
                                    <li>Use minimize ‚ñ≤ to hide completed tasks</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Bills Topic -->
                    <div id="help-bills" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #f6ad55; color: white;">
                                üí∞ Bills Help
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>How to Add a Bill:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap the <strong>üí∞ Bills</strong> tab at the top</li>
                                    <li>Scroll down to "Add New Bill"</li>
                                    <li>Fill in:
                                        <ul>
                                            <li><strong>Bill Name:</strong> e.g., "Electric Bill"</li>
                                            <li><strong>Amount:</strong> e.g., "150.00"</li>
                                            <li><strong>Due Date:</strong> When it's due</li>
                                            <li><strong>How Often:</strong> One-time, monthly, quarterly, yearly</li>
                                        </ul>
                                    </li>
                                    <li>Check <strong>"Enable Reminder"</strong> to get notified before due date</li>
                                    <li>Tap <strong>"Add Bill"</strong></li>
                                </ol>

                                <h3>How to Mark as Paid:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the bill in your list</li>
                                    <li>Click ‚ñº to expand if minimized</li>
                                    <li>Tap <strong>"Mark as Paid"</strong> button</li>
                                    <li>The button will turn green with a ‚úì</li>
                                </ol>

                                <h3>Recurring Bills:</h3>
                                <ul style="line-height: 2;">
                                    <li><strong>Monthly:</strong> Repeats same day each month</li>
                                    <li><strong>Quarterly:</strong> Every 3 months</li>
                                    <li><strong>Yearly:</strong> Once per year</li>
                                    <li>Recurring bills automatically create next due date when paid</li>
                                </ul>

                                <h3>üí° Tips:</h3>
                                <ul style="line-height: 2;">
                                    <li>Set reminders 3-7 days before due date</li>
                                    <li>Mark bills as paid immediately after paying</li>
                                    <li>Use minimize ‚ñ≤ to hide paid bills</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Activities Topic -->
                    <div id="help-activities" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #ed64a6; color: white;">
                                üéâ Activities Help
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>How to Add an Activity:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap the <strong>üéâ Activities</strong> tab at the top</li>
                                    <li>Scroll down to "Add New Activity"</li>
                                    <li>Fill in:
                                        <ul>
                                            <li><strong>Activity Name:</strong> e.g., "Yoga Class"</li>
                                            <li><strong>Location:</strong> e.g., "Recreation Center"</li>
                                            <li><strong>Time:</strong> When it happens</li>
                                            <li><strong>How Often:</strong> One-time, daily, weekly, specific days, or monthly</li>
                                        </ul>
                                    </li>
                                    <li>Optionally add a description</li>
                                    <li>Check <strong>"Enable Reminder"</strong> to get notified before</li>
                                    <li>Tap <strong>"Add Activity"</strong></li>
                                </ol>

                                <h3>How to Mark as Attended:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the activity in your list</li>
                                    <li>Click ‚ñº to expand if minimized</li>
                                    <li>Tap <strong>"Mark as Attended"</strong> button</li>
                                    <li>The button will turn green with a ‚úì</li>
                                </ol>

                                <h3>Schedule Options:</h3>
                                <ul style="line-height: 2;">
                                    <li><strong>Weekly:</strong> Same day each week (e.g., every Tuesday)</li>
                                    <li><strong>Specific Days:</strong> Multiple days (e.g., Mon/Wed/Fri)</li>
                                    <li><strong>Monthly:</strong> Same date each month (e.g., 15th of month)</li>
                                    <li>Activities only scheduled for today show "Mark as Attended"</li>
                                </ul>

                                <h3>üí° Tips:</h3>
                                <ul style="line-height: 2;">
                                    <li>Add all your regular classes and events once</li>
                                    <li>Set reminders 30-60 minutes before</li>
                                    <li>Track attendance to see which activities you enjoy most</li>
                                    <li>Minimize activities you don't attend regularly</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Contacts Topic -->
                    <div id="help-contacts" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #667eea; color: white;">
                                üìû Contacts Help
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>How to Add a Contact:</h3>
                                <ol style="line-height: 2;">
                                    <li>Tap the <strong>üìû Contacts</strong> tab at the top</li>
                                    <li>Scroll down to "Add New Contact"</li>
                                    <li>Fill in:
                                        <ul>
                                            <li><strong>Name:</strong> e.g., "Cathy"</li>
                                            <li><strong>Relationship:</strong> e.g., "Daughter"</li>
                                            <li><strong>Phone Number:</strong> e.g., "(555) 123-4567"</li>
                                        </ul>
                                    </li>
                                    <li>Tap <strong>"Add Contact"</strong></li>
                                </ol>

                                <h3>How to Call a Contact:</h3>
                                <ol style="line-height: 2;">
                                    <li>Find the contact in your list</li>
                                    <li>Click ‚ñº to expand if minimized</li>
                                    <li>Tap <strong>"üìû Call"</strong> button</li>
                                    <li>Your phone will start calling them</li>
                                </ol>

                                <h3>Emergency Call:</h3>
                                <p>On the home screen, there's a big red <strong>"üö® CALL 911 EMERGENCY"</strong> button.</p>
                                <ul style="line-height: 2;">
                                    <li>Only use in real emergencies</li>
                                    <li>App will ask you to confirm</li>
                                    <li>Then calls 911 immediately</li>
                                </ul>

                                <h3>üí° Tips:</h3>
                                <ul style="line-height: 2;">
                                    <li>Add family members first</li>
                                    <li>Include doctor's offices and pharmacy</li>
                                    <li>Save emergency contacts (even if they're in your phone)</li>
                                    <li>Minimize contacts you don't call often</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Common Questions Topic -->
                    <div id="help-common-questions" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #718096; color: white;">
                                ‚ùì Common Questions
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>‚ùì I forgot my password. What do I do?</h3>
                                <ol style="line-height: 2;">
                                    <li>On the login screen, tap <strong>"Forgot Password?"</strong></li>
                                    <li>Enter your username and email address</li>
                                    <li>If they match, you can set a new password</li>
                                </ol>

                                <h3>‚ùì How do I change my password?</h3>
                                <ol style="line-height: 2;">
                                    <li>Go to <strong>Profile</strong> (top right)</li>
                                    <li>Scroll to "Change Password"</li>
                                    <li>Enter your current password</li>
                                    <li>Enter your new password twice</li>
                                    <li>Tap <strong>"Change Password"</strong></li>
                                </ol>

                                <h3>‚ùì Why am I not getting reminders?</h3>
                                <ol style="line-height: 2;">
                                    <li>Make sure you enabled reminders when adding items</li>
                                    <li>Go to Profile ‚Üí Notification Settings</li>
                                    <li>Tap <strong>"Enable Notifications"</strong></li>
                                    <li>Allow notifications when your browser asks</li>
                                    <li>On iPhone: Must "Add to Home Screen" first</li>
                                </ol>

                                <h3>‚ùì How do I backup my data?</h3>
                                <ol style="line-height: 2;">
                                    <li>Go to <strong>Profile</strong></li>
                                    <li>Scroll to "Data Backup"</li>
                                    <li>Tap <strong>"Export Data"</strong></li>
                                    <li>Save the file somewhere safe</li>
                                    <li>Do this monthly for safety!</li>
                                </ol>

                                <h3>‚ùì What does the ‚ñ≤/‚ñº button do?</h3>
                                <p><strong>‚ñº (Down arrow):</strong> Click to expand and see full details</p>
                                <p><strong>‚ñ≤ (Up arrow):</strong> Click to minimize and save space</p>
                                <p>This helps you see more items on one screen!</p>

                                <h3>‚ùì Can I use this app on my phone?</h3>
                                <p>Yes! This app works on all devices:</p>
                                <ul style="line-height: 2;">
                                    <li>iPhone (Safari)</li>
                                    <li>Android (Chrome)</li>
                                    <li>iPad</li>
                                    <li>Computer</li>
                                </ul>
                                <p>For best results on phones, tap "Add to Home Screen" in your browser menu.</p>

                                <h3>‚ùì How do I delete something by accident?</h3>
                                <p>Unfortunately, once deleted, items cannot be recovered. That's why the app always asks "Are you sure?" before deleting. Always double-check before confirming!</p>
                                <p><strong>Tip:</strong> Backup your data regularly so you have a copy.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Troubleshooting Topic -->
                    <div id="help-troubleshooting" class="help-topic-section hidden">
                        <button class="btn" onclick="showHelpTopic('all-topics')" style="margin-bottom: 15px;">
                            ‚Üê Back to All Topics
                        </button>
                        <div class="card">
                            <div class="card-header" style="background: #e53e3e; color: white;">
                                üîß Troubleshooting
                            </div>
                            <div class="card-content" style="line-height: 1.8; font-size: 16px;">
                                <h3>üêå App is Running Slow</h3>
                                <p><strong>Try these solutions:</strong></p>
                                <ol style="line-height: 2;">
                                    <li>Refresh the page (pull down on mobile)</li>
                                    <li>Close other apps/browser tabs</li>
                                    <li>Restart your device</li>
                                    <li>Clear browser cache (Settings ‚Üí Privacy)</li>
                                </ol>

                                <h3>üîï Not Getting Notifications</h3>
                                <ol style="line-height: 2;">
                                    <li>Check: Did you enable reminders on the item?</li>
                                    <li>Go to Profile ‚Üí Enable Notifications</li>
                                    <li>Allow when browser asks for permission</li>
                                    <li>On iPhone: Must use "Add to Home Screen" first</li>
                                    <li>Check phone's notification settings (System Settings)</li>
                                </ol>

                                <h3>üîä Voice Not Working</h3>
                                <ol style="line-height: 2;">
                                    <li>Make sure Voice Assistant is ON in Profile</li>
                                    <li>Allow microphone access when browser asks</li>
                                    <li>Check microphone isn't muted on device</li>
                                    <li>Try closing and reopening the app</li>
                                    <li>Speak clearly near the microphone</li>
                                </ol>

                                <h3>üì± Can't See All My Data</h3>
                                <ol style="line-height: 2;">
                                    <li>Check if items are minimized (‚ñº arrow)</li>
                                    <li>Click ‚ñº to expand them</li>
                                    <li>Scroll down - more items might be below</li>
                                    <li>Check you're on the right tab (Meds, Appts, etc.)</li>
                                </ol>

                                <h3>üîë Can't Log In</h3>
                                <ol style="line-height: 2;">
                                    <li>Check username and password are correct</li>
                                    <li>Username is case-sensitive (John ‚â† john)</li>
                                    <li>Use "Forgot Password?" if needed</li>
                                    <li>Try refreshing the page</li>
                                </ol>

                                <h3>üíæ Lost My Data</h3>
                                <p>Data is saved locally on your device. If you:</p>
                                <ul style="line-height: 2;">
                                    <li><strong>Cleared browser data:</strong> Data may be gone üòû</li>
                                    <li><strong>Have a backup file:</strong> Go to Profile ‚Üí Import Data</li>
                                    <li><strong>Used different device:</strong> Data doesn't sync between devices</li>
                                </ul>
                                <p><strong>Prevention:</strong> Export data monthly and save the backup file!</p>

                                <h3>üÜò Still Need Help?</h3>
                                <p>If these solutions don't work:</p>
                                <ol style="line-height: 2;">
                                    <li>Try using the app in a different browser</li>
                                    <li>Make sure your browser is up to date</li>
                                    <li>Note what you were trying to do when the problem occurred</li>
                                    <li>Use the search box at the top of this Help page</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile" class="section">
                <h2 class="section-title">üë§ Profile</h2>
                
                <div class="card">
                    <div class="card-header">Personal Information</div>
                    <div class="card-content" id="profileInfo"></div>
                </div>

                <div class="card">
                    <div class="card-header">üîä Voice Settings</div>
                    <div class="card-content">
                        <h4 style="margin: 0 0 10px 0;">Voice Announcements</h4>
                        <p style="margin-bottom: 15px;">Enable voice announcements for confirmations and reminders</p>
                        <button id="voiceToggleBtn" class="btn" onclick="toggleVoice()" style="width: 100%; max-width: 100%; margin-bottom: 15px;">
                            üîá Voice OFF
                        </button>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e9ecef; margin-bottom: 20px;">
                            <label class="reminder-checkbox" style="margin: 0; cursor: pointer;">
                                <input type="checkbox" id="voiceAutoEnable" onchange="saveVoicePreference()" style="width: 20px; height: 20px; margin: 0;">
                                <span style="font-size: 15px;">üîÑ Always enable voice when I log in</span>
                            </label>
                            <p style="margin: 10px 0 0 30px; font-size: 13px; color: #6c757d;">
                                When checked, voice will automatically turn on each time you open the app
                            </p>
                        </div>

                        <hr style="margin: 20px 0; border: none; border-top: 2px solid #e9ecef;">

                        <h4 style="margin: 0 0 10px 0;">üé§ Voice Assistant</h4>
                        <p style="margin-bottom: 15px;">Use voice commands to control the app hands-free!</p>
                        
                        <button id="voiceAssistantToggleBtn" class="btn" onclick="toggleVoiceAssistant()" style="width: 100%; max-width: 100%; margin-bottom: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-size: 18px;">
                            üé§ Voice Assistant OFF
                        </button>

                        <div id="voiceAssistantInfo" class="hidden" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                            <p style="margin: 0 0 10px 0; font-weight: 600;">‚úÖ Voice Assistant is Active!</p>
                            <p style="margin: 0 0 10px 0; font-size: 14px;">Look for the üé§ VOICE button at the bottom-right of your screen.</p>
                            <p style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">Try saying:</p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>"Go to medications"</li>
                                <li>"Show my appointments"</li>
                                <li>"Help with reminders"</li>
                                <li>"How do I add a medication?"</li>
                            </ul>
                            <button class="btn btn-info" onclick="showHelpTopic('voice'); showSection('help');" style="width: 100%; margin-top: 10px;">
                                üìñ View Full Voice Commands Guide
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üîî Notification Settings</div>
                    <div class="card-content">
                        <p style="margin-bottom: 15px;">Enable push notifications to receive reminders even when the app is in the background</p>
                        
                        <button id="notificationToggleBtn" class="btn btn-primary" onclick="requestNotificationPermission()" style="width: 100%; max-width: 100%; margin-bottom: 15px;">
                            üîî Enable Notifications
                        </button>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107; margin-bottom: 15px;">
                            <p style="margin: 0; font-size: 14px; color: #856404;">
                                <strong>üì± iOS Users:</strong> For best results:
                            </p>
                            <ol style="margin: 10px 0 0 20px; font-size: 13px; color: #856404;">
                                <li>Tap the Share button (in Safari)</li>
                                <li>Select "Add to Home Screen"</li>
                                <li>Open the app from your home screen</li>
                                <li>Enable notifications when prompted</li>
                            </ol>
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #856404;">
                                <em>Note: iOS has limitations for web app notifications. They work best when the phone is unlocked.</em>
                            </p>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="testNotification()" style="width: 100%; max-width: 100%;">
                            üß™ Test Notification
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üíæ Data Management</div>
                    <div class="card-content">
                        <p style="margin-bottom: 15px;">Backup and restore your data</p>
                        
                        <div id="lastBackupInfo" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                            <strong>üìÖ Last Backup:</strong> <span id="lastBackupDate">Never</span>
                        </div>
                        
                        <button class="btn btn-success" onclick="exportData()" style="width: 100%; max-width: 100%; margin-bottom: 10px;">
                            üì• Export All Data
                        </button>
                        <p style="font-size: 13px; color: #6c757d; margin: 0 0 15px 0;">
                            Download a backup file with all your medications, appointments, tasks, and bills
                        </p>
                        
                        <button class="btn btn-info" onclick="document.getElementById('importFile').click()" style="width: 100%; max-width: 100%; margin-bottom: 10px;">
                            üì§ Import Data
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <p style="font-size: 13px; color: #6c757d; margin: 0 0 20px 0;">
                            Restore data from a previously exported backup file
                        </p>

                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107;">
                            <label class="reminder-checkbox" style="margin: 0 0 10px 0; cursor: pointer;">
                                <input type="checkbox" id="backupReminderEnabled" onchange="saveBackupReminderSettings()" style="width: 20px; height: 20px; margin: 0;">
                                <span style="font-size: 15px;">‚è∞ Remind me to backup regularly</span>
                            </label>
                            <div id="backupReminderOptions" class="hidden" style="margin-top: 10px;">
                                <label style="font-size: 14px; color: #495057; display: block; margin-bottom: 5px;">Remind me every:</label>
                                <select id="backupReminderDays" onchange="saveBackupReminderSettings()" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="3">3 days</option>
                                    <option value="7" selected>7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30">30 days</option>
                                </select>
                            </div>
                            <p style="margin: 10px 0 0 30px; font-size: 13px; color: #856404;">
                                Get reminded to backup your data regularly - protects against phone loss!
                            </p>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Update Profile</h3>
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" id="updateName">
                    </div>
                    <div class="input-group">
                        <label>Age</label>
                        <input type="number" id="updateAge">
                    </div>
                    <div class="input-group">
                        <label>Email Address</label>
                        <input type="email" id="updateEmail">
                        <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0 0;">üìß Used to send backup files to your inbox</p>
                    </div>
                    <button class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
                </div>

                <div class="form-section">
                    <h3>üîê Change Password</h3>
                    <div class="input-group">
                        <label>Current Password</label>
                        <div style="position: relative;">
                            <input type="password" id="currentPassword" placeholder="Enter current password" style="padding-right: 45px;">
                            <span class="password-toggle" onclick="togglePasswordVisibility('currentPassword', this)">
                                üëÅÔ∏è
                            </span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>New Password</label>
                        <div style="position: relative;">
                            <input type="password" id="newPassword" placeholder="Enter new password" style="padding-right: 45px;">
                            <span class="password-toggle" onclick="togglePasswordVisibility('newPassword', this)">
                                üëÅÔ∏è
                            </span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Confirm New Password</label>
                        <div style="position: relative;">
                            <input type="password" id="confirmNewPassword" placeholder="Re-enter new password" style="padding-right: 45px;">
                            <span class="password-toggle" onclick="togglePasswordVisibility('confirmNewPassword', this)">
                                üëÅÔ∏è
                            </span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
                </div>
                
                <!-- App Version Info -->
                <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <p style="font-size: 12px; color: #6c757d; margin: 0 0 5px 0;">
                        <strong>App Version:</strong> 2026-01-25-0052 UTC
                    </p>
                    <p style="font-size: 11px; color: #6c757d; margin: 0;">
                        ROLLBACK - Simple Voice Navigation Only
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Help Button (hidden until login) -->
    <div id="floatingHelpBtn" class="floating-help-btn hidden" onclick="showSection('help')" title="Get Help">
        <div style="font-size: 24px;">‚ùì</div>
        <div style="font-size: 10px; margin-top: 2px;">HELP</div>
    </div>

    <!-- Floating Voice Button (hidden by default) -->
    <div id="floatingVoiceBtn" class="floating-voice-btn hidden" onclick="startVoiceListening()" title="Voice Commands">
        <div id="voiceBtnIcon" style="font-size: 24px;">üé§</div>
        <div id="voiceBtnText" style="font-size: 10px; margin-top: 2px;">VOICE</div>
    </div>

    <!-- Voice Listening Overlay -->
    <div id="voiceListeningOverlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; color: white;">
        <div style="text-align: center; max-width: 90%; padding: 30px;">
            <div id="voiceStatusIcon" style="font-size: 80px; margin-bottom: 20px;">üé§</div>
            <div id="voiceStatusText" style="font-size: 24px; font-weight: 600; margin-bottom: 10px;">Listening...</div>
            <div id="voiceTranscript" style="font-size: 18px; margin-bottom: 20px; min-height: 30px; color: #a0aec0;">Speak now...</div>
            <button onclick="stopVoiceListening()" class="btn" style="background: white; color: #333; padding: 15px 30px; font-size: 18px;">
                Cancel
            </button>
        </div>
    </div>

    <style>
        .floating-help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            border: 3px solid white;
        }

        .floating-help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .floating-voice-btn {
            position: fixed;
            bottom: 110px;
            right: 20px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(56, 178, 172, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            border: 3px solid white;
        }

        .floating-voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(56, 178, 172, 0.6);
        }

        .floating-voice-btn.listening {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .help-topic-section {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script>
        // PWA Installation
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.remove('hidden');
        });

        document.getElementById('installButton').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
                hideInstallBanner();
            }
        });

        function hideInstallBanner() {
            document.getElementById('installBanner').classList.add('hidden');
        }

        // Service Worker Registration - DISABLED FOR STANDALONE VERSION
        // This version doesn't need external files!
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('SW registered:', registration))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
        */

        // Global variables
        let currentUser = null;
        let voiceEnabled = false;
        let notificationsEnabled = false; // Track if push notifications are enabled
        let serviceWorkerRegistration = null; // Store service worker registration
        let pendingDeleteCategory = null;
        let pendingDeleteIndex = null;
        let pendingDeleteMedicationId = null;
        let pendingDeleteAppointmentId = null;
        let pendingDeleteBillId = null;
        let editingMedicationId = null; // Track which medication is being edited
        let editingAppointmentId = null; // Track which appointment is being edited
        let editingTaskCategory = null; // Track which task category is being edited
        let editingTaskIndex = null; // Track which task index is being edited
        let editingBillId = null; // Track which bill is being edited
        let reminderCheckInterval = null;
        let currentReminderItem = null;
        let shownReminders = new Set(); // Track which reminders we've already shown today

        // Service Worker & Notification Setup
        async function initializeNotifications() {
            // Check if browser supports notifications
            if (!('Notification' in window)) {
                console.log('This browser does not support notifications');
                return;
            }

            // Register service worker for push notifications
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('‚úÖ Service Worker registered - Push notifications enabled');
                    
                    // Check notification permission status
                    if (Notification.permission === 'granted') {
                        notificationsEnabled = true;
                        console.log('‚úÖ Notifications already enabled');
                    }
                } catch (error) {
                    // Service worker failed to register (file might not be deployed)
                    // App works fine without it - notifications just won't be available
                    console.log('‚ÑπÔ∏è Service Worker not available - Push notifications disabled');
                    console.log('   To enable push notifications, upload service-worker.js to your server');
                }
            }
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('‚ùå Notifications Not Supported\n\nYour browser does not support notifications.');
                return false;
            }

            // Check current permission
            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                return true;
            }

            if (Notification.permission === 'denied') {
                alert('‚ùå Notifications Blocked\n\nYou previously blocked notifications.\n\nTo enable:\n1. Go to your browser settings\n2. Find this site\n3. Enable notifications\n4. Refresh the page');
                return false;
            }

            // Request permission
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    alert('‚úÖ Notifications Enabled!\n\nYou will now receive reminder notifications.\n\nüì± iOS Users: For best results, "Add to Home Screen" from Safari share menu.');
                    speak('Notifications enabled');
                    return true;
                } else {
                    alert('‚ö†Ô∏è Notifications Not Enabled\n\nYou can enable them later in your browser settings.');
                    return false;
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                return false;
            }
        }

        // Show notification
        function showNotification(title, body, tag) {
            if (!notificationsEnabled || Notification.permission !== 'granted') {
                console.log('Notifications not enabled or permission not granted');
                return;
            }

            // Check if service worker is available
            if (serviceWorkerRegistration) {
                // Use service worker to show notification (better for background)
                serviceWorkerRegistration.showNotification(title, {
                    body: body,
                    icon: '/icon-192.png', // We'll create this
                    badge: '/icon-72.png',
                    tag: tag || 'reminder',
                    requireInteraction: true, // Keeps notification visible
                    vibrate: [200, 100, 200], // Vibrate pattern
                    data: {
                        dateOfArrival: Date.now(),
                        primaryKey: tag
                    }
                });
            } else {
                // Fallback to regular notification
                new Notification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    tag: tag || 'reminder',
                    requireInteraction: true
                });
            }
        }

        // Test notification
        function testNotification() {
            if (!notificationsEnabled || Notification.permission !== 'granted') {
                alert('‚ö†Ô∏è Notifications Not Enabled\n\nPlease enable notifications first by clicking the "Enable Notifications" button above.');
                return;
            }

            showNotification(
                '‚úÖ Test Notification',
                'Great! Notifications are working. You will receive reminders like this one.',
                'test-notification'
            );
            
            speak('Test notification sent');
            alert('‚úÖ Notification Sent!\n\nCheck your notification center to see it.\n\nOn iPhone: Pull down from top\nOn Android: Pull down from top');
        }

        // Reminder System
        function startReminderChecker() {
            // Check for reminders every minute
            if (reminderCheckInterval) {
                clearInterval(reminderCheckInterval);
            }
            checkReminders(); // Check immediately
            reminderCheckInterval = setInterval(checkReminders, 60000); // Check every minute
        }

        function checkReminders() {
            if (!currentUser) return;
            
            const users = loadData('users');
            if (!users || !users[currentUser]) return;
            
            try {
                const userData = users[currentUser];
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const currentDate = now.toISOString().split('T')[0];
            
                // Check Medication Reminders
                if (userData.medications) {
                    userData.medications.forEach((med, index) => {
                        if (med.reminderEnabled && med.time && shouldTakeMedicationToday(med)) {
                            const reminderKey = `med-${med.id}-${currentDate}`;
                            if (!shownReminders.has(reminderKey)) {
                                // Calculate reminder time (10 minutes before medication time)
                                const [hours, minutes] = med.time.split(':').map(Number);
                                const medTime = new Date();
                                medTime.setHours(hours, minutes, 0, 0);
                                const reminderTime = new Date(medTime.getTime() - (med.reminderMinutes || 10) * 60000);
                                const reminderTimeStr = `${String(reminderTime.getHours()).padStart(2, '0')}:${String(reminderTime.getMinutes()).padStart(2, '0')}`;
                                
                                if (currentTime === reminderTimeStr) {
                                    showReminderAlert('Medication Reminder', `Time to take: ${med.name} (${med.dosage})`, 'medication', med.id);
                                    shownReminders.add(reminderKey);
                                }
                            }
                        }
                    });
                }
                
                // Check Appointment Reminders
                if (userData.appointments) {
                    userData.appointments.forEach((appt, index) => {
                        if (appt.reminderEnabled && !appt.completed) {
                            const apptDateTime = new Date(appt.date + ' ' + appt.time);
                            const reminderMinutes = appt.reminderMinutes || 60; // Default 1 hour before
                            const reminderTime = new Date(apptDateTime.getTime() - reminderMinutes * 60000);
                            const reminderKey = `appt-${appt.id}-${currentDate}`;
                            
                            if (!shownReminders.has(reminderKey) && now >= reminderTime && now < apptDateTime) {
                                showReminderAlert('Appointment Reminder', `Appointment with ${appt.doctor} at ${formatTime(appt.time)}`, 'appointment', appt.id);
                                shownReminders.add(reminderKey);
                            }
                        }
                    });
                }
                
                // Check Task Reminders
                ['meals', 'hydration', 'hygiene', 'safety'].forEach(category => {
                    if (userData.tasks && userData.tasks[category]) {
                        userData.tasks[category].forEach((task, index) => {
                            if (task.reminderEnabled && task.time && shouldShowTaskToday(task) && !task.completed) {
                                const reminderKey = `task-${category}-${index}-${currentDate}`;
                                if (!shownReminders.has(reminderKey)) {
                                    const [hours, minutes] = task.time.split(':').map(Number);
                                    const taskTime = new Date();
                                    taskTime.setHours(hours, minutes, 0, 0);
                                    const reminderTime = new Date(taskTime.getTime() - (task.reminderMinutes || 10) * 60000);
                                    const reminderTimeStr = `${String(reminderTime.getHours()).padStart(2, '0')}:${String(reminderTime.getMinutes()).padStart(2, '0')}`;
                                    
                                    if (currentTime === reminderTimeStr) {
                                        showReminderAlert('Task Reminder', `${task.name}`, 'task', {category, index});
                                        shownReminders.add(reminderKey);
                                    }
                                }
                            }
                        });
                    }
                });
                
                // Check Bill Reminders
                if (userData.bills) {
                    userData.bills.forEach((bill, index) => {
                        if (bill.reminderEnabled && !bill.paid) {
                            const dueDate = parseLocalDate(bill.dueDate);
                            const reminderDays = bill.reminderDays || 3; // Default 3 days before
                            const reminderDate = new Date(dueDate.getTime() - reminderDays * 24 * 60 * 60 * 1000);
                            const reminderKey = `bill-${bill.id}-${currentDate}`;
                            
                            if (!shownReminders.has(reminderKey) && now >= reminderDate && now < dueDate) {
                                const daysUntilDue = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                                showReminderAlert('Bill Reminder', `${bill.name} is due in ${daysUntilDue} day${daysUntilDue !== 1 ? 's' : ''} ($${bill.amount.toFixed(2)})`, 'bill', bill.id);
                                shownReminders.add(reminderKey);
                            }
                        }
                    });
                }
                
                // Check Activity Reminders
                if (userData.activities) {
                    userData.activities.forEach((activity, index) => {
                        if (activity.reminderEnabled && shouldShowActivityToday(activity)) {
                            const todayStr = new Date().toISOString().split('T')[0];
                            const hasAttendedToday = activity.attended && activity.attended.includes(todayStr);
                            
                            if (!hasAttendedToday) {
                                const reminderKey = `activity-${activity.id}-${currentDate}`;
                                if (!shownReminders.has(reminderKey)) {
                                    // Calculate reminder time
                                    const [hours, minutes] = activity.time.split(':').map(Number);
                                    const activityTime = new Date();
                                    activityTime.setHours(hours, minutes, 0, 0);
                                    const reminderTime = new Date(activityTime.getTime() - (activity.reminderMinutes || 30) * 60000);
                                    const reminderTimeStr = `${String(reminderTime.getHours()).padStart(2, '0')}:${String(reminderTime.getMinutes()).padStart(2, '0')}`;
                                    
                                    if (currentTime === reminderTimeStr) {
                                        showReminderAlert('Activity Reminder', `${activity.name} at ${activity.location} (${formatTime(activity.time)})`, 'activity', activity.id);
                                        shownReminders.add(reminderKey);
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Update home reminders display
                loadHomeReminders();
            } catch (error) {
                console.error('Error checking reminders:', error);
                // Silently fail - don't break the app
            }
        }

        function showReminderAlert(title, message, type, id) {
            currentReminderItem = {type, id};
            document.getElementById('reminderAlertTitle').textContent = title;
            document.getElementById('reminderAlertText').textContent = message;
            document.getElementById('reminderAlert').classList.remove('hidden');
            speak(title + ': ' + message);
            
            // Send push notification
            const tag = `${type}-${typeof id === 'object' ? JSON.stringify(id) : id}`;
            showNotification(title, message, tag);
        }

        function dismissReminder() {
            document.getElementById('reminderAlert').classList.add('hidden');
            currentReminderItem = null;
        }

        function snoozeReminder() {
            if (currentReminderItem) {
                const {type, id} = currentReminderItem;
                // Remove from shown reminders so it can show again in 10 minutes
                const now = new Date();
                const currentDate = now.toISOString().split('T')[0];
                let reminderKey = '';
                
                if (type === 'medication') reminderKey = `med-${id}-${currentDate}`;
                else if (type === 'appointment') reminderKey = `appt-${id}-${currentDate}`;
                else if (type === 'task') reminderKey = `task-${id.category}-${id.index}-${currentDate}`;
                else if (type === 'bill') reminderKey = `bill-${id}-${currentDate}`;
                
                shownReminders.delete(reminderKey);
                speak('Reminder snoozed for 10 minutes');
            }
            dismissReminder();
        }

        function loadHomeReminders() {
            const container = document.getElementById('homeReminders');
            if (!container) return;
            
            const users = loadData('users');
            if (!users || !users[currentUser]) {
                container.innerHTML = '';
                return;
            }
            
            const userData = users[currentUser];
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            let activeReminders = [];
            
            // Collect all active reminders for today
            // Medications
            if (userData.medications) {
                userData.medications.forEach(med => {
                    if (med.reminderEnabled && med.time && shouldTakeMedicationToday(med) && !wasTakenToday(med)) {
                        activeReminders.push({
                            type: 'üíä',
                            text: `${med.name} at ${formatTime(med.time)}`,
                            time: med.time
                        });
                    }
                });
            }
            
            // Appointments
            if (userData.appointments) {
                userData.appointments.forEach(appt => {
                    if (appt.reminderEnabled && !appt.completed && appt.date === today) {
                        activeReminders.push({
                            type: 'üìÖ',
                            text: `${appt.doctor} at ${formatTime(appt.time)}`,
                            time: appt.time
                        });
                    }
                });
            }
            
            // Tasks
            ['meals', 'hydration', 'hygiene', 'safety'].forEach(category => {
                if (userData.tasks && userData.tasks[category]) {
                    userData.tasks[category].forEach(task => {
                        if (task.reminderEnabled && task.time && shouldShowTaskToday(task) && !task.completed) {
                            activeReminders.push({
                                type: '‚úÖ',
                                text: task.name + (task.time ? ` at ${formatTime(task.time)}` : ''),
                                time: task.time || '23:59'
                            });
                        }
                    });
                }
            });
            
            // Bills (due within 7 days)
            if (userData.bills) {
                userData.bills.forEach(bill => {
                    if (bill.reminderEnabled && !bill.paid) {
                        const dueDate = parseLocalDate(bill.dueDate);
                        const daysUntilDue = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                        if (daysUntilDue >= 0 && daysUntilDue <= 7) {
                            activeReminders.push({
                                type: 'üí∞',
                                text: `${bill.name} due in ${daysUntilDue} day${daysUntilDue !== 1 ? 's' : ''}`,
                                time: '23:59'
                            });
                        }
                    }
                });
            }
            
            // Sort by time
            activeReminders.sort((a, b) => a.time.localeCompare(b.time));
            
            // Display reminders
            if (activeReminders.length > 0) {
                let html = '<div class="reminder-card"><h3>üîî Today\'s Reminders</h3>';
                activeReminders.slice(0, 5).forEach(reminder => {
                    html += `<div class="reminder-item">
                        <span class="reminder-item-text">${reminder.type} ${reminder.text}</span>
                    </div>`;
                });
                if (activeReminders.length > 5) {
                    html += `<div class="reminder-item">
                        <span class="reminder-item-text">...and ${activeReminders.length - 5} more</span>
                    </div>`;
                }
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '';
            }
        }

        // Initialize default tasks
        const defaultTasks = {
            meals: [
                { name: 'Breakfast', time: '08:00', completed: false, recurrence: 'daily' },
                { name: 'Lunch', time: '12:00', completed: false, recurrence: 'daily' },
                { name: 'Dinner', time: '18:00', completed: false, recurrence: 'daily' }
            ],
            hydration: [
                { name: 'Morning Water (8oz)', time: '09:00', completed: false, recurrence: 'daily' },
                { name: 'Afternoon Water (8oz)', time: '14:00', completed: false, recurrence: 'daily' },
                { name: 'Evening Water (8oz)', time: '19:00', completed: false, recurrence: 'daily' }
            ],
            hygiene: [
                { name: 'Morning Routine', time: '07:00', completed: false, recurrence: 'daily' },
                { name: 'Brush Teeth', time: '20:00', completed: false, recurrence: 'daily' }
            ],
            safety: [
                { name: 'Check floor for tripping hazards', time: '', completed: false, recurrence: 'daily' },
                { name: 'Ensure proper lighting in all rooms', time: '', completed: false, recurrence: 'daily' },
                { name: 'Monitor room temperature (68-72¬∞F)', time: '', completed: false, recurrence: 'daily' },
                { name: 'Check that emergency numbers are accessible', time: '', completed: false, recurrence: 'daily' },
                { name: 'Verify smoke detector batteries', time: '', completed: false, recurrence: 'daily' }
            ]
        };

        const defaultSafetyChecks = [
            'Check floor for tripping hazards',
            'Ensure proper lighting in all rooms',
            'Monitor room temperature (68-72¬∞F)',
            'Check that emergency numbers are accessible',
            'Verify smoke detector batteries'
        ];

        // Voice function
        function speak(text) {
            if (voiceEnabled && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
            }
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const btn = document.getElementById('voiceToggleBtn');
            if (btn) {
                if (voiceEnabled) {
                    btn.textContent = 'üîä Voice ON';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    speak('Voice assistance enabled');
                } else {
                    btn.textContent = 'üîá Voice OFF';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                }
            }
        }

        function saveVoicePreference() {
            const autoEnable = document.getElementById('voiceAutoEnable').checked;
            const users = loadData('users');
            if (users && users[currentUser]) {
                users[currentUser].voiceAutoEnable = autoEnable;
                saveData('users', users);
                
                if (autoEnable) {
                    speak('Voice will automatically enable when you log in');
                } else {
                    speak('Voice auto-enable disabled');
                }
            }
        }

        function loadVoicePreference() {
            const users = loadData('users');
            if (users && users[currentUser]) {
                const autoEnable = users[currentUser].voiceAutoEnable || false;
                
                // Set checkbox state
                const checkbox = document.getElementById('voiceAutoEnable');
                if (checkbox) {
                    checkbox.checked = autoEnable;
                }
                
                // Auto-enable voice if preference is set
                if (autoEnable && !voiceEnabled) {
                    voiceEnabled = true;
                    const btn = document.getElementById('voiceToggleBtn');
                    if (btn) {
                        btn.textContent = 'üîä Voice ON';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-success');
                    }
                }
            }
        }

        // Storage functions
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        // Authentication
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('forgotPasswordScreen').classList.add('hidden');
            document.getElementById('resetPasswordScreen').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function register() {
            const name = document.getElementById('regName').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const age = document.getElementById('regAge').value;
            const email = document.getElementById('regEmail').value;

            if (!name || !username || !password || !age || !email) {
                alert('Please fill in all fields');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            const users = loadData('users') || {};
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }

            users[username] = {
                name: name,
                password: password,
                age: age,
                email: email,
                medications: [],
                appointments: [],
                tasks: JSON.parse(JSON.stringify(defaultTasks)),
                bills: [],
                activities: [],
                contacts: []
            };

            saveData('users', users);
            alert('Account created successfully!');
            speak('Account created successfully');
            showLogin();
        }

        function togglePasswordVisibility(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.textContent = 'üôà'; // Closed eye when password is visible
                iconElement.classList.add('visible');
            } else {
                input.type = 'password';
                iconElement.textContent = 'üëÅÔ∏è'; // Open eye when password is hidden
                iconElement.classList.remove('visible');
            }
        }


        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }

            const users = loadData('users') || {};
            
            if (!users[username] || users[username].password !== password) {
                alert('Invalid username or password');
                return;
            }

            currentUser = username;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = users[username].name;
            
            // Show floating help button (now that user is logged in)
            document.getElementById('floatingHelpBtn').classList.remove('hidden');
            
            // Initialize voice button
            const voiceBtn = document.getElementById('voiceToggleBtn');
            if (voiceBtn) {
                voiceBtn.textContent = 'üîá Voice OFF';
                voiceBtn.classList.add('btn-primary');
            }
            
            loadAllData();
            loadVoicePreference(); // Load user's voice preference
            initializeNotifications(); // Initialize notification system
            speak(`Welcome back, ${users[username].name}`);
            startReminderChecker(); // Start checking for reminders
            
            // Check if backup reminder is due (after a short delay to let app load)
            setTimeout(() => {
                checkBackupReminder();
            }, 3000);
        }

        function logout() {
            currentUser = null;
            voiceEnabled = false;
            if (reminderCheckInterval) {
                clearInterval(reminderCheckInterval); // Stop reminder checker
                reminderCheckInterval = null;
            }
            shownReminders.clear(); // Clear shown reminders
            
            // Hide floating buttons on logout
            document.getElementById('floatingHelpBtn').classList.add('hidden');
            document.getElementById('floatingVoiceBtn').classList.add('hidden');
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            speak('Logged out successfully');
        }

        // Forgot Password Functions
        let resetUsername = null; // Store username during password reset

        function showForgotPassword() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('forgotPasswordScreen').classList.remove('hidden');
            document.getElementById('resetPasswordScreen').classList.add('hidden');
        }

        function verifyForgotPassword() {
            const username = document.getElementById('forgotUsername').value;
            const email = document.getElementById('forgotEmail').value;

            if (!username || !email) {
                alert('Please enter both username and email');
                return;
            }

            const users = loadData('users') || {};
            
            // Check if username exists
            if (!users[username]) {
                alert('Username not found');
                return;
            }

            // Check if email matches
            if (users[username].email !== email) {
                alert('Email does not match our records');
                return;
            }

            // Username and email verified! Allow password reset
            resetUsername = username;
            document.getElementById('forgotPasswordScreen').classList.add('hidden');
            document.getElementById('resetPasswordScreen').classList.remove('hidden');
            speak('Identity verified. Please set a new password.');
        }

        function completePasswordReset() {
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in both password fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (newPassword.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            // Update password
            const users = loadData('users');
            users[resetUsername].password = newPassword;
            saveData('users', users);

            // Clear fields
            document.getElementById('forgotUsername').value = '';
            document.getElementById('forgotEmail').value = '';
            document.getElementById('resetNewPassword').value = '';
            document.getElementById('resetConfirmPassword').value = '';
            resetUsername = null;

            // Show login screen
            document.getElementById('resetPasswordScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');

            alert('‚úÖ Password reset successfully!\n\nYou can now login with your new password.');
            speak('Password reset successfully');
        }

        // Change Password in Profile
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            const users = loadData('users');
            
            // Verify current password
            if (users[currentUser].password !== currentPassword) {
                alert('Current password is incorrect');
                return;
            }

            // Verify new passwords match
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            // Check password length
            if (newPassword.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            // Don't allow same password
            if (newPassword === currentPassword) {
                alert('New password must be different from current password');
                return;
            }

            // Update password
            users[currentUser].password = newPassword;
            saveData('users', users);

            // Clear fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';

            alert('‚úÖ Password changed successfully!');
            speak('Password changed successfully');
        }

        // Load all data
        function loadAllData() {
            const users = loadData('users');
            if (!users || !users[currentUser]) return;

            const userData = users[currentUser];
            
            // Migrate legacy medications to new format
            if (userData.medications && userData.medications.length > 0) {
                let needsSave = false;
                userData.medications.forEach(med => {
                    // Add recurrence if missing
                    if (!med.recurrence) {
                        med.recurrence = 'daily';
                        needsSave = true;
                    }
                    // Convert old 'taken' property to 'takenDates'
                    if (med.taken !== undefined && !med.takenDates) {
                        med.takenDates = [];
                        if (med.taken) {
                            const todayDate = new Date().toISOString().split('T')[0];
                            med.takenDates.push(todayDate);
                        }
                        delete med.taken;
                        needsSave = true;
                    }
                    // Initialize takenDates if missing
                    if (!med.takenDates) {
                        med.takenDates = [];
                        needsSave = true;
                    }
                });
                
                if (needsSave) {
                    saveData('users', users);
                }
            }

            // Migrate old safetyChecks to safety tasks
            if (userData.safetyChecks && !userData.tasks.safety) {
                userData.tasks.safety = userData.safetyChecks.map(check => ({
                    name: check.text || check,
                    time: '',
                    completed: check.completed || false,
                    recurrence: 'daily'
                }));
                delete userData.safetyChecks;
                saveData('users', users);
            }

            // Add safety category if missing
            if (!userData.tasks.safety) {
                userData.tasks.safety = defaultTasks.safety;
                saveData('users', users);
            }

            // Add recurrence to legacy tasks
            let tasksSaved = false;
            ['meals', 'hydration', 'hygiene', 'safety'].forEach(category => {
                if (userData.tasks[category]) {
                    userData.tasks[category].forEach(task => {
                        if (!task.recurrence) {
                            task.recurrence = 'daily';
                            tasksSaved = true;
                        }
                    });
                }
            });
            if (tasksSaved) {
                saveData('users', users);
            }
            
            loadMedications(userData.medications || []);
            loadAppointments(userData.appointments || []);
            loadTasks(userData.tasks || defaultTasks);
            loadBills(userData.bills || []);
            loadActivities(userData.activities || []);
            loadContacts(userData.contacts || []);
            loadProfile(userData);
            updateDashboard();
            loadHomeReminders();
        }

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const section = document.getElementById(sectionName);
            if (section) {
                section.classList.add('active');
                section.classList.add('fade-in');
            }
            
            // Find and activate the corresponding tab
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if (tab.textContent.toLowerCase().includes(sectionName.split('-')[0])) {
                    tab.classList.add('active');
                }
            });
            
            // Simplified voice announcements - just say the section name
            const sectionNames = {
                'home': 'Home',
                'medications': 'Medications',
                'appointments': 'Appointments',
                'tasks': 'Tasks',
                'bills': 'Bills',
                'contacts': 'Contacts',
                'profile': 'Profile'
            };
            
            speak(sectionNames[sectionName] || sectionName);
        }

        // Medication helper functions
        function getRecurrenceText(med) {
            // Handle legacy medications without recurrence property
            if (!med.recurrence || med.recurrence === 'daily') {
                return 'daily';
            } else if (med.recurrence === 'specific-days' && med.specificDays) {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return med.specificDays.map(d => dayNames[d]).join(', ');
            } else if (med.recurrence === 'every-x-days' && med.everyXDays) {
                return `every ${med.everyXDays} days`;
            } else if (med.recurrence === 'weekly' && med.weeklyDay !== undefined) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return `weekly on ${dayNames[med.weeklyDay]}`;
            }
            return 'daily';
        }

        function shouldTakeMedicationToday(med) {
            // Handle legacy medications without recurrence property (default to daily)
            if (!med.recurrence || med.recurrence === 'daily') {
                return true;
            }

            const today = new Date();
            const todayDay = today.getDay(); // 0 = Sunday, 6 = Saturday
            
            if (med.recurrence === 'specific-days' && med.specificDays) {
                return med.specificDays.includes(todayDay);
            } else if (med.recurrence === 'every-x-days' && med.everyXDays && med.startDate) {
                const startDate = new Date(med.startDate);
                const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                return daysDiff % med.everyXDays === 0;
            } else if (med.recurrence === 'weekly' && med.weeklyDay !== undefined) {
                return todayDay === med.weeklyDay;
            }
            
            // Default to true for any unexpected cases
            return true;
        }

        function wasTakenToday(med) {
            // Handle legacy medications with old 'taken' property
            if (med.taken !== undefined && !med.takenDates) {
                return med.taken;
            }
            
            const todayDate = new Date().toISOString().split('T')[0];
            return med.takenDates && med.takenDates.includes(todayDate);
        }

        // Medications
        function updateRecurrenceOptions() {
            const recurrence = document.getElementById('medRecurrence').value;
            document.getElementById('specificDaysContainer').classList.add('hidden');
            document.getElementById('everyXDaysContainer').classList.add('hidden');
            document.getElementById('weeklyDayContainer').classList.add('hidden');

            if (recurrence === 'specific-days') {
                document.getElementById('specificDaysContainer').classList.remove('hidden');
            } else if (recurrence === 'every-x-days') {
                document.getElementById('everyXDaysContainer').classList.remove('hidden');
            } else if (recurrence === 'weekly') {
                document.getElementById('weeklyDayContainer').classList.remove('hidden');
            }
        }

        function addMedication() {
            const name = document.getElementById('medName').value;
            const dosage = document.getElementById('medDosage').value;
            const time = document.getElementById('medTime').value;
            const recurrence = document.getElementById('medRecurrence').value;

            if (!name || !dosage || !time) {
                alert('Please fill in all fields');
                return;
            }

            const users = loadData('users');
            
            // Check if we're editing or adding
            if (editingMedicationId !== null) {
                // EDITING MODE - Update existing medication
                const medIndex = users[currentUser].medications.findIndex(m => m.id === editingMedicationId);
                if (medIndex !== -1) {
                    const existingMed = users[currentUser].medications[medIndex];
                    
                    // Keep the existing ID and takenDates
                    const medication = {
                        id: existingMed.id,
                        name: name,
                        dosage: dosage,
                        time: time,
                        recurrence: recurrence,
                        takenDates: existingMed.takenDates || [],
                        reminderEnabled: document.getElementById('medReminderEnabled').checked,
                        reminderMinutes: parseInt(document.getElementById('medReminderMinutes').value) || 10
                    };

                    // Handle specific recurrence options
                    if (recurrence === 'specific-days') {
                        const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                            .map(cb => parseInt(cb.value));
                        if (selectedDays.length === 0) {
                            alert('Please select at least one day of the week');
                            return;
                        }
                        medication.specificDays = selectedDays;
                    } else if (recurrence === 'every-x-days') {
                        const everyXDays = parseInt(document.getElementById('medEveryXDays').value);
                        if (!everyXDays || everyXDays < 2) {
                            alert('Please enter a valid number of days (2 or more)');
                            return;
                        }
                        medication.everyXDays = everyXDays;
                        medication.startDate = existingMed.startDate || new Date().toISOString().split('T')[0];
                    } else if (recurrence === 'weekly') {
                        medication.weeklyDay = parseInt(document.getElementById('medWeeklyDay').value);
                    }

                    users[currentUser].medications[medIndex] = medication;
                    saveData('users', users);
                    speak(`Updated medication ${name}`);
                }
                
                // Reset editing mode
                editingMedicationId = null;
                document.getElementById('addMedBtn').textContent = 'Add Medication';
                document.getElementById('cancelEditMedBtn').classList.add('hidden');
                
            } else {
                // ADDING MODE - Create new medication
                
                // Check for duplicates
                const existingMeds = users[currentUser].medications || [];
                
                // Check for EXACT duplicate (name + dosage + time all match)
                const exactDuplicate = existingMeds.find(med =>
                    med.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    med.dosage.toLowerCase().trim() === dosage.toLowerCase().trim() &&
                    med.time === time
                );
                
                if (exactDuplicate) {
                    alert('‚ùå Duplicate Medication\n\n' +
                          'This medication already exists:\n\n' +
                          `Name: ${exactDuplicate.name}\n` +
                          `Dosage: ${exactDuplicate.dosage}\n` +
                          `Time: ${formatTime(exactDuplicate.time)}\n\n` +
                          'Cannot add duplicate medication.');
                    speak('This medication already exists');
                    return;
                }
                
                // Check for SAME NAME but different dosage or time
                const sameMedName = existingMeds.find(med =>
                    med.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    (med.dosage.toLowerCase().trim() !== dosage.toLowerCase().trim() || med.time !== time)
                );
                
                if (sameMedName) {
                    const userConfirmed = confirm(
                        `‚ö†Ô∏è Medication Name Already Exists\n\n` +
                        `A medication named "${sameMedName.name}" already exists:\n\n` +
                        `Existing: ${sameMedName.dosage} at ${formatTime(sameMedName.time)}\n` +
                        `New: ${dosage} at ${formatTime(time)}\n\n` +
                        `This might be:\n` +
                        `‚Ä¢ Dosage change or adjustment\n` +
                        `‚Ä¢ Same medication taken at different times\n` +
                        `‚Ä¢ Accidentally creating a duplicate\n\n` +
                        `Do you want to add this medication anyway?`
                    );
                    
                    if (!userConfirmed) {
                        speak('Medication not added');
                        return;
                    }
                }
                
                const medication = {
                    id: Date.now(),
                    name: name,
                    dosage: dosage,
                    time: time,
                    recurrence: recurrence,
                    takenDates: [],
                    reminderEnabled: document.getElementById('medReminderEnabled').checked,
                    reminderMinutes: parseInt(document.getElementById('medReminderMinutes').value) || 10
                };

                // Handle specific recurrence options
                if (recurrence === 'specific-days') {
                    const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedDays.length === 0) {
                        alert('Please select at least one day of the week');
                        return;
                    }
                    medication.specificDays = selectedDays;
                } else if (recurrence === 'every-x-days') {
                    const everyXDays = parseInt(document.getElementById('medEveryXDays').value);
                    if (!everyXDays || everyXDays < 2) {
                        alert('Please enter a valid number of days (2 or more)');
                        return;
                    }
                    medication.everyXDays = everyXDays;
                    medication.startDate = new Date().toISOString().split('T')[0];
                } else if (recurrence === 'weekly') {
                    medication.weeklyDay = parseInt(document.getElementById('medWeeklyDay').value);
                }

                users[currentUser].medications.push(medication);
                saveData('users', users);
                speak(`Added medication ${name} with ${getRecurrenceText(medication)} schedule`);
            }

            // Clear form
            document.getElementById('medName').value = '';
            document.getElementById('medDosage').value = '';
            document.getElementById('medTime').value = '';
            document.getElementById('medRecurrence').value = 'daily';
            document.getElementById('medReminderEnabled').checked = false;
            document.getElementById('medReminderMinutes').value = '10';
            document.getElementById('medReminderOptions').classList.add('hidden');
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('medEveryXDays').value = '2';
            updateRecurrenceOptions();

            loadMedications(users[currentUser].medications);
            updateDashboard();
            loadHomeReminders();
        }

        function editMedication(medId) {
            const users = loadData('users');
            const medication = users[currentUser].medications.find(m => m.id === medId);
            
            if (!medication) {
                alert('Medication not found');
                return;
            }

            // Set editing mode
            editingMedicationId = medId;
            
            // Populate form
            document.getElementById('medName').value = medication.name;
            document.getElementById('medDosage').value = medication.dosage;
            document.getElementById('medTime').value = medication.time;
            document.getElementById('medRecurrence').value = medication.recurrence;
            document.getElementById('medReminderEnabled').checked = medication.reminderEnabled || false;
            document.getElementById('medReminderMinutes').value = medication.reminderMinutes || 10;
            
            // Show/hide reminder options
            if (medication.reminderEnabled) {
                document.getElementById('medReminderOptions').classList.remove('hidden');
            } else {
                document.getElementById('medReminderOptions').classList.add('hidden');
            }
            
            // Update recurrence options
            updateRecurrenceOptions();
            
            // Handle specific recurrence data
            if (medication.recurrence === 'specific-days' && medication.specificDays) {
                document.querySelectorAll('.day-checkbox').forEach(cb => {
                    cb.checked = medication.specificDays.includes(parseInt(cb.value));
                });
            } else if (medication.recurrence === 'every-x-days' && medication.everyXDays) {
                document.getElementById('medEveryXDays').value = medication.everyXDays;
            } else if (medication.recurrence === 'weekly' && medication.weeklyDay !== undefined) {
                document.getElementById('medWeeklyDay').value = medication.weeklyDay;
            }
            
            // Change button text and show cancel button
            document.getElementById('addMedBtn').textContent = 'Update Medication';
            document.getElementById('cancelEditMedBtn').classList.remove('hidden');
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            
            speak(`Editing medication ${medication.name}`);
        }

        function cancelEditMedication() {
            editingMedicationId = null;
            
            // Clear form
            document.getElementById('medName').value = '';
            document.getElementById('medDosage').value = '';
            document.getElementById('medTime').value = '';
            document.getElementById('medRecurrence').value = 'daily';
            document.getElementById('medReminderEnabled').checked = false;
            document.getElementById('medReminderMinutes').value = '10';
            document.getElementById('medReminderOptions').classList.add('hidden');
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('medEveryXDays').value = '2';
            updateRecurrenceOptions();
            
            // Reset button text and hide cancel button
            document.getElementById('addMedBtn').textContent = 'Add Medication';
            document.getElementById('cancelEditMedBtn').classList.add('hidden');
            
            speak('Editing cancelled');
        }

        // Make functions available globally
        window.editMedication = editMedication;

        function toggleMedReminderOptions() {
            const enabled = document.getElementById('medReminderEnabled').checked;
            const options = document.getElementById('medReminderOptions');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        function toggleApptReminderOptions() {
            const enabled = document.getElementById('apptReminderEnabled').checked;
            const options = document.getElementById('apptReminderOptions');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        function toggleTaskReminderOptions() {
            const enabled = document.getElementById('taskReminderEnabled').checked;
            const options = document.getElementById('taskReminderOptions');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        function toggleBillReminderOptions() {
            const enabled = document.getElementById('billReminderEnabled').checked;
            const options = document.getElementById('billReminderOptions');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        function loadMedications(medications) {
            const container = document.getElementById('medicationList');
            if (!container) {
                console.error('Medication list container not found');
                return;
            }
            
            container.innerHTML = '';

            if (!medications || medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No medications added yet</p>';
                return;
            }

            // Load minimized state from localStorage
            const minimizedMeds = JSON.parse(localStorage.getItem('minimizedMeds') || '{}');

            medications.sort((a, b) => a.time.localeCompare(b.time));

            medications.forEach(med => {
                try {
                    const shouldTakeToday = shouldTakeMedicationToday(med);
                    const takenToday = wasTakenToday(med);
                    const isMinimized = minimizedMeds[med.id] || false;
                    
                    const card = document.createElement('div');
                    card.className = 'card medication fade-in';
                    card.id = `med-card-${med.id}`;
                    
                    let scheduleInfo = '';
                    if (!shouldTakeToday) {
                        scheduleInfo = '<div style="background: #e2e8f0; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 15px;"><strong>üìÖ Not scheduled for today</strong></div>';
                    }

                    const reminderBadge = med.reminderEnabled ? ' üîî' : '';
                    const toggleIcon = isMinimized ? '‚ñº' : '‚ñ≤';

                    card.innerHTML = `
                        <div class="card-header" style="cursor: pointer; user-select: none;">
                            <div style="flex: 1;" onclick="toggleMedicationCard(${med.id})">
                                ${med.name}${reminderBadge}
                                <div style="font-size: 14px; color: #666; margin-top: 2px;">
                                    ${med.dosage} at ${formatTime(med.time)}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <button class="action-btn" onclick="toggleMedicationCard(${med.id})" 
                                        style="font-size: 18px; padding: 5px 12px; background: #e2e8f0; color: #333;"
                                        title="${isMinimized ? 'Expand' : 'Minimize'}">
                                    <span id="toggle-icon-${med.id}">${toggleIcon}</span>
                                </button>
                            </div>
                        </div>
                        <div id="med-details-${med.id}" class="med-details" style="${isMinimized ? 'display: none;' : ''}">
                            <div class="card-content">
                                <strong>Dosage:</strong> ${med.dosage}<br>
                                <strong>Schedule:</strong> ${getRecurrenceText(med)}${med.reminderEnabled ? '<br><strong>üîî Reminder:</strong> ' + med.reminderMinutes + ' min before' : ''}
                            </div>
                            <div class="card-time">‚è∞ ${formatTime(med.time)}</div>
                            ${scheduleInfo}
                            ${shouldTakeToday ? `
                                <button class="action-btn ${takenToday ? 'btn-success' : 'btn-info'}" 
                                        onclick="markMedicationTaken(${med.id})">
                                    ${takenToday ? '‚úì Taken Today' : 'Mark as Taken'}
                                </button>
                            ` : ''}
                            <div style="display: flex; gap: 5px; margin-top: 10px;">
                                <button class="action-btn btn-info" onclick="window.editMedication(${med.id})" style="font-size: 14px; flex: 1;">Edit</button>
                                <button class="action-btn btn-delete" onclick="window.deleteMedicationById(${med.id})" style="flex: 1;">Delete</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                } catch (error) {
                    console.error('Error loading medication:', med, error);
                }
            });
        }

        // Toggle medication card minimize/maximize
        function toggleMedicationCard(medId) {
            const detailsDiv = document.getElementById(`med-details-${medId}`);
            const toggleIcon = document.getElementById(`toggle-icon-${medId}`);
            
            if (!detailsDiv || !toggleIcon) return;
            
            const isMinimized = detailsDiv.style.display === 'none';
            
            // Toggle display
            detailsDiv.style.display = isMinimized ? '' : 'none';
            toggleIcon.textContent = isMinimized ? '‚ñ≤' : '‚ñº';
            
            // Save state to localStorage
            const minimizedMeds = JSON.parse(localStorage.getItem('minimizedMeds') || '{}');
            minimizedMeds[medId] = !isMinimized;
            localStorage.setItem('minimizedMeds', JSON.stringify(minimizedMeds));
            
            // Voice feedback
            speak(isMinimized ? 'Expanded' : 'Minimized');
        }

        // Make function globally accessible
        window.toggleMedicationCard = toggleMedicationCard;

        // Make medication delete function globally accessible
        window.deleteMedicationById = function(id) {
            console.log('Delete medication clicked:', id);
            const users = loadData('users');
            if (!users || !users[currentUser]) {
                console.error('No user data found');
                return;
            }
            
            const med = users[currentUser].medications.find(m => m.id === id);
            if (!med) {
                console.error('No medication found with id', id);
                return;
            }
            
            const medName = med.name;
            console.log('Attempting to delete medication:', medName);
            
            // Store the medication id for confirmation
            pendingDeleteMedicationId = id;
            
            // Show custom modal
            document.getElementById('deleteTaskText').textContent = 
                'Are you sure you want to delete "' + medName + '"?';
            document.getElementById('deleteTaskModal').classList.remove('hidden');
            console.log('Delete modal shown for medication');
        };

        function confirmDeleteTask() {
            console.log('Delete confirmed');
            document.getElementById('deleteTaskModal').classList.add('hidden');
            
            // Check if deleting a medication
            if (pendingDeleteMedicationId !== null) {
                console.log('Deleting medication with id:', pendingDeleteMedicationId);
                const users = loadData('users');
                const med = users[currentUser].medications.find(m => m.id === pendingDeleteMedicationId);
                if (!med) {
                    console.error('Medication not found');
                    pendingDeleteMedicationId = null;
                    return;
                }
                const medName = med.name;
                
                users[currentUser].medications = users[currentUser].medications.filter(m => m.id !== pendingDeleteMedicationId);
                saveData('users', users);
                
                console.log('Reloading medications...');
                loadMedications(users[currentUser].medications);
                updateDashboard();
                loadHomeReminders();
                speak('Medication deleted: ' + medName);
                
                pendingDeleteMedicationId = null;
                console.log('Done!');
                return; // Exit after medication delete
            }
            
            // Check if deleting an appointment
            if (pendingDeleteAppointmentId !== null) {
                console.log('Deleting appointment with id:', pendingDeleteAppointmentId);
                const users = loadData('users');
                const appt = users[currentUser].appointments.find(a => a.id === pendingDeleteAppointmentId);
                if (!appt) {
                    console.error('Appointment not found');
                    pendingDeleteAppointmentId = null;
                    return;
                }
                const apptName = appt.doctor;
                
                users[currentUser].appointments = users[currentUser].appointments.filter(a => a.id !== pendingDeleteAppointmentId);
                saveData('users', users);
                
                console.log('Reloading appointments...');
                loadAppointments(users[currentUser].appointments);
                updateDashboard();
                loadHomeReminders();
                speak('Appointment deleted: ' + apptName);
                
                pendingDeleteAppointmentId = null;
                console.log('Done!');
                return; // Exit after appointment delete
            }
            
            // Check if deleting a bill
            if (pendingDeleteBillId !== null) {
                console.log('Deleting bill with id:', pendingDeleteBillId);
                users = loadData('users');
                const bill = users[currentUser].bills.find(b => b.id === pendingDeleteBillId);
                if (!bill) {
                    console.error('Bill not found');
                    pendingDeleteBillId = null;
                    return;
                }
                const billName = bill.name;
                
                users[currentUser].bills = users[currentUser].bills.filter(b => b.id !== pendingDeleteBillId);
                saveData('users', users);
                
                console.log('Reloading bills...');
                loadBills(users[currentUser].bills);
                updateDashboard();
                loadHomeReminders();
                speak('Bill deleted: ' + billName);
                
                pendingDeleteBillId = null;
                console.log('Done!');
                return; // Exit after bill delete
            }
            
            // Check if deleting a task
            if (pendingDeleteCategory !== null && pendingDeleteIndex !== null) {
                // Deleting a task
                console.log('Deleting task');
                users = loadData('users');
                const task = users[currentUser].tasks[pendingDeleteCategory][pendingDeleteIndex];
                const taskName = task.name;
                
                console.log('Deleting task:', taskName);
                users[currentUser].tasks[pendingDeleteCategory].splice(pendingDeleteIndex, 1);
                saveData('users', users);
                
                console.log('Reloading tasks...');
                loadTasks(users[currentUser].tasks);
                updateDashboard();
                speak('Task deleted: ' + taskName);
                
                // Clear pending
                pendingDeleteCategory = null;
                pendingDeleteIndex = null;
                console.log('Done!');
                return; // Exit after task delete
            } else {
                // Neither was set - shouldn't happen but just in case
                console.error('No pending delete found');
            }
        }

        function cancelDeleteTask() {
            console.log('Delete cancelled');
            document.getElementById('deleteTaskModal').classList.add('hidden');
            pendingDeleteCategory = null;
            pendingDeleteIndex = null;
            pendingDeleteMedicationId = null;
            pendingDeleteAppointmentId = null;
            pendingDeleteBillId = null;
        }

        function markMedicationTaken(id) {
            const users = loadData('users');
            const med = users[currentUser].medications.find(m => m.id === id);
            if (!med) return;
            
            const todayDate = new Date().toISOString().split('T')[0];
            
            if (!med.takenDates) {
                med.takenDates = [];
            }

            if (med.takenDates.includes(todayDate)) {
                // Remove today's date (mark as not taken)
                med.takenDates = med.takenDates.filter(date => date !== todayDate);
                speak('Medication marked as not taken today');
            } else {
                // Add today's date (mark as taken)
                med.takenDates.push(todayDate);
                speak('Medication marked as taken today');
            }

            // Clean up old dates (keep only last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const cutoffDate = thirtyDaysAgo.toISOString().split('T')[0];
            med.takenDates = med.takenDates.filter(date => date >= cutoffDate);

            saveData('users', users);
            loadMedications(users[currentUser].medications);
            loadHomeReminders();
        }

        function deleteMedication(id) {
            if (!confirm('Are you sure you want to delete this medication?')) return;
            
            const users = loadData('users');
            users[currentUser].medications = users[currentUser].medications.filter(m => m.id !== id);
            saveData('users', users);
            loadMedications(users[currentUser].medications);
            updateDashboard();
            speak('Medication deleted');
        }

        // Appointments
        function addAppointment() {
            const doctor = document.getElementById('apptDoctor').value;
            const date = document.getElementById('apptDate').value;
            const time = document.getElementById('apptTime').value;
            const location = document.getElementById('apptLocation').value;

            if (!doctor || !date || !time || !location) {
                alert('Please fill in all fields');
                return;
            }

            const users = loadData('users');
            
            if (editingAppointmentId !== null) {
                // EDITING MODE
                const apptIndex = users[currentUser].appointments.findIndex(a => a.id === editingAppointmentId);
                if (apptIndex !== -1) {
                    const existingAppt = users[currentUser].appointments[apptIndex];
                    users[currentUser].appointments[apptIndex] = {
                        id: existingAppt.id,
                        doctor: doctor,
                        date: date,
                        time: time,
                        location: location,
                        completed: existingAppt.completed || false,
                        reminderEnabled: document.getElementById('apptReminderEnabled').checked,
                        reminderMinutes: parseInt(document.getElementById('apptReminderMinutes').value) || 60
                    };
                    saveData('users', users);
                    speak(`Updated appointment with ${doctor}`);
                }
                
                editingAppointmentId = null;
                document.getElementById('addApptBtn').textContent = 'Add Appointment';
                document.getElementById('cancelEditApptBtn').classList.add('hidden');
            } else {
                // ADDING MODE
                
                // Check for duplicates
                const existingAppts = users[currentUser].appointments || [];
                
                // Check for EXACT duplicate (doctor + date + time + location all match)
                const exactDuplicate = existingAppts.find(appt =>
                    appt.doctor.toLowerCase().trim() === doctor.toLowerCase().trim() &&
                    appt.date === date &&
                    appt.time === time &&
                    appt.location.toLowerCase().trim() === location.toLowerCase().trim()
                );
                
                if (exactDuplicate) {
                    alert('‚ùå Duplicate Appointment\n\n' +
                          'This appointment already exists:\n\n' +
                          `Doctor: ${exactDuplicate.doctor}\n` +
                          `Date: ${formatDate(exactDuplicate.date)}\n` +
                          `Time: ${formatTime(exactDuplicate.time)}\n` +
                          `Location: ${exactDuplicate.location}\n\n` +
                          'Cannot add duplicate appointment.');
                    speak('This appointment already exists');
                    return;
                }
                
                // Check for SAME DOCTOR on same day but different time or location
                const sameDoctorSameDay = existingAppts.find(appt =>
                    appt.doctor.toLowerCase().trim() === doctor.toLowerCase().trim() &&
                    appt.date === date &&
                    (appt.time !== time || appt.location.toLowerCase().trim() !== location.toLowerCase().trim())
                );
                
                if (sameDoctorSameDay) {
                    const userConfirmed = confirm(
                        `‚ö†Ô∏è Appointment with This Doctor Already Exists\n\n` +
                        `You already have an appointment with ${sameDoctorSameDay.doctor} on ${formatDate(date)}:\n\n` +
                        `Existing: ${formatTime(sameDoctorSameDay.time)} at ${sameDoctorSameDay.location}\n` +
                        `New: ${formatTime(time)} at ${location}\n\n` +
                        `This might be:\n` +
                        `‚Ä¢ Time or location change\n` +
                        `‚Ä¢ Multiple appointments same day\n` +
                        `‚Ä¢ Accidentally creating a duplicate\n\n` +
                        `Do you want to add this appointment anyway?`
                    );
                    
                    if (!userConfirmed) {
                        speak('Appointment not added');
                        return;
                    }
                }
                
                const appointment = {
                    id: Date.now(),
                    doctor: doctor,
                    date: date,
                    time: time,
                    location: location,
                    completed: false,
                    reminderEnabled: document.getElementById('apptReminderEnabled').checked,
                    reminderMinutes: parseInt(document.getElementById('apptReminderMinutes').value) || 60
                };

                users[currentUser].appointments.push(appointment);
                saveData('users', users);
                speak(`Added appointment with ${doctor}`);
            }

            document.getElementById('apptDoctor').value = '';
            document.getElementById('apptDate').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptLocation').value = '';
            document.getElementById('apptReminderEnabled').checked = false;
            document.getElementById('apptReminderMinutes').value = '60';
            document.getElementById('apptReminderOptions').classList.add('hidden');

            loadAppointments(users[currentUser].appointments);
            updateDashboard();
        }

        function editAppointment(apptId) {
            const users = loadData('users');
            const appointment = users[currentUser].appointments.find(a => a.id === apptId);
            
            if (!appointment) {
                alert('Appointment not found');
                return;
            }

            editingAppointmentId = apptId;
            
            document.getElementById('apptDoctor').value = appointment.doctor;
            document.getElementById('apptDate').value = appointment.date;
            document.getElementById('apptTime').value = appointment.time;
            document.getElementById('apptLocation').value = appointment.location;
            document.getElementById('apptReminderEnabled').checked = appointment.reminderEnabled || false;
            document.getElementById('apptReminderMinutes').value = appointment.reminderMinutes || 60;
            
            // Show/hide reminder options
            if (appointment.reminderEnabled) {
                document.getElementById('apptReminderOptions').classList.remove('hidden');
            } else {
                document.getElementById('apptReminderOptions').classList.add('hidden');
            }
            
            document.getElementById('addApptBtn').textContent = 'Update Appointment';
            document.getElementById('cancelEditApptBtn').classList.remove('hidden');
            
            document.querySelector('#appointments .form-section').scrollIntoView({ behavior: 'smooth' });
            speak(`Editing appointment with ${appointment.doctor}`);
        }

        function cancelEditAppointment() {
            editingAppointmentId = null;
            
            document.getElementById('apptDoctor').value = '';
            document.getElementById('apptDate').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptLocation').value = '';
            document.getElementById('apptReminderEnabled').checked = false;
            document.getElementById('apptReminderMinutes').value = '60';
            document.getElementById('apptReminderOptions').classList.add('hidden');
            
            document.getElementById('addApptBtn').textContent = 'Add Appointment';
            document.getElementById('cancelEditApptBtn').classList.add('hidden');
            
            speak('Editing cancelled');
        }

        window.editAppointment = editAppointment;


        // Autocomplete suggestions storage
        let doctorSuggestions = [];
        let locationSuggestions = [];

        function updateAppointmentAutocomplete(appointments) {
            console.log('updateAppointmentAutocomplete called with', appointments.length, 'appointments');
            
            // Extract unique doctor names and locations from appointment history
            const doctors = new Set();
            const locations = new Set();
            
            appointments.forEach(appt => {
                if (appt.doctor && appt.doctor.trim()) {
                    doctors.add(appt.doctor.trim());
                }
                if (appt.location && appt.location.trim()) {
                    locations.add(appt.location.trim());
                }
            });
            
            // Store suggestions globally for autocomplete
            doctorSuggestions = Array.from(doctors).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            locationSuggestions = Array.from(locations).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            
            console.log('Doctor suggestions updated:', doctorSuggestions);
            console.log('Location suggestions updated:', locationSuggestions);
        }

        function showAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            console.log('showAutocomplete called', inputId, dropdownId);
            console.log('Input element:', input);
            console.log('Dropdown element:', dropdown);
            
            if (!input || !dropdown) {
                console.log('Missing input or dropdown!');
                return;
            }
            
            const suggestions = dropdownId === 'doctorDropdown' ? doctorSuggestions : locationSuggestions;
            console.log('Suggestions:', suggestions);
            
            if (suggestions.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">Start adding appointments to build your history!</div>';
                dropdown.classList.add('show');
                console.log('Showing "no history" message');
                return;
            }
            
            // Show all suggestions when focused
            filterAutocomplete(inputId, dropdownId);
        }

        function filterAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            console.log('filterAutocomplete called', inputId, dropdownId);
            
            if (!input || !dropdown) return;
            
            // Determine which suggestions array to use
            const suggestions = dropdownId === 'doctorDropdown' ? doctorSuggestions : locationSuggestions;
            
            const searchText = input.value.toLowerCase();
            console.log('Search text:', searchText);
            console.log('Available suggestions:', suggestions);
            
            // Filter suggestions - show items that contain the search text anywhere
            const filtered = searchText === '' 
                ? suggestions 
                : suggestions.filter(item => item.toLowerCase().includes(searchText));
            
            console.log('Filtered suggestions:', filtered);
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">No matches found. Type a new name to add it!</div>';
                dropdown.classList.add('show');
                console.log('No matches - showing message');
                return;
            }
            
            // Build dropdown HTML
            let html = '';
            filtered.forEach(item => {
                // Highlight matching text
                let displayText = item;
                if (searchText) {
                    const regex = new RegExp(`(${searchText})`, 'gi');
                    displayText = item.replace(regex, '<span class="autocomplete-highlight">$1</span>');
                }
                html += `<div class="autocomplete-item" onclick="selectAutocomplete('${inputId}', '${dropdownId}', '${item.replace(/'/g, "\\'")}')">${displayText}</div>`;
            });
            
            dropdown.innerHTML = html;
            dropdown.classList.add('show');
            console.log('Dropdown HTML set, class "show" added');
            console.log('Dropdown classList:', dropdown.classList);
        }

        function selectAutocomplete(inputId, dropdownId, value) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (input) {
                input.value = value;
            }
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        function hideAutocomplete(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // Contact autocomplete
        let contactSuggestions = []; // Stores {name, phone, relation} objects

        function updateContactAutocomplete(contacts) {
            console.log('updateContactAutocomplete called with', contacts.length, 'contacts');
            
            // Store contact objects for autocomplete
            contactSuggestions = contacts.map(contact => ({
                name: contact.name,
                phone: contact.phone,
                relation: contact.relation
            })).sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
            
            console.log('Contact suggestions updated:', contactSuggestions);
        }

        function showContactAutocomplete() {
            const input = document.getElementById('contactName');
            const dropdown = document.getElementById('contactDropdown');
            
            console.log('showContactAutocomplete called');
            
            if (!input || !dropdown) return;
            
            if (contactSuggestions.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">Start adding contacts to build your list!</div>';
                dropdown.classList.add('show');
                console.log('Showing "no contacts" message');
                return;
            }
            
            // Show all contacts when focused
            filterContactAutocomplete();
        }

        function filterContactAutocomplete() {
            const input = document.getElementById('contactName');
            const dropdown = document.getElementById('contactDropdown');
            
            console.log('filterContactAutocomplete called');
            
            if (!input || !dropdown) return;
            
            const searchText = input.value.toLowerCase();
            console.log('Search text:', searchText);
            console.log('Available contacts:', contactSuggestions);
            
            // Filter contacts - match name anywhere
            const filtered = searchText === '' 
                ? contactSuggestions 
                : contactSuggestions.filter(contact => contact.name.toLowerCase().includes(searchText));
            
            console.log('Filtered contacts:', filtered);
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">No matches found. Add as new contact!</div>';
                dropdown.classList.add('show');
                console.log('No matches - showing message');
                return;
            }
            
            // Build dropdown HTML with name, relation, and phone
            let html = '';
            filtered.forEach(contact => {
                // Highlight matching text in name
                let displayName = contact.name;
                if (searchText) {
                    const regex = new RegExp(`(${searchText})`, 'gi');
                    displayName = contact.name.replace(regex, '<span class="autocomplete-highlight">$1</span>');
                }
                
                // Each item shows: Name (Relation) - Phone
                html += `<div class="autocomplete-item" onclick="selectContact('${contact.name.replace(/'/g, "\\'")}', '${contact.phone}', '${contact.relation.replace(/'/g, "\\'")}')">
                    <div style="font-weight: 600;">${displayName}</div>
                    <div style="font-size: 14px; color: #666; margin-top: 2px;">${contact.relation} ‚Ä¢ ${contact.phone}</div>
                </div>`;
            });
            
            dropdown.innerHTML = html;
            dropdown.classList.add('show');
            console.log('Contact dropdown HTML set, class "show" added');
        }

        function selectContact(name, phone, relation) {
            console.log('selectContact called:', name, phone, relation);
            
            // Fill in all fields
            document.getElementById('contactName').value = name;
            document.getElementById('contactPhone').value = phone;
            document.getElementById('contactRelation').value = relation;
            
            // Hide dropdown
            const dropdown = document.getElementById('contactDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            // Speak confirmation
            speak(`Selected ${name}, ${relation}`);
        }

        function loadAppointments(appointments) {
            const container = document.getElementById('appointmentList');
            container.innerHTML = '';

            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No appointments scheduled</p>';
                return;
            }

            // Load minimized state
            const minimizedAppts = JSON.parse(localStorage.getItem('minimizedAppts') || '{}');

            // Add completed property to legacy appointments
            appointments.forEach(appt => {
                if (appt.completed === undefined) {
                    appt.completed = false;
                }
            });

            appointments.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));

            appointments.forEach(appt => {
                const isMinimized = minimizedAppts[appt.id] || false;
                const card = document.createElement('div');
                card.className = 'card appointment fade-in';
                if (appt.completed) {
                    card.style.opacity = '0.6';
                    card.style.background = '#f7fafc';
                }
                
                const reminderBadge = appt.reminderEnabled ? ' üîî' : '';
                const reminderText = appt.reminderEnabled ? `<br><strong>üîî Reminder:</strong> ${appt.reminderMinutes >= 1440 ? Math.floor(appt.reminderMinutes / 1440) + ' day before' : appt.reminderMinutes >= 60 ? Math.floor(appt.reminderMinutes / 60) + ' hour' + (appt.reminderMinutes >= 120 ? 's' : '') + ' before' : appt.reminderMinutes + ' min before'}` : '';
                const toggleIcon = isMinimized ? '‚ñº' : '‚ñ≤';
                const completedIcon = appt.completed ? '‚úì ' : '';
                
                card.innerHTML = `
                    <div class="card-header" style="cursor: pointer; user-select: none;">
                        <div style="flex: 1;" onclick="toggleAppointmentCard(${appt.id})">
                            ${completedIcon}${appt.doctor}${reminderBadge}
                            <div style="font-size: 14px; color: #666; margin-top: 2px;">
                                ${formatDate(appt.date)} at ${formatTime(appt.time)} ‚Ä¢ ${appt.location}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="action-btn" onclick="toggleAppointmentCard(${appt.id})" 
                                    style="font-size: 18px; padding: 5px 12px; background: #e2e8f0; color: #333;"
                                    title="${isMinimized ? 'Expand' : 'Minimize'}">
                                <span id="toggle-icon-appt-${appt.id}">${toggleIcon}</span>
                            </button>
                        </div>
                    </div>
                    <div id="appt-details-${appt.id}" style="${isMinimized ? 'display: none;' : ''}">
                        <div class="card-content">
                            <strong>üìç Location:</strong> ${appt.location}<br>
                            <strong>üìÖ Date:</strong> ${formatDate(appt.date)}<br>
                            <strong>‚è∞ Time:</strong> ${formatTime(appt.time)}${reminderText}
                        </div>
                        <button class="action-btn ${appt.completed ? 'btn-success' : 'btn-info'}" 
                                onclick="toggleAppointmentCompleted(${appt.id})">
                            ${appt.completed ? '‚úì Completed' : 'Mark as Completed'}
                        </button>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="action-btn btn-info" onclick="window.editAppointment(${appt.id})" style="font-size: 14px; flex: 1;">Edit</button>
                            <button class="action-btn btn-delete" onclick="window.deleteAppointmentById(${appt.id})" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Update autocomplete suggestions
            updateAppointmentAutocomplete(appointments);
        }

        // Toggle appointment card
        function toggleAppointmentCard(apptId) {
            const detailsDiv = document.getElementById(`appt-details-${apptId}`);
            const toggleIcon = document.getElementById(`toggle-icon-appt-${apptId}`);
            
            if (!detailsDiv || !toggleIcon) return;
            
            const isMinimized = detailsDiv.style.display === 'none';
            detailsDiv.style.display = isMinimized ? '' : 'none';
            toggleIcon.textContent = isMinimized ? '‚ñ≤' : '‚ñº';
            
            const minimizedAppts = JSON.parse(localStorage.getItem('minimizedAppts') || '{}');
            minimizedAppts[apptId] = !isMinimized;
            localStorage.setItem('minimizedAppts', JSON.stringify(minimizedAppts));
            
            speak(isMinimized ? 'Expanded' : 'Minimized');
        }
        window.toggleAppointmentCard = toggleAppointmentCard;

        // Make appointment delete function globally accessible
        window.deleteAppointmentById = function(id) {
            console.log('Delete appointment clicked:', id);
            const users = loadData('users');
            if (!users || !users[currentUser]) {
                console.error('No user data found');
                return;
            }
            
            const appt = users[currentUser].appointments.find(a => a.id === id);
            if (!appt) {
                console.error('No appointment found with id', id);
                return;
            }
            
            const apptName = appt.doctor;
            console.log('Attempting to delete appointment:', apptName);
            
            // Store the appointment id for confirmation
            pendingDeleteAppointmentId = id;
            
            // Show custom modal
            document.getElementById('deleteTaskText').textContent = 
                'Are you sure you want to delete appointment with "' + apptName + '"?';
            document.getElementById('deleteTaskModal').classList.remove('hidden');
            console.log('Delete modal shown for appointment');
        };

        function toggleAppointmentCompleted(id) {
            const users = loadData('users');
            const appt = users[currentUser].appointments.find(a => a.id === id);
            if (!appt) return;
            
            appt.completed = !appt.completed;
            saveData('users', users);
            loadAppointments(users[currentUser].appointments);
            updateDashboard();
            speak(appt.completed ? 'Appointment marked as completed' : 'Appointment marked as not completed');
        }

        // Tasks
        function updateTaskRecurrenceOptions() {
            const recurrence = document.getElementById('customTaskRecurrence').value;
            document.getElementById('taskSpecificDaysContainer').classList.add('hidden');
            document.getElementById('taskWeeklyDayContainer').classList.add('hidden');

            if (recurrence === 'specific-days') {
                document.getElementById('taskSpecificDaysContainer').classList.remove('hidden');
            } else if (recurrence === 'weekly') {
                document.getElementById('taskWeeklyDayContainer').classList.remove('hidden');
            }
        }

        function getTaskRecurrenceText(task) {
            if (!task.recurrence || task.recurrence === 'daily') {
                return '';
            } else if (task.recurrence === 'specific-days' && task.specificDays) {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return ' (' + task.specificDays.map(d => dayNames[d]).join(', ') + ')';
            } else if (task.recurrence === 'weekly' && task.weeklyDay !== undefined) {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return ' (' + dayNames[task.weeklyDay] + ')';
            }
            return '';
        }

        function shouldShowTaskToday(task) {
            // If no recurrence, show every day (legacy tasks)
            if (!task.recurrence || task.recurrence === 'daily') {
                return true;
            }

            const today = new Date();
            const todayDay = today.getDay(); // 0 = Sunday, 6 = Saturday
            
            if (task.recurrence === 'specific-days' && task.specificDays) {
                return task.specificDays.includes(todayDay);
            } else if (task.recurrence === 'weekly' && task.weeklyDay !== undefined) {
                return todayDay === task.weeklyDay;
            }
            
            return true;
        }

        function addCustomTask() {
            const name = document.getElementById('customTaskName').value;
            const category = document.getElementById('customTaskCategory').value;
            const time = document.getElementById('customTaskTime').value;
            const recurrence = document.getElementById('customTaskRecurrence').value;

            console.log('Adding/Editing custom task:', { name, category, time, recurrence, editing: editingTaskCategory !== null });

            if (!name) {
                alert('Please enter a task name');
                return;
            }

            const users = loadData('users');
            if (!users || !users[currentUser]) {
                console.error('No user data found');
                alert('Error: User data not found');
                return;
            }

            // Ensure category exists
            if (!users[currentUser].tasks[category]) {
                console.error('Category does not exist:', category);
                alert('Error: Invalid category');
                return;
            }

            if (editingTaskCategory !== null && editingTaskIndex !== null) {
                // EDITING MODE
                const task = {
                    name: name,
                    time: time || '',
                    completed: users[currentUser].tasks[editingTaskCategory][editingTaskIndex].completed || false,
                    recurrence: recurrence,
                    reminderEnabled: document.getElementById('taskReminderEnabled').checked,
                    reminderMinutes: parseInt(document.getElementById('taskReminderMinutes').value) || 10
                };

                // Handle specific recurrence options
                if (recurrence === 'specific-days') {
                    const selectedDays = Array.from(document.querySelectorAll('.task-day-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedDays.length === 0) {
                        alert('Please select at least one day of the week');
                        return;
                    }
                    task.specificDays = selectedDays;
                } else if (recurrence === 'weekly') {
                    task.weeklyDay = parseInt(document.getElementById('customTaskWeeklyDay').value);
                }

                // Update the task
                users[currentUser].tasks[editingTaskCategory][editingTaskIndex] = task;
                saveData('users', users);
                speak(`Updated task ${name}`);
                
                editingTaskCategory = null;
                editingTaskIndex = null;
                document.getElementById('addTaskBtn').textContent = 'Add Task';
                document.getElementById('cancelEditTaskBtn').classList.add('hidden');
            } else {
                // ADDING MODE
                
                // Check for duplicates in the same category
                const existingTasks = users[currentUser].tasks[category] || [];
                
                // Check for EXACT duplicate (name + time in same category)
                const exactDuplicate = existingTasks.find(task =>
                    task.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    task.time === time
                );
                
                if (exactDuplicate) {
                    alert('‚ùå Duplicate Task\n\n' +
                          'This task already exists in this category:\n\n' +
                          `Name: ${exactDuplicate.name}\n` +
                          `Time: ${time ? formatTime(time) : 'No specific time'}\n` +
                          `Category: ${category.charAt(0).toUpperCase() + category.slice(1)}\n\n` +
                          'Cannot add duplicate task.');
                    speak('This task already exists');
                    return;
                }
                
                // Check for SAME NAME but different time in same category
                const sameTaskName = existingTasks.find(task =>
                    task.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    task.time !== time
                );
                
                if (sameTaskName) {
                    const userConfirmed = confirm(
                        `‚ö†Ô∏è Task Name Already Exists\n\n` +
                        `A task named "${sameTaskName.name}" already exists in ${category}:\n\n` +
                        `Existing: ${sameTaskName.time ? formatTime(sameTaskName.time) : 'No specific time'}\n` +
                        `New: ${time ? formatTime(time) : 'No specific time'}\n\n` +
                        `This might be:\n` +
                        `‚Ä¢ Same task at different times\n` +
                        `‚Ä¢ Accidentally creating a duplicate\n\n` +
                        `Do you want to add this task anyway?`
                    );
                    
                    if (!userConfirmed) {
                        speak('Task not added');
                        return;
                    }
                }
                
                const task = {
                    name: name,
                    time: time || '',
                    completed: false,
                    recurrence: recurrence,
                    reminderEnabled: document.getElementById('taskReminderEnabled').checked,
                    reminderMinutes: parseInt(document.getElementById('taskReminderMinutes').value) || 10
                };

                // Handle specific recurrence options
                if (recurrence === 'specific-days') {
                    const selectedDays = Array.from(document.querySelectorAll('.task-day-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedDays.length === 0) {
                        alert('Please select at least one day of the week');
                        return;
                    }
                    task.specificDays = selectedDays;
                } else if (recurrence === 'weekly') {
                    task.weeklyDay = parseInt(document.getElementById('customTaskWeeklyDay').value);
                }

                console.log('Adding task to category:', category, task);
                users[currentUser].tasks[category].push(task);
                saveData('users', users);
                console.log('Task added successfully');
                speak(`Added task ${name} with ${recurrence === 'daily' ? 'daily' : getTaskRecurrenceText(task)} schedule`);
            }

            // Clear form
            document.getElementById('customTaskName').value = '';
            document.getElementById('customTaskTime').value = '';
            document.getElementById('customTaskRecurrence').value = 'daily';
            document.getElementById('customTaskCategory').value = 'meals';
            document.getElementById('taskReminderEnabled').checked = false;
            document.getElementById('taskReminderMinutes').value = '10';
            document.getElementById('taskReminderOptions').classList.add('hidden');
            document.querySelectorAll('.task-day-checkbox').forEach(cb => cb.checked = false);
            updateTaskRecurrenceOptions();

            loadTasks(users[currentUser].tasks);
            updateDashboard();
            console.log('Task display updated');
        }

        function editTaskByIndex(category, index) {
            const users = loadData('users');
            const task = users[currentUser].tasks[category][index];
            
            if (!task) {
                alert('Task not found');
                return;
            }

            editingTaskCategory = category;
            editingTaskIndex = index;
            
            document.getElementById('customTaskName').value = task.name;
            document.getElementById('customTaskCategory').value = category;
            document.getElementById('customTaskTime').value = task.time || '';
            document.getElementById('customTaskRecurrence').value = task.recurrence || 'daily';
            document.getElementById('taskReminderEnabled').checked = task.reminderEnabled || false;
            document.getElementById('taskReminderMinutes').value = task.reminderMinutes || 10;
            
            // Show/hide reminder options
            if (task.reminderEnabled) {
                document.getElementById('taskReminderOptions').classList.remove('hidden');
            } else {
                document.getElementById('taskReminderOptions').classList.add('hidden');
            }
            
            updateTaskRecurrenceOptions();
            
            // Handle specific recurrence data
            if (task.recurrence === 'specific-days' && task.specificDays) {
                document.querySelectorAll('.task-day-checkbox').forEach(cb => {
                    cb.checked = task.specificDays.includes(parseInt(cb.value));
                });
            } else if (task.recurrence === 'weekly' && task.weeklyDay !== undefined) {
                document.getElementById('customTaskWeeklyDay').value = task.weeklyDay;
            }
            
            document.getElementById('addTaskBtn').textContent = 'Update Task';
            document.getElementById('cancelEditTaskBtn').classList.remove('hidden');
            
            document.querySelector('#tasks .form-section').scrollIntoView({ behavior: 'smooth' });
            speak(`Editing task ${task.name}`);
        }

        function cancelEditTask() {
            editingTaskCategory = null;
            editingTaskIndex = null;
            
            document.getElementById('customTaskName').value = '';
            document.getElementById('customTaskTime').value = '';
            document.getElementById('customTaskRecurrence').value = 'daily';
            document.getElementById('customTaskCategory').value = 'meals';
            document.getElementById('taskReminderEnabled').checked = false;
            document.getElementById('taskReminderMinutes').value = '10';
            document.getElementById('taskReminderOptions').classList.add('hidden');
            document.querySelectorAll('.task-day-checkbox').forEach(cb => cb.checked = false);
            updateTaskRecurrenceOptions();
            
            document.getElementById('addTaskBtn').textContent = 'Add Task';
            document.getElementById('cancelEditTaskBtn').classList.add('hidden');
            
            speak('Editing cancelled');
        }

        window.editTaskByIndex = editTaskByIndex;


        function loadTasks(tasks) {
            console.log('loadTasks called with:', tasks);
            const minimizedTasks = JSON.parse(localStorage.getItem('minimizedTasks') || '{}');
            
            ['meals', 'hydration', 'hygiene', 'safety'].forEach(category => {
                const container = document.getElementById(`${category}Tasks`);
                console.log(`Loading ${category}:`, container ? 'container found' : 'container NOT found', tasks[category] ? `${tasks[category].length} tasks` : 'no tasks');
                if (!container) return;
                container.innerHTML = '';

                if (tasks[category]) {
                    tasks[category].forEach((task, index) => {
                        console.log(`  Task ${index} in ${category}:`, task.name, 'showToday:', shouldShowTaskToday(task));
                        const showToday = shouldShowTaskToday(task);
                        const taskKey = `${category}-${index}`;
                        const isMinimized = minimizedTasks[taskKey] || false;
                        
                        const item = document.createElement('div');
                        item.className = `checkbox-item ${task.completed ? 'completed' : ''}`;
                        item.style.display = 'block';
                        item.style.padding = '12px';
                        item.style.border = '1px solid #e2e8f0';
                        item.style.borderRadius = '8px';
                        item.style.marginBottom = '8px';
                        
                        const taskTime = task.time ? ` ‚Ä¢ ${formatTime(task.time)}` : '';
                        const taskRecurrence = getTaskRecurrenceText(task);
                        const taskNameEscaped = task.name.replace(/'/g, "\\'");
                        const taskReminderBadge = task.reminderEnabled ? ' üîî' : '';
                        const taskReminderText = task.reminderEnabled ? ` (${task.reminderMinutes} min before)` : '';
                        const toggleIcon = isMinimized ? '‚ñº' : '‚ñ≤';
                        const completedIcon = task.completed ? '‚úì ' : '';
                        
                        let scheduleNote = '';
                        if (!showToday) {
                            scheduleNote = '<div style="background: #e2e8f0; padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-size: 13px; color: #666;">üìÖ Not scheduled for today</div>';
                        }
                        
                        item.innerHTML = `
                            <div style="display: flex; align-items: center; cursor: pointer; user-select: none;" onclick="toggleTaskCard('${taskKey}')">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                       ${!showToday ? 'disabled' : ''}
                                       onchange="window.toggleTaskByIndex('${category}', ${index}); event.stopPropagation();"
                                       onclick="event.stopPropagation();"
                                       style="width: 24px; height: 24px; margin-right: 12px; cursor: ${showToday ? 'pointer' : 'not-allowed'};">
                                <div style="flex: 1; ${!showToday ? 'opacity: 0.6;' : ''}">
                                    <div style="font-size: 16px; font-weight: 500;">
                                        ${completedIcon}${task.name}${taskReminderBadge}${taskTime}
                                    </div>
                                </div>
                                <button class="action-btn" onclick="toggleTaskCard('${taskKey}'); event.stopPropagation();" 
                                        style="font-size: 18px; padding: 5px 12px; background: #e2e8f0; color: #333; margin-left: 10px;"
                                        title="${isMinimized ? 'Expand' : 'Minimize'}">
                                    <span id="toggle-icon-task-${taskKey}">${toggleIcon}</span>
                                </button>
                            </div>
                            <div id="task-details-${taskKey}" style="${isMinimized ? 'display: none;' : ''} margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    ${taskRecurrence}${taskReminderText}
                                    ${scheduleNote}
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="action-btn btn-info" 
                                            onclick="window.editTaskByIndex('${category}', ${index}); event.stopPropagation();"
                                            style="flex: 1; padding: 8px 16px; font-size: 14px;">
                                        Edit
                                    </button>
                                    <button class="action-btn btn-delete" 
                                            onclick="window.deleteTaskByIndex('${category}', ${index}); event.stopPropagation();"
                                            style="flex: 1; padding: 8px 16px; font-size: 14px;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(item);
                        console.log(`  Task ${index} added to DOM`);
                    });
                }
            });
            console.log('loadTasks complete');
        }

        // Toggle task card
        function toggleTaskCard(taskKey) {
            const detailsDiv = document.getElementById(`task-details-${taskKey}`);
            const toggleIcon = document.getElementById(`toggle-icon-task-${taskKey}`);
            
            if (!detailsDiv || !toggleIcon) return;
            
            const isMinimized = detailsDiv.style.display === 'none';
            detailsDiv.style.display = isMinimized ? '' : 'none';
            toggleIcon.textContent = isMinimized ? '‚ñ≤' : '‚ñº';
            
            const minimizedTasks = JSON.parse(localStorage.getItem('minimizedTasks') || '{}');
            minimizedTasks[taskKey] = !isMinimized;
            localStorage.setItem('minimizedTasks', JSON.stringify(minimizedTasks));
            
            speak(isMinimized ? 'Expanded' : 'Minimized');
        }
        window.toggleTaskCard = toggleTaskCard;

        // Make these functions available globally
        window.deleteTaskByIndex = function(category, index) {
            console.log('Delete clicked:', category, index);
            const users = loadData('users');
            if (!users || !users[currentUser] || !users[currentUser].tasks[category]) {
                console.error('No user data found');
                return;
            }
            
            const task = users[currentUser].tasks[category][index];
            if (!task) {
                console.error('No task found at index', index);
                return;
            }
            
            const taskName = task.name;
            console.log('Attempting to delete:', taskName);
            
            // Store the task info for confirmation
            pendingDeleteCategory = category;
            pendingDeleteIndex = index;
            
            // Show custom modal
            document.getElementById('deleteTaskText').textContent = 
                'Are you sure you want to delete "' + taskName + '"?';
            document.getElementById('deleteTaskModal').classList.remove('hidden');
            console.log('Delete modal shown');
        };

        window.toggleTaskByIndex = function(category, index) {
            toggleTask(category, index);
        };

        function toggleTask(category, index) {
            const users = loadData('users');
            users[currentUser].tasks[category][index].completed = !users[currentUser].tasks[category][index].completed;
            saveData('users', users);
            loadTasks(users[currentUser].tasks);
            updateDashboard();
            
            const task = users[currentUser].tasks[category][index];
            speak(task.completed ? `Task completed: ${task.name}` : `Task uncompleted: ${task.name}`);
        }

        // Bills
        function getBillRecurrenceText(bill) {
            if (!bill.recurrence || bill.recurrence === 'one-time') {
                return 'one-time';
            } else if (bill.recurrence === 'monthly') {
                return 'monthly';
            } else if (bill.recurrence === 'quarterly') {
                return 'every 3 months';
            } else if (bill.recurrence === 'yearly') {
                return 'yearly';
            } else if (bill.recurrence === 'weekly') {
                return 'weekly';
            } else if (bill.recurrence === 'biweekly') {
                return 'every 2 weeks';
            }
            return 'one-time';
        }

        function getNextBillDueDate(dueDate, recurrence) {
            const currentDue = parseLocalDate(dueDate);
            let nextDue = new Date(currentDue);

            if (recurrence === 'monthly') {
                nextDue.setMonth(nextDue.getMonth() + 1);
            } else if (recurrence === 'quarterly') {
                nextDue.setMonth(nextDue.getMonth() + 3);
            } else if (recurrence === 'yearly') {
                nextDue.setFullYear(nextDue.getFullYear() + 1);
            } else if (recurrence === 'weekly') {
                nextDue.setDate(nextDue.getDate() + 7);
            } else if (recurrence === 'biweekly') {
                nextDue.setDate(nextDue.getDate() + 14);
            }

            return nextDue.toISOString().split('T')[0];
        }

        function addBill() {
            const name = document.getElementById('billName').value;
            const amount = document.getElementById('billAmount').value;
            const dueDate = document.getElementById('billDueDate').value;
            const recurrence = document.getElementById('billRecurrence').value;

            if (!name || !amount || !dueDate) {
                alert('Please fill in all fields');
                return;
            }

            const users = loadData('users');
            
            if (editingBillId !== null) {
                // EDITING MODE
                const billIndex = users[currentUser].bills.findIndex(b => b.id === editingBillId);
                if (billIndex !== -1) {
                    const existingBill = users[currentUser].bills[billIndex];
                    users[currentUser].bills[billIndex] = {
                        id: existingBill.id,
                        name: name,
                        amount: parseFloat(amount),
                        dueDate: dueDate,
                        recurrence: recurrence,
                        paid: existingBill.paid || false,
                        reminderEnabled: document.getElementById('billReminderEnabled').checked,
                        reminderDays: parseInt(document.getElementById('billReminderDays').value) || 3
                    };
                    saveData('users', users);
                    speak(`Updated bill ${name}`);
                }
                
                editingBillId = null;
                document.getElementById('addBillBtn').textContent = 'Add Bill';
                document.getElementById('cancelEditBillBtn').classList.add('hidden');
            } else {
                // ADDING MODE
                
                // Check for duplicates
                const existingBills = users[currentUser].bills || [];
                
                // Check for EXACT duplicate (name + amount + due date all match)
                const exactDuplicate = existingBills.find(bill =>
                    bill.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    Math.abs(bill.amount - parseFloat(amount)) < 0.01 && // Allow for floating point comparison
                    bill.dueDate === dueDate
                );
                
                if (exactDuplicate) {
                    alert('‚ùå Duplicate Bill\n\n' +
                          'This bill already exists:\n\n' +
                          `Name: ${exactDuplicate.name}\n` +
                          `Amount: $${exactDuplicate.amount.toFixed(2)}\n` +
                          `Due Date: ${formatDate(exactDuplicate.dueDate)}\n\n` +
                          'Cannot add duplicate bill.');
                    speak('This bill already exists');
                    return;
                }
                
                // Check for SAME NAME but different amount or date
                const sameBillName = existingBills.find(bill =>
                    bill.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    (Math.abs(bill.amount - parseFloat(amount)) >= 0.01 || bill.dueDate !== dueDate)
                );
                
                if (sameBillName) {
                    const userConfirmed = confirm(
                        `‚ö†Ô∏è Bill Name Already Exists\n\n` +
                        `A bill named "${sameBillName.name}" already exists:\n\n` +
                        `Existing: $${sameBillName.amount.toFixed(2)} due ${formatDate(sameBillName.dueDate)}\n` +
                        `New: $${parseFloat(amount).toFixed(2)} due ${formatDate(dueDate)}\n\n` +
                        `This might be:\n` +
                        `‚Ä¢ Recurring bill for different month\n` +
                        `‚Ä¢ Amount changed (e.g., electric bill varies)\n` +
                        `‚Ä¢ Accidentally creating a duplicate\n\n` +
                        `Do you want to add this bill anyway?`
                    );
                    
                    if (!userConfirmed) {
                        speak('Bill not added');
                        return;
                    }
                }
                
                const bill = {
                    id: Date.now(),
                    name: name,
                    amount: parseFloat(amount),
                    dueDate: dueDate,
                    recurrence: recurrence,
                    paid: false,
                    reminderEnabled: document.getElementById('billReminderEnabled').checked,
                    reminderDays: parseInt(document.getElementById('billReminderDays').value) || 3
                };

                users[currentUser].bills.push(bill);
                saveData('users', users);
                speak(`Added ${recurrence === 'one-time' ? '' : getBillRecurrenceText(bill)} bill ${name}`);
            }

            document.getElementById('billName').value = '';
            document.getElementById('billAmount').value = '';
            document.getElementById('billDueDate').value = '';
            document.getElementById('billRecurrence').value = 'one-time';
            document.getElementById('billReminderEnabled').checked = false;
            document.getElementById('billReminderDays').value = '3';
            document.getElementById('billReminderOptions').classList.add('hidden');

            loadBills(users[currentUser].bills);
            updateDashboard();
        }

        function editBill(billId) {
            const users = loadData('users');
            const bill = users[currentUser].bills.find(b => b.id === billId);
            
            if (!bill) {
                alert('Bill not found');
                return;
            }

            editingBillId = billId;
            
            document.getElementById('billName').value = bill.name;
            document.getElementById('billAmount').value = bill.amount;
            document.getElementById('billDueDate').value = bill.dueDate;
            document.getElementById('billRecurrence').value = bill.recurrence || 'one-time';
            document.getElementById('billReminderEnabled').checked = bill.reminderEnabled || false;
            document.getElementById('billReminderDays').value = bill.reminderDays || 3;
            
            // Show/hide reminder options
            if (bill.reminderEnabled) {
                document.getElementById('billReminderOptions').classList.remove('hidden');
            } else {
                document.getElementById('billReminderOptions').classList.add('hidden');
            }
            
            document.getElementById('addBillBtn').textContent = 'Update Bill';
            document.getElementById('cancelEditBillBtn').classList.remove('hidden');
            
            document.querySelector('#bills .form-section').scrollIntoView({ behavior: 'smooth' });
            speak(`Editing bill ${bill.name}`);
        }

        function cancelEditBill() {
            editingBillId = null;
            
            document.getElementById('billName').value = '';
            document.getElementById('billAmount').value = '';
            document.getElementById('billDueDate').value = '';
            document.getElementById('billRecurrence').value = 'one-time';
            document.getElementById('billReminderEnabled').checked = false;
            document.getElementById('billReminderDays').value = '3';
            document.getElementById('billReminderOptions').classList.add('hidden');
            
            document.getElementById('addBillBtn').textContent = 'Add Bill';
            document.getElementById('cancelEditBillBtn').classList.add('hidden');
            
            speak('Editing cancelled');
        }

        window.editBill = editBill;


        function loadBills(bills) {
            const container = document.getElementById('billList');
            container.innerHTML = '';

            if (bills.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No bills added yet</p>';
                return;
            }

            const minimizedBills = JSON.parse(localStorage.getItem('minimizedBills') || '{}');
            bills.sort((a, b) => parseLocalDate(a.dueDate) - parseLocalDate(b.dueDate));

            bills.forEach(bill => {
                // Add recurrence if missing (legacy support)
                if (!bill.recurrence) {
                    bill.recurrence = 'one-time';
                }

                const isMinimized = minimizedBills[bill.id] || false;
                const reminderBadge = bill.reminderEnabled ? ' üîî' : '';
                const reminderText = bill.reminderEnabled ? `<br><strong>üîî Reminder:</strong> ${bill.reminderDays} day${bill.reminderDays !== 1 ? 's' : ''} before due date` : '';
                const toggleIcon = isMinimized ? '‚ñº' : '‚ñ≤';
                const paidIcon = bill.paid ? '‚úì ' : '';

                const card = document.createElement('div');
                card.className = 'card bill fade-in';
                card.innerHTML = `
                    <div class="card-header" style="cursor: pointer; user-select: none;">
                        <div style="flex: 1;" onclick="toggleBillCard(${bill.id})">
                            ${paidIcon}${bill.name}${reminderBadge}
                            <div style="font-size: 14px; color: #666; margin-top: 2px;">
                                $${bill.amount.toFixed(2)} ‚Ä¢ Due ${formatDate(bill.dueDate)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="action-btn" onclick="toggleBillCard(${bill.id})" 
                                    style="font-size: 18px; padding: 5px 12px; background: #e2e8f0; color: #333;"
                                    title="${isMinimized ? 'Expand' : 'Minimize'}">
                                <span id="toggle-icon-bill-${bill.id}">${toggleIcon}</span>
                            </button>
                        </div>
                    </div>
                    <div id="bill-details-${bill.id}" style="${isMinimized ? 'display: none;' : ''}">
                        <div class="card-content">
                            <strong>üíµ Amount:</strong> $${bill.amount.toFixed(2)}<br>
                            <strong>üìÖ Due Date:</strong> ${formatDate(bill.dueDate)}<br>
                            <strong>üîÑ Repeats:</strong> ${getBillRecurrenceText(bill)}${reminderText}
                        </div>
                        <button class="action-btn ${bill.paid ? 'btn-success' : 'btn-warning'}" 
                                onclick="toggleBillPaid(${bill.id})">
                            ${bill.paid ? '‚úì Paid' : 'Mark as Paid'}
                        </button>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="action-btn btn-info" onclick="window.editBill(${bill.id})" style="font-size: 14px; flex: 1;">Edit</button>
                            <button class="action-btn btn-delete" onclick="window.deleteBillById(${bill.id})" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Toggle bill card
        function toggleBillCard(billId) {
            const detailsDiv = document.getElementById(`bill-details-${billId}`);
            const toggleIcon = document.getElementById(`toggle-icon-bill-${billId}`);
            
            if (!detailsDiv || !toggleIcon) return;
            
            const isMinimized = detailsDiv.style.display === 'none';
            detailsDiv.style.display = isMinimized ? '' : 'none';
            toggleIcon.textContent = isMinimized ? '‚ñ≤' : '‚ñº';
            
            const minimizedBills = JSON.parse(localStorage.getItem('minimizedBills') || '{}');
            minimizedBills[billId] = !isMinimized;
            localStorage.setItem('minimizedBills', JSON.stringify(minimizedBills));
            
            speak(isMinimized ? 'Expanded' : 'Minimized');
        }
        window.toggleBillCard = toggleBillCard;

        // Make bill delete function globally accessible
        window.deleteBillById = function(id) {
            console.log('Delete bill clicked:', id);
            const users = loadData('users');
            if (!users || !users[currentUser]) {
                console.error('No user data found');
                return;
            }
            
            const bill = users[currentUser].bills.find(b => b.id === id);
            if (!bill) {
                console.error('No bill found with id', id);
                return;
            }
            
            const billName = bill.name;
            console.log('Attempting to delete bill:', billName);
            
            // Store the bill id for confirmation
            pendingDeleteBillId = id;
            
            // Show custom modal
            document.getElementById('deleteTaskText').textContent = 
                'Are you sure you want to delete "' + billName + '"?';
            document.getElementById('deleteTaskModal').classList.remove('hidden');
            console.log('Delete modal shown for bill');
        };

        function toggleBillPaid(id) {
            const users = loadData('users');
            const bill = users[currentUser].bills.find(b => b.id === id);
            
            if (!bill) return;

            bill.paid = !bill.paid;

            // If marking as paid and bill is recurring, create next occurrence
            if (bill.paid && bill.recurrence && bill.recurrence !== 'one-time') {
                const nextDueDate = getNextBillDueDate(bill.dueDate, bill.recurrence);
                
                // Create new bill for next period
                const nextBill = {
                    id: Date.now() + 1, // Ensure unique ID
                    name: bill.name,
                    amount: bill.amount,
                    dueDate: nextDueDate,
                    recurrence: bill.recurrence,
                    paid: false
                };
                
                users[currentUser].bills.push(nextBill);
                speak(`Bill marked as paid. Next ${bill.name} due ${formatDate(nextDueDate)}`);
            } else {
                speak(bill.paid ? 'Bill marked as paid' : 'Bill marked as unpaid');
            }

            saveData('users', users);
            loadBills(users[currentUser].bills);
            updateDashboard();
            loadHomeReminders();
        }

        // Contacts
        function addContact() {
            const name = document.getElementById('contactName').value.trim();
            const relation = document.getElementById('contactRelation').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();

            if (!name || !relation || !phone) {
                alert('Please fill in all fields');
                return;
            }

            const users = loadData('users');
            const existingContacts = users[currentUser].contacts || [];
            
            // Check for EXACT duplicate (name + phone + relation all match)
            const exactDuplicate = existingContacts.find(contact => 
                contact.name.toLowerCase() === name.toLowerCase() &&
                contact.phone === phone &&
                contact.relation.toLowerCase() === relation.toLowerCase()
            );
            
            if (exactDuplicate) {
                alert('‚ùå Duplicate Contact\n\nThis contact already exists:\n\n' +
                      `Name: ${exactDuplicate.name}\n` +
                      `Phone: ${exactDuplicate.phone}\n` +
                      `Relation: ${exactDuplicate.relation}\n\n` +
                      'Cannot add duplicate contact.');
                speak('This contact already exists');
                return;
            }
            
            // Check for SAME NAME but different phone or relation
            const sameNameContact = existingContacts.find(contact =>
                contact.name.toLowerCase() === name.toLowerCase() &&
                (contact.phone !== phone || contact.relation.toLowerCase() !== relation.toLowerCase())
            );
            
            if (sameNameContact) {
                const userConfirmed = confirm(
                    `‚ö†Ô∏è Contact Name Already Exists\n\n` +
                    `A contact named "${sameNameContact.name}" already exists:\n\n` +
                    `Existing: ${sameNameContact.phone} (${sameNameContact.relation})\n` +
                    `New: ${phone} (${relation})\n\n` +
                    `This might be:\n` +
                    `‚Ä¢ Same person with different phone number\n` +
                    `‚Ä¢ Different person with same name\n\n` +
                    `Do you want to add this contact anyway?`
                );
                
                if (!userConfirmed) {
                    speak('Contact not added');
                    return;
                }
            }

            // All checks passed - add the contact
            const contact = {
                id: Date.now(),
                name: name,
                relation: relation,
                phone: phone
            };

            users[currentUser].contacts.push(contact);
            saveData('users', users);

            document.getElementById('contactName').value = '';
            document.getElementById('contactRelation').value = '';
            document.getElementById('contactPhone').value = '';

            loadContacts(users[currentUser].contacts);
            speak(`Added contact ${name}`);
        }

        function loadContacts(contacts) {
            const container = document.getElementById('contactList');
            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No contacts added yet</p>';
                updateContactAutocomplete([]); // Update with empty array
                return;
            }

            const minimizedContacts = JSON.parse(localStorage.getItem('minimizedContacts') || '{}');

            contacts.forEach(contact => {
                const isMinimized = minimizedContacts[contact.id] || false;
                const toggleIcon = isMinimized ? '‚ñº' : '‚ñ≤';
                
                const card = document.createElement('div');
                card.className = 'contact-card fade-in';
                card.style.display = 'block';
                card.style.padding = '16px';
                
                card.innerHTML = `
                    <div style="cursor: pointer; user-select: none;">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between;" onclick="toggleContactCard(${contact.id})">
                            <div style="flex: 1;">
                                <div class="contact-name" style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">
                                    ${contact.name}
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    üìû ${contact.phone} ‚Ä¢ ${contact.relation}
                                </div>
                            </div>
                            <button class="action-btn" onclick="toggleContactCard(${contact.id}); event.stopPropagation();" 
                                    style="font-size: 18px; padding: 5px 12px; background: #e2e8f0; color: #333;"
                                    title="${isMinimized ? 'Expand' : 'Minimize'}">
                                <span id="toggle-icon-contact-${contact.id}">${toggleIcon}</span>
                            </button>
                        </div>
                        <div id="contact-details-${contact.id}" style="${isMinimized ? 'display: none;' : ''} margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                            <div class="contact-buttons" style="display: flex; gap: 8px;">
                                <button class="call-btn" onclick="callContact('${contact.name.replace(/'/g, "\\'")}', '${contact.phone}'); event.stopPropagation();" style="flex: 1;">
                                    üìû Call
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteContact(${contact.id}); event.stopPropagation();" style="flex: 1;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Update autocomplete with current contacts
            updateContactAutocomplete(contacts);
        }

        // Toggle contact card
        function toggleContactCard(contactId) {
            const detailsDiv = document.getElementById(`contact-details-${contactId}`);
            const toggleIcon = document.getElementById(`toggle-icon-contact-${contactId}`);
            
            if (!detailsDiv || !toggleIcon) return;
            
            const isMinimized = detailsDiv.style.display === 'none';
            detailsDiv.style.display = isMinimized ? '' : 'none';
            toggleIcon.textContent = isMinimized ? '‚ñ≤' : '‚ñº';
            
            const minimizedContacts = JSON.parse(localStorage.getItem('minimizedContacts') || '{}');
            minimizedContacts[contactId] = !isMinimized;
            localStorage.setItem('minimizedContacts', JSON.stringify(minimizedContacts));
            
            speak(isMinimized ? 'Expanded' : 'Minimized');
        }
        window.toggleContactCard = toggleContactCard;

        function callContact(name, phone) {
            speak(`Calling ${name}`);
            window.location.href = `tel:${phone}`;
        }

        function callEmergency() {
            // Show confirmation modal
            document.getElementById('emergencyModal').classList.remove('hidden');
            speak('Emergency call confirmation');
        }

        function confirmEmergencyCall() {
            // Hide modal
            document.getElementById('emergencyModal').classList.add('hidden');
            speak('Calling emergency services nine one one');
            // Make the call
            window.location.href = 'tel:911';
        }

        function cancelEmergencyCall() {
            // Hide modal
            document.getElementById('emergencyModal').classList.add('hidden');
            speak('Emergency call cancelled');
        }

        function deleteContact(id) {
            if (!confirm('Are you sure you want to delete this contact?')) return;
            
            const users = loadData('users');
            users[currentUser].contacts = users[currentUser].contacts.filter(c => c.id !== id);
            saveData('users', users);
            loadContacts(users[currentUser].contacts);
            speak('Contact deleted');
        }

        // Activities
        let editingActivityId = null;

        function updateActivityRecurrenceOptions() {
            const recurrence = document.getElementById('activityRecurrence').value;
            document.getElementById('activityOneTimeContainer').style.display = recurrence === 'one-time' ? 'block' : 'none';
            document.getElementById('activityWeeklyContainer').style.display = recurrence === 'weekly' ? 'block' : 'none';
            document.getElementById('activitySpecificDaysContainer').style.display = recurrence === 'specific-days' ? 'block' : 'none';
            document.getElementById('activityMonthlyContainer').style.display = recurrence === 'monthly' ? 'block' : 'none';
        }

        function toggleActivityReminderOptions() {
            const enabled = document.getElementById('activityReminderEnabled').checked;
            document.getElementById('activityReminderOptions').classList.toggle('hidden', !enabled);
        }

        function getActivityRecurrenceText(activity) {
            if (activity.recurrence === 'daily') {
                return ' (Daily)';
            } else if (activity.recurrence === 'weekly') {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return ` (Every ${days[activity.weeklyDay]})`;
            } else if (activity.recurrence === 'specific-days' && activity.specificDays) {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const selectedDays = activity.specificDays.map(d => dayNames[d]).join(', ');
                return ` (${selectedDays})`;
            } else if (activity.recurrence === 'monthly') {
                return ` (Monthly on day ${activity.monthlyDate})`;
            } else if (activity.recurrence === 'one-time') {
                return ` (${formatDate(activity.date)})`;
            }
            return '';
        }

        function shouldShowActivityToday(activity) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const dayOfMonth = today.getDate();
            const todayStr = today.toISOString().split('T')[0];

            if (activity.recurrence === 'daily') {
                return true;
            } else if (activity.recurrence === 'weekly') {
                return activity.weeklyDay === dayOfWeek;
            } else if (activity.recurrence === 'specific-days' && activity.specificDays) {
                return activity.specificDays.includes(dayOfWeek);
            } else if (activity.recurrence === 'monthly') {
                return activity.monthlyDate === dayOfMonth;
            } else if (activity.recurrence === 'one-time') {
                return activity.date === todayStr;
            }
            return false;
        }

        function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const location = document.getElementById('activityLocation').value.trim();
            const description = document.getElementById('activityDescription').value.trim();
            const time = document.getElementById('activityTime').value;
            const recurrence = document.getElementById('activityRecurrence').value;

            if (!name || !location || !time) {
                alert('Please fill in Activity Name, Location, and Time');
                return;
            }

            const users = loadData('users');
            
            if (editingActivityId !== null) {
                // EDITING MODE
                const actIndex = users[currentUser].activities.findIndex(a => a.id === editingActivityId);
                if (actIndex !== -1) {
                    const activity = {
                        id: editingActivityId,
                        name: name,
                        location: location,
                        description: description,
                        time: time,
                        recurrence: recurrence,
                        reminderEnabled: document.getElementById('activityReminderEnabled').checked,
                        reminderMinutes: parseInt(document.getElementById('activityReminderMinutes').value) || 30,
                        attended: users[currentUser].activities[actIndex].attended || []
                    };

                    if (recurrence === 'one-time') {
                        const date = document.getElementById('activityDate').value;
                        if (!date) {
                            alert('Please select a date for this one-time activity');
                            return;
                        }
                        activity.date = date;
                    } else if (recurrence === 'weekly') {
                        activity.weeklyDay = parseInt(document.getElementById('activityWeeklyDay').value);
                    } else if (recurrence === 'specific-days') {
                        const selectedDays = Array.from(document.querySelectorAll('.activity-day-checkbox:checked'))
                            .map(cb => parseInt(cb.value));
                        if (selectedDays.length === 0) {
                            alert('Please select at least one day of the week');
                            return;
                        }
                        activity.specificDays = selectedDays;
                    } else if (recurrence === 'monthly') {
                        activity.monthlyDate = parseInt(document.getElementById('activityMonthlyDate').value);
                    }

                    users[currentUser].activities[actIndex] = activity;
                    saveData('users', users);
                    speak(`Updated activity ${name}`);
                }
                
                editingActivityId = null;
                document.getElementById('addActivityBtn').textContent = 'Add Activity';
                document.getElementById('cancelEditActivityBtn').classList.add('hidden');
                
            } else {
                // ADDING MODE - Check for duplicates
                const existingActivities = users[currentUser].activities || [];
                
                const exactDuplicate = existingActivities.find(act =>
                    act.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    act.location.toLowerCase().trim() === location.toLowerCase().trim() &&
                    act.time === time &&
                    act.recurrence === recurrence
                );
                
                if (exactDuplicate) {
                    alert('‚ùå Duplicate Activity\n\n' +
                          'This activity already exists:\n\n' +
                          `Name: ${exactDuplicate.name}\n` +
                          `Location: ${exactDuplicate.location}\n` +
                          `Time: ${formatTime(exactDuplicate.time)}\n\n` +
                          'Cannot add duplicate activity.');
                    speak('This activity already exists');
                    return;
                }
                
                const sameName = existingActivities.find(act =>
                    act.name.toLowerCase().trim() === name.toLowerCase().trim() &&
                    (act.location.toLowerCase().trim() !== location.toLowerCase().trim() || act.time !== time)
                );
                
                if (sameName) {
                    const userConfirmed = confirm(
                        `‚ö†Ô∏è Activity Name Already Exists\n\n` +
                        `An activity named "${sameName.name}" already exists:\n\n` +
                        `Existing: ${formatTime(sameName.time)} at ${sameName.location}\n` +
                        `New: ${formatTime(time)} at ${location}\n\n` +
                        `This might be:\n` +
                        `‚Ä¢ Same activity at different time or location\n` +
                        `‚Ä¢ Accidentally creating a duplicate\n\n` +
                        `Do you want to add this activity anyway?`
                    );
                    
                    if (!userConfirmed) {
                        speak('Activity not added');
                        return;
                    }
                }
                
                const activity = {
                    id: Date.now(),
                    name: name,
                    location: location,
                    description: description,
                    time: time,
                    recurrence: recurrence,
                    reminderEnabled: document.getElementById('activityReminderEnabled').checked,
                    reminderMinutes: parseInt(document.getElementById('activityReminderMinutes').value) || 30,
                    attended: []
                };

                if (recurrence === 'one-time') {
                    const date = document.getElementById('activityDate').value;
                    if (!date) {
                        alert('Please select a date for this one-time activity');
                        return;
                    }
                    activity.date = date;
                } else if (recurrence === 'weekly') {
                    activity.weeklyDay = parseInt(document.getElementById('activityWeeklyDay').value);
                } else if (recurrence === 'specific-days') {
                    const selectedDays = Array.from(document.querySelectorAll('.activity-day-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedDays.length === 0) {
                        alert('Please select at least one day of the week');
                        return;
                    }
                    activity.specificDays = selectedDays;
                } else if (recurrence === 'monthly') {
                    activity.monthlyDate = parseInt(document.getElementById('activityMonthlyDate').value);
                }

                if (!users[currentUser].activities) {
                    users[currentUser].activities = [];
                }
                users[currentUser].activities.push(activity);
                saveData('users', users);
                speak(`Added activity ${name}`);
            }

            // Clear form
            document.getElementById('activityName').value = '';
            document.getElementById('activityLocation').value = '';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityTime').value = '';
            document.getElementById('activityRecurrence').value = 'one-time';
            document.getElementById('activityDate').value = '';
            document.getElementById('activityReminderEnabled').checked = false;
            document.getElementById('activityReminderMinutes').value = '30';
            document.getElementById('activityReminderOptions').classList.add('hidden');
            document.querySelectorAll('.activity-day-checkbox').forEach(cb => cb.checked = false);
            updateActivityRecurrenceOptions();

            loadActivities(users[currentUser].activities);
            updateDashboard();
        }

        function loadActivities(activities) {
            const container = document.getElementById('activityList');
            container.innerHTML = '';

            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No activities added yet</p>';
                return;
            }

            const minimizedActivities = JSON.parse(localStorage.getItem('minimizedActivities') || '{}');

            activities.sort((a, b) => {
                if (a.time && b.time) return a.time.localeCompare(b.time);
                return 0;
            });

            activities.forEach(activity => {
                const isMinimized = minimizedActivities[activity.id] || false;
                const showToday = shouldShowActivityToday(activity);
                const todayStr = new Date().toISOString().split('T')[0];
                const attendedToday = activity.attended && activity.attended.includes(todayStr);
                
                const card = document.createElement('div');
                card.className = 'card activity fade-in';
                if (attendedToday) {
                    card.style.opacity = '0.6';
                    card.style.background = '#f7fafc';
                }
                
                const reminderBadge = activity.reminderEnabled ? ' üîî' : '';
                const toggleIcon = isMinimized ? '‚ñº' : '‚ñ≤';
                const attendedIcon = attendedToday ? '‚úì ' : '';
                
                let scheduleInfo = '';
                if (!showToday) {
                    scheduleInfo = '<div style="background: #e2e8f0; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 15px;"><strong>üìÖ Not scheduled for today</strong></div>';
                }
                
                card.innerHTML = `
                    <div class="card-header" style="cursor: pointer; user-select: none;">
                        <div style="flex: 1;" onclick="toggleActivityCard(${activity.id})">
                            ${attendedIcon}${activity.name}${reminderBadge}
                            <div style="font-size: 14px; color: #666; margin-top: 2px;">
                                ${formatTime(activity.time)} ‚Ä¢ ${activity.location}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="action-btn" onclick="toggleActivityCard(${activity.id})" 
                                    style="font-size: 18px; padding: 5px 12px; background: #e2e8f0; color: #333;"
                                    title="${isMinimized ? 'Expand' : 'Minimize'}">
                                <span id="toggle-icon-activity-${activity.id}">${toggleIcon}</span>
                            </button>
                        </div>
                    </div>
                    <div id="activity-details-${activity.id}" style="${isMinimized ? 'display: none;' : ''}">
                        <div class="card-content">
                            <strong>üìç Location:</strong> ${activity.location}<br>
                            <strong>‚è∞ Time:</strong> ${formatTime(activity.time)}<br>
                            <strong>üìÖ Schedule:</strong> ${getActivityRecurrenceText(activity)}
                            ${activity.description ? '<br><strong>üìù Description:</strong> ' + activity.description : ''}
                            ${activity.reminderEnabled ? '<br><strong>üîî Reminder:</strong> ' + activity.reminderMinutes + ' min before' : ''}
                        </div>
                        ${scheduleInfo}
                        ${showToday ? `
                            <button class="action-btn ${attendedToday ? 'btn-success' : 'btn-info'}" 
                                    onclick="toggleActivityAttended(${activity.id})">
                                ${attendedToday ? '‚úì Attended' : 'Mark as Attended'}
                            </button>
                        ` : ''}
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="action-btn btn-info" onclick="editActivity(${activity.id})" style="font-size: 14px; flex: 1;">Edit</button>
                            <button class="action-btn btn-delete" onclick="deleteActivity(${activity.id})" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleActivityCard(activityId) {
            const detailsDiv = document.getElementById(`activity-details-${activityId}`);
            const toggleIcon = document.getElementById(`toggle-icon-activity-${activityId}`);
            
            if (!detailsDiv || !toggleIcon) return;
            
            const isMinimized = detailsDiv.style.display === 'none';
            detailsDiv.style.display = isMinimized ? '' : 'none';
            toggleIcon.textContent = isMinimized ? '‚ñ≤' : '‚ñº';
            
            const minimizedActivities = JSON.parse(localStorage.getItem('minimizedActivities') || '{}');
            minimizedActivities[activityId] = !isMinimized;
            localStorage.setItem('minimizedActivities', JSON.stringify(minimizedActivities));
            
            speak(isMinimized ? 'Expanded' : 'Minimized');
        }
        window.toggleActivityCard = toggleActivityCard;

        function editActivity(activityId) {
            const users = loadData('users');
            const activity = users[currentUser].activities.find(a => a.id === activityId);
            
            if (!activity) {
                alert('Activity not found');
                return;
            }

            editingActivityId = activityId;
            
            document.getElementById('activityName').value = activity.name;
            document.getElementById('activityLocation').value = activity.location;
            document.getElementById('activityDescription').value = activity.description || '';
            document.getElementById('activityTime').value = activity.time;
            document.getElementById('activityRecurrence').value = activity.recurrence || 'one-time';
            
            if (activity.recurrence === 'one-time') {
                document.getElementById('activityDate').value = activity.date || '';
            } else if (activity.recurrence === 'weekly') {
                document.getElementById('activityWeeklyDay').value = activity.weeklyDay || '1';
            } else if (activity.recurrence === 'specific-days' && activity.specificDays) {
                document.querySelectorAll('.activity-day-checkbox').forEach(cb => {
                    cb.checked = activity.specificDays.includes(parseInt(cb.value));
                });
            } else if (activity.recurrence === 'monthly') {
                document.getElementById('activityMonthlyDate').value = activity.monthlyDate || 1;
            }
            
            document.getElementById('activityReminderEnabled').checked = activity.reminderEnabled || false;
            document.getElementById('activityReminderMinutes').value = activity.reminderMinutes || 30;
            
            if (activity.reminderEnabled) {
                document.getElementById('activityReminderOptions').classList.remove('hidden');
            }
            
            updateActivityRecurrenceOptions();
            
            document.getElementById('addActivityBtn').textContent = 'Update Activity';
            document.getElementById('cancelEditActivityBtn').classList.remove('hidden');
            
            showSection('activities');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            speak('Editing activity');
        }

        function cancelEditActivity() {
            editingActivityId = null;
            document.getElementById('activityName').value = '';
            document.getElementById('activityLocation').value = '';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityTime').value = '';
            document.getElementById('activityRecurrence').value = 'one-time';
            document.getElementById('activityDate').value = '';
            document.getElementById('activityReminderEnabled').checked = false;
            document.getElementById('activityReminderMinutes').value = '30';
            document.getElementById('activityReminderOptions').classList.add('hidden');
            document.querySelectorAll('.activity-day-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('addActivityBtn').textContent = 'Add Activity';
            document.getElementById('cancelEditActivityBtn').classList.add('hidden');
            updateActivityRecurrenceOptions();
            speak('Cancelled editing');
        }

        function deleteActivity(activityId) {
            if (!confirm('Are you sure you want to delete this activity?')) return;
            
            const users = loadData('users');
            const activity = users[currentUser].activities.find(a => a.id === activityId);
            const activityName = activity ? activity.name : 'activity';
            
            users[currentUser].activities = users[currentUser].activities.filter(a => a.id !== activityId);
            saveData('users', users);
            loadActivities(users[currentUser].activities);
            updateDashboard();
            speak('Activity deleted: ' + activityName);
        }

        function toggleActivityAttended(activityId) {
            const users = loadData('users');
            const activity = users[currentUser].activities.find(a => a.id === activityId);
            if (!activity) return;
            
            const todayStr = new Date().toISOString().split('T')[0];
            if (!activity.attended) activity.attended = [];
            
            if (activity.attended.includes(todayStr)) {
                activity.attended = activity.attended.filter(d => d !== todayStr);
                speak('Marked as not attended');
            } else {
                activity.attended.push(todayStr);
                speak('Marked as attended');
            }
            
            saveData('users', users);
            loadActivities(users[currentUser].activities);
            updateDashboard();
        }

        // Profile
        function loadProfile(userData) {
            const container = document.getElementById('profileInfo');
            if (!container) return;
            container.innerHTML = `
                <p style="margin-bottom: 10px;"><strong>Name:</strong> ${userData.name}</p>
                <p style="margin-bottom: 10px;"><strong>Age:</strong> ${userData.age}</p>
                <p style="margin-bottom: 10px;"><strong>Email:</strong> ${userData.email || 'Not set'}</p>
                <p><strong>Username:</strong> ${currentUser}</p>
            `;

            document.getElementById('updateName').value = userData.name;
            document.getElementById('updateAge').value = userData.age;
            document.getElementById('updateEmail').value = userData.email || '';
            
            // Load voice preference checkbox state
            loadVoicePreference();
            
            // Load backup reminder settings
            loadBackupReminderSettings();
        }

        function updateProfile() {
            const name = document.getElementById('updateName').value;
            const age = document.getElementById('updateAge').value;
            const email = document.getElementById('updateEmail').value;

            if (!name || !age || !email) {
                alert('Please fill in all fields');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            const users = loadData('users');
            users[currentUser].name = name;
            users[currentUser].age = age;
            users[currentUser].email = email;
            saveData('users', users);

            document.getElementById('userName').textContent = name;
            loadProfile(users[currentUser]);
            speak('Profile updated successfully');
        }

        // Export/Import Functions
        async function exportData() {
            const users = loadData('users');
            if (!users || !users[currentUser]) {
                alert('No data to export');
                return;
            }

            const userData = users[currentUser];
            
            // Create export object with all user data
            const exportDataObj = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                username: currentUser,
                profile: {
                    name: userData.name,
                    age: userData.age,
                    email: userData.email,
                    voiceAutoEnable: userData.voiceAutoEnable || false
                },
                medications: userData.medications || [],
                appointments: userData.appointments || [],
                tasks: userData.tasks || {
                    meals: [],
                    hydration: [],
                    hygiene: [],
                    safety: []
                },
                bills: userData.bills || []
            };

            // Convert to JSON string
            const jsonString = JSON.stringify(exportDataObj, null, 2);
            
            // Create blob and file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const date = new Date().toISOString().split('T')[0];
            const filename = `senior-care-backup-${date}.json`;
            const file = new File([blob], filename, { type: 'application/json' });
            
            // Save last backup date
            users[currentUser].lastBackupDate = new Date().toISOString();
            saveData('users', users);
            updateLastBackupDisplay();
            
            // Try Web Share API (Mobile - iPhone/Android)
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        title: 'Senior Care Backup',
                        text: `Backup from ${date}\n\nContains:\n- Medications: ${exportDataObj.medications.length}\n- Appointments: ${exportDataObj.appointments.length}\n- Tasks: ${
                            (exportDataObj.tasks?.meals?.length || 0) +
                            (exportDataObj.tasks?.hydration?.length || 0) +
                            (exportDataObj.tasks?.hygiene?.length || 0) +
                            (exportDataObj.tasks?.safety?.length || 0)
                        }\n- Bills: ${exportDataObj.bills.length}`,
                        files: [file]
                    });
                    speak('Backup shared successfully');
                    return; // Success! Exit here
                } catch (error) {
                    if (error.name === 'AbortError') {
                        speak('Share cancelled');
                        return; // User cancelled, exit gracefully
                    }
                    // If share failed for other reason, fall through to download method
                    console.log('Share not available, using download method:', error);
                }
            }
            
            // Fallback: Download file (Desktop)
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            
            speak('Data exported successfully');
            
            // Show simple confirmation with helpful instructions
            setTimeout(() => {
                alert('‚úÖ Backup downloaded successfully!\n\n' +
                      'üìÑ File: ' + filename + '\n\n' +
                      'üìÅ Location: Downloads folder\n\n' +
                      'üí° To save your backup:\n' +
                      '‚Ä¢ Email it to yourself\n' +
                      '‚Ä¢ Upload to Google Drive/iCloud\n' +
                      '‚Ä¢ Save to USB drive\n\n' +
                      'Backup contains:\n' +
                      '‚Ä¢ Medications: ' + exportDataObj.medications.length + '\n' +
                      '‚Ä¢ Appointments: ' + exportDataObj.appointments.length + '\n' +
                      '‚Ä¢ Tasks: ' + (
                          (exportDataObj.tasks?.meals?.length || 0) +
                          (exportDataObj.tasks?.hydration?.length || 0) +
                          (exportDataObj.tasks?.hygiene?.length || 0) +
                          (exportDataObj.tasks?.safety?.length || 0)
                      ) + '\n' +
                      '‚Ä¢ Bills: ' + exportDataObj.bills.length);
            }, 500);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if it's a JSON file
            if (!file.name.endsWith('.json')) {
                alert('‚ùå Please select a valid JSON backup file');
                speak('Invalid file type');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the imported data
                    if (!importedData.version || !importedData.profile) {
                        throw new Error('Invalid backup file format');
                    }

                    // Ask for confirmation
                    const confirmMessage = `Import data from backup?\n\nBackup Date: ${new Date(importedData.exportDate).toLocaleDateString()}\n\nThis will REPLACE your current data!\n\nAre you sure?`;
                    
                    if (!confirm(confirmMessage)) {
                        speak('Import cancelled');
                        return;
                    }

                    // Load current users data
                    const users = loadData('users');
                    
                    // Merge imported data into current user
                    users[currentUser] = {
                        ...users[currentUser],
                        name: importedData.profile.name,
                        age: importedData.profile.age,
                        voiceAutoEnable: importedData.profile.voiceAutoEnable,
                        medications: importedData.medications,
                        appointments: importedData.appointments,
                        tasks: importedData.tasks,
                        bills: importedData.bills
                    };

                    // Save to localStorage
                    saveData('users', users);

                    // Reload all data
                    loadAllData();

                    speak('Data imported successfully');
                    
                    // Show success message
                    alert('‚úÖ Data imported successfully!\n\n' +
                          'Medications: ' + (importedData.medications?.length || 0) + '\n' +
                          'Appointments: ' + (importedData.appointments?.length || 0) + '\n' +
                          'Tasks: ' + (
                              (importedData.tasks?.meals?.length || 0) +
                              (importedData.tasks?.hydration?.length || 0) +
                              (importedData.tasks?.hygiene?.length || 0) +
                              (importedData.tasks?.safety?.length || 0)
                          ) + '\n' +
                          'Bills: ' + (importedData.bills?.length || 0));

                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Error importing data\n\nThe file may be corrupted or invalid.\n\nError: ' + error.message);
                    speak('Error importing data');
                }
            };

            reader.onerror = function() {
                alert('‚ùå Error reading file');
                speak('Error reading file');
            };

            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Backup Reminder Functions
        function saveBackupReminderSettings() {
            const enabled = document.getElementById('backupReminderEnabled').checked;
            const days = document.getElementById('backupReminderDays').value;
            
            const users = loadData('users');
            users[currentUser].backupReminderEnabled = enabled;
            users[currentUser].backupReminderDays = parseInt(days);
            saveData('users', users);
            
            // Toggle visibility of options
            const options = document.getElementById('backupReminderOptions');
            if (enabled) {
                options.classList.remove('hidden');
                speak(`Backup reminder set for every ${days} days`);
            } else {
                options.classList.add('hidden');
                speak('Backup reminder disabled');
            }
        }

        function updateLastBackupDisplay() {
            const users = loadData('users');
            const lastBackup = users[currentUser]?.lastBackupDate;
            const displayElement = document.getElementById('lastBackupDate');
            
            if (lastBackup) {
                const backupDate = new Date(lastBackup);
                const now = new Date();
                const daysDiff = Math.floor((now - backupDate) / (1000 * 60 * 60 * 24));
                
                const dateStr = backupDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                if (daysDiff === 0) {
                    displayElement.textContent = 'Today (' + dateStr + ')';
                    displayElement.style.color = '#28a745';
                } else if (daysDiff === 1) {
                    displayElement.textContent = 'Yesterday (' + dateStr + ')';
                    displayElement.style.color = '#28a745';
                } else if (daysDiff <= 7) {
                    displayElement.textContent = daysDiff + ' days ago (' + dateStr + ')';
                    displayElement.style.color = '#28a745';
                } else if (daysDiff <= 14) {
                    displayElement.textContent = daysDiff + ' days ago (' + dateStr + ')';
                    displayElement.style.color = '#ffc107';
                } else {
                    displayElement.textContent = daysDiff + ' days ago (' + dateStr + ')';
                    displayElement.style.color = '#dc3545';
                }
            } else {
                displayElement.textContent = 'Never';
                displayElement.style.color = '#dc3545';
            }
        }

        function checkBackupReminder() {
            const users = loadData('users');
            const userData = users[currentUser];
            
            if (!userData.backupReminderEnabled) return;
            
            const lastBackup = userData.lastBackupDate;
            const reminderDays = userData.backupReminderDays || 7;
            
            if (!lastBackup) {
                // Never backed up - show reminder
                showBackupReminder('You have never backed up your data!', reminderDays);
                return;
            }
            
            const lastBackupDate = new Date(lastBackup);
            const now = new Date();
            const daysSinceBackup = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
            
            if (daysSinceBackup >= reminderDays) {
                showBackupReminder(`It's been ${daysSinceBackup} days since your last backup!`, reminderDays);
            }
        }

        function showBackupReminder(message, reminderDays) {
            const alertHtml = `
                <div class="reminder-alert">
                    <div class="reminder-content">
                        <div style="font-size: 60px; margin-bottom: 20px;">üíæ</div>
                        <h2 style="margin: 0 0 15px 0;">Backup Reminder</h2>
                        <p style="font-size: 16px; margin-bottom: 15px;">${message}</p>
                        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                            Regular backups protect your data if your phone is lost or damaged.<br>
                            You're set to be reminded every ${reminderDays} days.
                        </p>
                        <button class="btn btn-success" style="margin: 5px; padding: 15px 30px; font-size: 16px;" onclick="closeBackupReminder(); exportData();">
                            üì• Backup Now
                        </button>
                        <button class="btn" style="margin: 5px; padding: 15px 30px; font-size: 16px; background: #6c757d;" onclick="snoozeBackupReminder();">
                            ‚è∞ Remind Me Tomorrow
                        </button>
                        <button class="btn" style="margin: 5px; padding: 15px 30px; font-size: 16px; background: #95a5a6;" onclick="closeBackupReminder();">
                            Dismiss
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            speak('Backup reminder: ' + message);
        }

        function closeBackupReminder() {
            const alert = document.querySelector('.reminder-alert');
            if (alert) alert.remove();
        }

        function snoozeBackupReminder() {
            const users = loadData('users');
            users[currentUser].backupReminderSnoozeUntil = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
            saveData('users', users);
            closeBackupReminder();
            speak('Backup reminder snoozed until tomorrow');
        }

        function loadBackupReminderSettings() {
            const users = loadData('users');
            const userData = users[currentUser];
            
            const enabled = userData.backupReminderEnabled || false;
            const days = userData.backupReminderDays || 7;
            
            document.getElementById('backupReminderEnabled').checked = enabled;
            document.getElementById('backupReminderDays').value = days;
            
            const options = document.getElementById('backupReminderOptions');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
            
            updateLastBackupDisplay();
        }

        // Dashboard
        function updateDashboard() {
            const users = loadData('users');
            if (!users || !users[currentUser]) return;

            const userData = users[currentUser];

            // Count medications scheduled for today with breakdown
            const medsScheduledToday = (userData.medications || []).filter(med => shouldTakeMedicationToday(med));
            const medsTakenToday = medsScheduledToday.filter(med => wasTakenToday(med)).length;
            const medsLeftToday = medsScheduledToday.length - medsTakenToday;
            
            const medCountText = `${medsScheduledToday.length} for today<br>` +
                                `‚úì ${medsTakenToday} taken<br>` +
                                `‚Ä¢ ${medsLeftToday} left`;
            
            document.getElementById('medCount').innerHTML = medCountText;
            
            // Count appointments with breakdown
            const allAppointments = userData.appointments || [];
            const upcomingAppts = allAppointments.filter(a => !a.completed).length;
            const completedAppts = allAppointments.filter(a => a.completed).length;
            
            const apptCountText = `${allAppointments.length} total<br>` +
                                 `‚Ä¢ ${upcomingAppts} upcoming<br>` +
                                 `‚úì ${completedAppts} completed`;
            
            document.getElementById('apptCount').innerHTML = apptCountText;
            
            // Count tasks scheduled for today with breakdown
            let tasksScheduledToday = [];
            ['meals', 'hydration', 'hygiene', 'safety'].forEach(category => {
                if (userData.tasks && userData.tasks[category]) {
                    const categoryTasks = userData.tasks[category].filter(task => shouldShowTaskToday(task));
                    tasksScheduledToday = tasksScheduledToday.concat(categoryTasks);
                }
            });
            
            const totalTasksToday = tasksScheduledToday.length;
            const completedTasksToday = tasksScheduledToday.filter(task => task.completed).length;
            const leftTasksToday = totalTasksToday - completedTasksToday;
            
            const taskCountText = `${totalTasksToday} for today<br>` +
                                 `‚úì ${completedTasksToday} done<br>` +
                                 `‚Ä¢ ${leftTasksToday} left`;
            
            document.getElementById('taskCount').innerHTML = taskCountText;
            
            // Count bills with breakdown
            const allBills = userData.bills || [];
            const unpaidBills = allBills.filter(b => !b.paid).length;
            const paidBills = allBills.filter(b => b.paid).length;
            
            const billCountText = `${allBills.length} total<br>` +
                                 `‚Ä¢ ${unpaidBills} unpaid<br>` +
                                 `‚úì ${paidBills} paid`;
            
            document.getElementById('billCount').innerHTML = billCountText;
            
            // Count activities
            const allActivities = userData.activities || [];
            const todayStr = new Date().toISOString().split('T')[0];
            const activitiesScheduledToday = allActivities.filter(activity => shouldShowActivityToday(activity));
            const activitiesAttendedToday = activitiesScheduledToday.filter(activity => 
                activity.attended && activity.attended.includes(todayStr)
            ).length;
            const activitiesLeftToday = activitiesScheduledToday.length - activitiesAttendedToday;
            
            const activityCountText = `${activitiesScheduledToday.length} for today<br>` +
                                     `‚úì ${activitiesAttendedToday} attended<br>` +
                                     `‚Ä¢ ${activitiesLeftToday} upcoming`;
            
            document.getElementById('activityCount').innerHTML = activityCountText;
        }


        // Utility functions
        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function formatDate(dateString) {
            // Parse the date string directly to avoid timezone issues
            // Split YYYY-MM-DD and create date in local timezone
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day); // month is 0-indexed in JavaScript
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Helper function to parse date strings (YYYY-MM-DD) in local timezone
        function parseLocalDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // Check for updates every minute
        setInterval(() => {
            if (currentUser) {
                loadHomeReminders();
            }
        }, 60000);

        // ========================================
        // HELP SYSTEM
        // ========================================

        // Help topic navigation
        function showHelpTopic(topicId) {
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üìñ SHOW HELP TOPIC - Starting...');
            console.log('üéØ Topic ID requested:', topicId);
            
            // Hide all topic sections
            const allSections = document.querySelectorAll('.help-topic-section');
            console.log('üì¶ Found help sections:', allSections.length);
            
            allSections.forEach((section, index) => {
                console.log(`  - Hiding section ${index + 1}: ${section.id}`);
                section.classList.add('hidden');
            });
            
            // Show selected topic
            const targetId = `help-${topicId}`;
            console.log('üîç Looking for element with ID:', targetId);
            
            const topic = document.getElementById(targetId);
            
            if (topic) {
                console.log('‚úÖ Topic element found!');
                console.log('   - Element ID:', topic.id);
                console.log('   - Element classes:', topic.className);
                console.log('   - Is hidden before:', topic.classList.contains('hidden'));
                
                topic.classList.remove('hidden');
                
                console.log('   - Is hidden after:', topic.classList.contains('hidden'));
                console.log('üëÅÔ∏è Topic made visible');
                console.log('üìç Scrolling to topic content');
                
                // Scroll to the topic content, not the top of the page
                setTimeout(() => {
                    topic.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                console.log('‚úÖ Successfully showed topic:', topicId);
            } else {
                console.error('‚ùå ERROR: Topic element NOT found!');
                console.error('   - Searched for ID:', targetId);
                console.error('   - Available help sections:');
                
                document.querySelectorAll('.help-topic-section').forEach(section => {
                    console.error(`     - ${section.id}`);
                });
                
                console.error('‚ö†Ô∏è This topic does not exist in the HTML!');
            }
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        }

        // Help search functionality
        const helpContent = {
            'medication': ['medications', 'How to add, edit, and manage medications'],
            'add medication': ['medications', 'How to add a new medication to your list'],
            'reminder': ['medications', 'How to set reminders for medications and appointments'],
            'appointment': ['appointments', 'How to manage doctor appointments'],
            'task': ['tasks', 'How to use daily tasks and to-do lists'],
            'bill': ['bills', 'How to track bills and payments'],
            'activity': ['activities', 'How to add yoga, bingo, and other activities'],
            'contact': ['contacts', 'How to save important phone numbers'],
            'voice': ['voice', 'How to use voice commands and voice assistant'],
            'password': ['common-questions', 'Forgot password or change password'],
            'forgot password': ['common-questions', 'How to reset your password'],
            'backup': ['common-questions', 'How to backup and restore your data'],
            'notification': ['common-questions', 'How to enable notifications and reminders'],
            'slow': ['troubleshooting', 'App running slow - troubleshooting'],
            'not working': ['troubleshooting', 'Common problems and solutions'],
            'minimize': ['getting-started', 'How to use minimize/maximize buttons'],
            'expand': ['getting-started', 'How to expand and collapse cards'],
            'delete': ['common-questions', 'How to delete items'],
            'edit': ['medications', 'How to edit existing items'],
            'help': ['getting-started', 'Getting started with the app']
        };

        // Debug: Log all available help content on load
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('üìö HELP SYSTEM INITIALIZED');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log(`üìä Total keywords available: ${Object.keys(helpContent).length}`);
        console.log('');
        console.log('üìã Available keywords and their topics:');
        
        const topicGroups = {};
        for (const [keyword, [topic, description]] of Object.entries(helpContent)) {
            if (!topicGroups[topic]) {
                topicGroups[topic] = [];
            }
            topicGroups[topic].push(keyword);
        }
        
        for (const [topic, keywords] of Object.entries(topicGroups)) {
            console.log(`\n  üìñ ${topic}:`);
            keywords.forEach(keyword => {
                console.log(`     - "${keyword}"`);
            });
        }
        
        console.log('');
        console.log('üí° TIP: Search for any of these keywords to find help!');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

        // Handle Enter key in search box
        function handleHelpSearchKeydown(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                console.log('üîç Enter key pressed in search - preventing default scroll');
                event.preventDefault(); // Prevent form submission/page scroll
                
                // Just trigger search (already done by onkeyup)
                // Results will appear and scroll to them
                const resultsContainer = document.getElementById('searchResults');
                if (resultsContainer && !resultsContainer.classList.contains('hidden')) {
                    console.log('üìç Scrolling to search results');
                    setTimeout(() => {
                        resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            }
        }

        function searchHelp() {
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üîç HELP SEARCH - Starting search...');
            
            const searchTerm = document.getElementById('helpSearch').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResults');
            
            console.log('üìù Search term (raw):', document.getElementById('helpSearch').value);
            console.log('üìù Search term (processed):', searchTerm);
            console.log('üì¶ Results container:', resultsContainer ? 'Found' : 'NOT FOUND!');
            
            // Always clear previous results first
            resultsContainer.innerHTML = '';
            console.log('üßπ Cleared previous results');
            
            if (!searchTerm) {
                console.log('‚ö†Ô∏è Empty search term - hiding results');
                resultsContainer.classList.add('hidden');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                return;
            }

            console.log('üîé Searching through help content...');
            console.log('üìö Total keywords available:', Object.keys(helpContent).length);
            
            const results = [];
            let matchCount = 0;
            
            for (const [keyword, [topic, description]] of Object.entries(helpContent)) {
                const keywordMatch = keyword.includes(searchTerm);
                const searchMatch = searchTerm.includes(keyword);
                
                if (keywordMatch || searchMatch) {
                    matchCount++;
                    console.log(`  ‚úÖ Match #${matchCount}: "${keyword}" ‚Üí ${topic}`);
                    console.log(`     - Keyword includes search: ${keywordMatch}`);
                    console.log(`     - Search includes keyword: ${searchMatch}`);
                    
                    if (!results.find(r => r.topic === topic)) {
                        results.push({ topic, description });
                        console.log(`     - Added to results (unique topic)`);
                    } else {
                        console.log(`     - Skipped (topic already in results)`);
                    }
                }
            }

            console.log(`üìä Search complete: ${matchCount} keyword matches ‚Üí ${results.length} unique topics`);
            console.log('üìã Results:', results.map(r => r.topic).join(', ') || 'none');

            if (results.length === 0) {
                console.log('‚ùå No results found - showing "no results" message');
                resultsContainer.innerHTML = `
                    <div class="card" style="background: #fff3cd; border: 2px solid #ffc107;">
                        <div class="card-content">
                            <strong>No results found for "${searchTerm}"</strong><br>
                            Try different keywords like "medication", "reminder", "password", etc.
                        </div>
                    </div>
                `;
            } else {
                console.log(`‚úÖ Rendering ${results.length} results`);
                resultsContainer.innerHTML = `
                    <div class="card" style="background: #d4edda; border: 2px solid #28a745;">
                        <div class="card-header" style="background: #28a745; color: white;">
                            üîç Search Results for "${searchTerm}"
                        </div>
                        <div class="card-content">
                            ${results.map((r, index) => {
                                console.log(`  - Result ${index + 1}: ${r.description} (${r.topic})`);
                                return `
                                    <div onclick="showHelpTopic('${r.topic}')" 
                                         style="padding: 12px; margin: 5px 0; background: white; border-radius: 8px; cursor: pointer; border-left: 4px solid #28a745;">
                                        <strong>${r.description}</strong>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Show results container
            resultsContainer.classList.remove('hidden');
            console.log('üëÅÔ∏è Results container made visible');
            
            // Scroll to results after a brief delay (so they're rendered)
            setTimeout(() => {
                console.log('üìç Scrolling to search results');
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        }

        // ========================================
        // VOICE ASSISTANT SYSTEM
        // ========================================

        let voiceAssistantEnabled = false;
        let recognition = null;
        let isListening = false;

        // Initialize voice recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('voiceListeningOverlay').classList.remove('hidden');
                    document.getElementById('floatingVoiceBtn').classList.add('listening');
                    document.getElementById('voiceStatusText').textContent = 'Listening...';
                    document.getElementById('voiceStatusIcon').textContent = 'üî¥';
                    document.getElementById('voiceTranscript').textContent = 'Speak now...';
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('voiceTranscript').textContent = `You said: "${transcript}"`;
                    document.getElementById('voiceStatusText').textContent = 'Processing...';
                    document.getElementById('voiceStatusIcon').textContent = '‚è≥';
                    
                    // Process the command
                    setTimeout(() => {
                        processVoiceCommand(transcript);
                    }, 100);
                };

                recognition.onerror = function(event) {
                    console.error('Voice recognition error:', event.error);
                    document.getElementById('voiceStatusText').textContent = 'Error: ' + event.error;
                    document.getElementById('voiceStatusIcon').textContent = '‚ùå';
                    setTimeout(() => {
                        stopVoiceListening();
                    }, 2000);
                };

                recognition.onend = function() {
                    isListening = false;
                };
            } else {
                alert('Sorry, voice recognition is not supported in your browser. Please use Chrome, Safari, or Edge.');
            }
        }

        // Toggle voice assistant
        function toggleVoiceAssistant() {
            voiceAssistantEnabled = !voiceAssistantEnabled;
            const btn = document.getElementById('voiceAssistantToggleBtn');
            const info = document.getElementById('voiceAssistantInfo');
            const floatingBtn = document.getElementById('floatingVoiceBtn');
            
            if (voiceAssistantEnabled) {
                btn.textContent = 'üé§ Voice Assistant ON';
                btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                info.classList.remove('hidden');
                floatingBtn.classList.remove('hidden');
                
                // Initialize recognition if not already done
                if (!recognition) {
                    initVoiceRecognition();
                }
                
                speak('Voice assistant enabled. Click the microphone button to give voice commands.');
                
                // Save preference
                localStorage.setItem('voiceAssistantEnabled', 'true');
            } else {
                btn.textContent = 'üé§ Voice Assistant OFF';
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                info.classList.add('hidden');
                floatingBtn.classList.add('hidden');
                
                speak('Voice assistant disabled');
                localStorage.setItem('voiceAssistantEnabled', 'false');
            }
        }

        // Start voice listening
        function startVoiceListening() {
            if (!voiceAssistantEnabled) {
                alert('Please enable Voice Assistant in Profile settings first.');
                return;
            }
            
            if (!recognition) {
                initVoiceRecognition();
            }
            
            if (recognition && !isListening) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                }
            }
        }

        // Stop voice listening
        function stopVoiceListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
            document.getElementById('voiceListeningOverlay').classList.add('hidden');
            document.getElementById('floatingVoiceBtn').classList.remove('listening');
            isListening = false;
        }

        // Process voice commands - SIMPLE VERSION (Navigation, Help, Reading ONLY)
        function processVoiceCommand(command) {
            const lowerCommand = command.toLowerCase();
            console.log('üé§ Processing voice command:', command);
            let handled = false;

            // Navigation commands
            if (lowerCommand.includes('go to') || lowerCommand.includes('show') || lowerCommand.includes('open')) {
                if (lowerCommand.includes('medication') || lowerCommand.includes('med')) {
                    showSection('medications');
                    speak('Opening Medications');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('appointment') || lowerCommand.includes('appt')) {
                    showSection('appointments');
                    speak('Opening Appointments');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('task')) {
                    showSection('tasks');
                    speak('Opening Tasks');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('bill')) {
                    showSection('bills');
                    speak('Opening Bills');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('activit')) {
                    showSection('activities');
                    speak('Opening Activities');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('contact')) {
                    showSection('contacts');
                    speak('Opening Contacts');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('home')) {
                    showSection('home');
                    speak('Going home');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('profile')) {
                    showSection('profile');
                    speak('Opening Profile');
                    stopVoiceListening();
                    handled = true;
                } else if (lowerCommand.includes('help')) {
                    showSection('help');
                    speak('Opening Help Center');
                    stopVoiceListening();
                    handled = true;
                }
            }

            // Help commands
            if (!handled && (lowerCommand.includes('help') || lowerCommand.includes('how do i') || lowerCommand.includes('how to'))) {
                showSection('help');
                
                if (lowerCommand.includes('medication') || lowerCommand.includes('med')) {
                    showHelpTopic('medications');
                    speak('Here is help for medications');
                    handled = true;
                } else if (lowerCommand.includes('appointment')) {
                    showHelpTopic('appointments');
                    speak('Here is help for appointments');
                    handled = true;
                } else if (lowerCommand.includes('reminder')) {
                    showHelpTopic('medications');
                    speak('Here is help for reminders');
                    handled = true;
                } else if (lowerCommand.includes('password')) {
                    showHelpTopic('common-questions');
                    speak('Here is help for passwords');
                    handled = true;
                } else if (lowerCommand.includes('voice')) {
                    showHelpTopic('voice');
                    speak('Here is help for voice commands');
                    handled = true;
                } else {
                    showHelpTopic('getting-started');
                    speak('Here is the getting started guide');
                    handled = true;
                }
                
                stopVoiceListening();
            }

            // Reading commands
            if (!handled && (lowerCommand.includes('read this') || lowerCommand.includes('read the page'))) {
                readCurrentPage();
                handled = true;
            }

            // If command not handled
            if (!handled) {
                speak(`I didn't understand "${command}". Try saying "go to medications", "help with reminders", or "show my appointments"`);
                stopVoiceListening();
            }
        }

        // Read current page content
        function readCurrentPage() {
            const activeSection = document.querySelector('.section.active');
            if (!activeSection) {
                stopVoiceListening();
                return;
            }
            
            const title = activeSection.querySelector('.section-title');
            if (title) {
                speak(title.textContent);
            }
            
            // Close overlay after reading
            stopVoiceListening();
        }

        // Load voice assistant preference on login
        function loadVoiceAssistantPreference() {
            const savedPreference = localStorage.getItem('voiceAssistantEnabled');
            if (savedPreference === 'true') {
                voiceAssistantEnabled = true;
                const btn = document.getElementById('voiceAssistantToggleBtn');
                const info = document.getElementById('voiceAssistantInfo');
                const floatingBtn = document.getElementById('floatingVoiceBtn');
                
                btn.textContent = 'üé§ Voice Assistant ON';
                btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                info.classList.remove('hidden');
                floatingBtn.classList.remove('hidden');
                
                initVoiceRecognition();
            }
        }

        // Call on login
        const originalLogin = login;
        login = function() {
            const result = originalLogin.apply(this, arguments);
            setTimeout(() => {
                if (currentUser) {
                    loadVoiceAssistantPreference();
                }
            }, 100);
            return result;
        };
    </script>
</body>
</html>
